---
title: "PWS_pink_match_analysis_all"
subtitle: "Re-do with `develop` branch GCL-R-Scripts"
author: "Kyle Shedd & Kristen Gruenthal"
date: "Started: 2022-11-10, last opened: `r Sys.Date()`"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
rm(list=ls())

if(!require("pacman")) install.packages("pacman"); library(pacman)

pacman::p_load(
  tidyverse,
  lubridate
)

source("~/../R/Functions.GCL.R")
# source("../../GOD/LOKI2R_ind.GCL.R")
# source("../../GOD/DupCheckBetweenSillys_GOD.GCL.r")

.username = readLines("~/../R/usr_pw.txt", n = 1)
.password = readLines("~/../R/usr_pw.txt" , n = 2)[[2]]

knitr::opts_chunk$set(echo = TRUE)
```

# Objective

The purpose of this notebook is to determine whether we can successfully re-pair GTseq genotypes from otolith-derived DNA with GT-seq genotypes from heart-derived DNA for individuals of unknown origin.

# Background

During shipment of otolith samples in February 2020 to the MTA in Juneau for reading, a significant proportion of otoliths migrated between cells within DWPs due to poor containment of the acetate lids that were attached with rubber bands to the DWPs. This incident is known as "the great otolith debacle", aka the "GOD" incident. Since some otoliths moved from their original cells in the DWP, the paired integrity of the otolith-origin information and the rest of the paired data (genotype + field data) was lost for many individuals. In an attempt to rectify the "GOD" incident, we are extracting DNA from the otolith tissues, genotyping the otolith-derived DNA at 298 GT-seq loci, and attempting to re-pair the otolith-heart samples from their genotypes.  

# Methods

DNA was extracted from left-side or unknown otolith tissues of unknown origin using conventional Machery-Nagel DNA extraction kits. Otoliths were placed in T1 buffer for an overnight soak in clear 96 shallow-well plates (SWP). Preamp at 14 cycles. Final elution volume was 75uL. All otoliths were transferred among plates with a jig. All liquid handling was done by robot.

# Import Data

## Genotypes

### LocusControl

Using our standard 298 SNP pink salmon GT-seq loci.
```{r}
loci <- dget("~/../Desktop/Local_PWS_pinks/loci298.txt") # saved list of loci

CreateLocusControl.GCL(locusnames = loci, username = .username, password = .password)

save_objects(objects = "LocusControl", path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/")
```

### Genotypes

Read in `PGOD21` and heart genotypes for all affected DWPs.
```{r}
LOKI2R.GCL(
  sillyvec = c(
    "PGOD21",
    paste0("PERB", 15:17),
    paste0("PGILMOUR", 15:18),
    "PPADDY16"
  ),
  username = .username,
  password = .password,
  test_type = "GTSNP"
)
```

Save for ease of access
```{r}
save_sillys(
  sillyvec = c(
    "PGOD21",
    paste0("PERB", 15:17),
    paste0("PGILMOUR", 15:18),
    "PPADDY16"
  ),
  path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw"
)
```

Read back in, if necessary
```{r}
load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw", sillyvec = "PGOD21")
```

## Tissue Table

Read in the tissue table for `PGOD21` (*note* we may not need this since we are on the `develop` branch)
```{r}
(
  tissue_table_PGOD21 <- GEN_SAMPLED_FISH_TISSUE.GCL(
    sillyvec = "PGOD21",
    username = .username,
    password = .password,
    file = "~/../Desktop/Local_PWS_pinks/OceanAK/GEN_SAMPLED_FISH_TISSUE_PGOD21_20221111.csv"
  )
)
```

## Otolith Transfer from MTAL

Read in the otolith transfer data from our trip down to the MTAL in April 2021. This contains the original 48 DWP information and the 96 SWP otolith transfer locations, but no SILLY or collection information.
```{r}
(oto_xfer_data <- readr::read_csv("otolith_transfer_111721.csv"))
```

## AHRP Salmon Biological Fact

Read in all of the heart metadata.
```{r}
(
  AHRP_oceanAK <-
    readr::read_csv(file = "~/../Desktop/Local_PWS_pinks/OceanAK/AHRP Salmon Biological Data 20220511_174609.csv")
)
```

# Transform Data

We need to join the transfer data with `PGOD21` so we have the `PGOD21` otolith genotypes paired with the 48DWP barcode and original silly.

## Subset 48DWP & Silly

Make a simple tibble of the 48DWP barcode and silly from `AHRP_oceanAK`
```{r}
(
  AHRP_DWP_data <- AHRP_oceanAK %>%
    dplyr::mutate(
      "48_DWP_tray_barcode" = as.numeric(DNA_TRAY_CODE),
      sample_date = lubridate::as_date(SAMPLE_DATE)
    ) %>%
    dplyr::rename(
      silly = SILLY_CODE,
      sample_year = SAMPLE_YEAR,
      stream = LOCATION_CODE
    ) %>%
    dplyr::distinct(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date) %>%
    dplyr::select(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date)
)
```

## Make Data Key

Make a data key with `96_oto_tray_barcode` and `96_oto_tray_position` for both the `oto_xfer_data` and `PGOD21`.

Also, remove NTC wells from `oto_xfer_data`
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%
    tidyr::unite(
      col = "oto_tray_and_well",
      c(`96_oto_tray_barcode`, `96_oto_tray_position`),
      sep = "_",
      remove = FALSE
    )
)

PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

# Join Transfer & 48DWP Data With `PGOD21`

By joining the transfer data we get the original 48DWP, which we can then join to the AHRP OceanAK metadata to get the 48DWP-level sampling data (silly, stream, year, sample date).
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *384 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number)
```

Whoa, there are 3,052 otoliths that do not match up to a 48DWP...does that mean that they were box/vial otoliths? Or did our joining miss some fish?

### Investigate Fish in Otolith Transfer but NOT in `PGOD21`

These are individual otoliths recorded in the transfer sheet that do NOT appear in `PGOD21`.
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well")
```

There are 1,711 otoliths that dropped out. Perhaps that had 0 genotyping success? What's the deal?

How many fish per 96 SWP otolith tray?
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

44 different 96 SWP otolith trays that have *no* data in `PGOD21`, and most of these appear to be *missing* data for exactly 47 otoliths?!?! WTF?

Let's look in to 96 SWP otolith tray 50902 (missing 47 samples).
```{r}
PGOD21.gcl %>% 
  dplyr::filter(`96_oto_tray_barcode` == 50902)
```

Wait, WTF, the `DNA_TRAY_WELL_POS` appears to be correct, but the `DNA_TRAY_WELL_CODE` is coded as `0` for everything over 48...how bad is this?

Filter for all `DNA_TRAY_WELL_CODE` = 0
```{r}
PGOD21.gcl %>% 
  dplyr::count(DNA_TRAY_CODE)


PGOD21.gcl %>% 
  dplyr::filter(`DNA_TRAY_WELL_CODE` == 0) %>% 
  dplyr::count(DNA_TRAY_CODE)
```

So there are 115 96 SWP otolith trays involved in `PGOD21`, and 48 of them only code `DNA_TRAY_WELL_CODE` out to well 48, defaulting the rest to `DNA_TRAY_WELL_CODE` = 0...this is clearly a mistake!

Were they coded as the wrong `CONTAINER_ARRAY_TYPE_ID`?
```{r}
PGOD21.gcl %>% 
  dplyr::count(CONTAINER_ARRAY_TYPE_ID)
```

Nope, well that is lame. Just gonna have to fix it, rather than wait to update **LOKI** and have to re-pull the data.
```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_WELL_CODE != 0) %>% 
  dplyr::count(DNA_TRAY_WELL_CODE, DNA_TRAY_WELL_POS)
```

Mother fucker, god damnit, someone coded the `DNA_TRAY_WELL_CODE` to the `DNA_TRAY_WELL_POS` in two freaking different ways!!!!!! The correct orientation per MTALs procedures (see AHRP Tech Doc 7, Figure 4) is A1 --> 1, A2 --> 2. It appears that the set of 96 SWP otolith trays that had `DNA_TRAY_WELL_CODE` = 0 issues after 48 also had the orientation for the `DNA_TRAY_WELL_CODE` to the `DNA_TRAY_WELL_POS` incorrectly labeled as a 48DWP, not a 96 SWP.

### Make 96 SWP `DNA_TRAY_WELL_CODE` Converter

Just going to make my own `DNA_TRAY_WELL_POS` to `DNA_TRAY_WELL_CODE` converter, sheesh.
```{r}
(
  SWP96_DNA_TRAY_WELL_CODE_converter <- PGOD21.gcl %>%
    dplyr::filter(DNA_TRAY_WELL_CODE != 0) %>%
    dplyr::count(DNA_TRAY_WELL_CODE, DNA_TRAY_WELL_POS) %>%
    dplyr::filter(n > 50) %>%
    dplyr::select(-n)
)
```

# Re-do `PGOD21` Joins

Read `PGOD21` back in, fix `DNA_TRAY_WELL_CODE`, create data key for joining with `oto_xfer_data`, and re-join with `oto_xfer_data` and `AHRP_DWP_data`

## Re-read `PGOD21`

```{r}
load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw", sillyvec = "PGOD21")
```

### Fix `DNA_TRAY_WELL_CODE`

Use `SWP96_DNA_TRAY_WELL_CODE_converter`to correct `PGOD21`
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = SWP96_DNA_TRAY_WELL_CODE_converter,
                   by = "DNA_TRAY_WELL_POS",
                   suffix = c("_bad", ""))
```

## Re-create Data Key

```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

## Re-join With `oto_xfer_data` & `AHRP_DWP_data`

```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *422 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number)
```

Whoa, there are 1,360 otoliths that do not match up to a 48DWP...does that mean that they were box/vial otoliths? Or did our joining miss some fish?

### Investigate Fish in Otolith Transfer but NOT in `PGOD21`

These are individual otoliths recorded in the transfer sheet that do NOT appear in `PGOD21`.
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well")
```

There are only 19 otoliths that dropped out, whew. Perhaps that had 0 genotyping success? What's the deal?

How many fish per 96 SWP otolith tray?
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

Okay, just a smattering from here to there, not gonna lose sleep over these :).

## How Many Fish per Silly?

```{r}
PGOD21.gcl %>% 
  dplyr::count(silly)
```

Hrmm, still unclear as to the providence of those 1,360 otoliths. They are not in `oto_xfer_data`
```{r}
PGOD21.gcl %>% 
  dplyr::anti_join(oto_xfer_data, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

They 96 SWP otolith trays that are in `PGOD21`, but not in `oto_xfer_data` are almost all completely full with 95 samples (one with only 30). Need to figure out where these are from...

Update, I went back through my e-mails searching for "otolith_transfer" and found an e-mail from Jodi Neil from 8/17/21 with all of the vial otolith transfer data. I appended that data to `otolith_transfer_111721.csv` to create `otolith_transfer_final.csv` (risky name, I know).

Now let's re-do this all AGAIN.

# Re-do `oto_xfer_data`

## Re-read `PGOD21` & `oto_xfer_data`

```{r}
load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw", sillyvec = "PGOD21")
```

```{r}
(oto_xfer_data <- readr::read_csv("otolith_transfer_final.csv"))
```

### Fix `48_DWP_tray_barcode`

Uh oh, it looks like `48_DWP_tray_barcode` is a character vector, why?
```{r}
oto_xfer_data %>% 
  dplyr::count(`48_DWP_tray_barcode`)
```

God damnit, the vial MTAL `otolith_transfer` sheet had NTC in the `48_DWP_tray_barcode` column. Need to purge those and convert to numeric.
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%
    dplyr::mutate(`48_DWP_tray_barcode` = as.numeric(`48_DWP_tray_barcode`))
)
```

### Fix `DNA_TRAY_WELL_CODE`

Use `SWP96_DNA_TRAY_WELL_CODE_converter`to correct `PGOD21`
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = SWP96_DNA_TRAY_WELL_CODE_converter,
                   by = "DNA_TRAY_WELL_POS",
                   suffix = c("_bad", ""))
```

Dump out for Heather to fix **LOKI**
```{r}
PGOD21.gcl %>%
  dplyr::select(SILLY_CODE,
                FK_FISH_ID,
                DNA_TRAY_CODE,
                DNA_TRAY_WELL_CODE,
                DNA_TRAY_WELL_POS) %>%
  readr::write_csv("PGOD21_tissue_table_DNA_TRAY_WELL_CODE_fix2.csv")
```

## Re-create Data Key

```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    tidyr::unite(
      col = "oto_tray_and_well",
      c(`96_oto_tray_barcode`, `96_oto_tray_position`),
      sep = "_",
      remove = FALSE
    )
)

PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

## Re-join With `oto_xfer_data` & `AHRP_DWP_data`

```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *433 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number) %>% 
  dplyr::count(box_number)
```

Okay, there are 211 otoliths that do not match up to a 48DWP or `box_number`, WTF?!?!?!
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(`48_DWP_tray_barcode`),
                is.na(`box_number`)) %>% 
  dplyr::select(-dplyr::contains("Ogo_"))
```

No clue what these are, still need to resolve...

## Investigate fish in PGOD21 tissue table, but not PGOD21.gcl

Heather noticed that the "fix" I sent her to correct `DNA_TRAY_WELL_CODE` was missing 25 fish. This is probably because I did it off of `PGOD21.gcl`, which may be different than the tissue table for `PGOD21`.
```{r}
nrow(tissue_table_PGOD21)-nrow(PGOD21.gcl)
```

Use `SWP96_DNA_TRAY_WELL_CODE_converter`to correct `tissue_table_PGOD21`
```{r}
tissue_table_PGOD21 <- tissue_table_PGOD21 %>%
  dplyr::left_join(y = SWP96_DNA_TRAY_WELL_CODE_converter,
                   by = "DNA_TRAY_WELL_POS",
                   suffix = c("_bad", ""))
```

Dump out for Heather to fix **LOKI**
```{r}
tissue_table_PGOD21 %>%
  dplyr::select(FK_COLLECTION_ID,
                FK_FISH_ID,
                DNA_TRAY_CODE,
                DNA_TRAY_WELL_CODE,
                DNA_TRAY_WELL_POS) %>%
  readr::write_csv("PGOD21_tissue_table_DNA_TRAY_WELL_CODE_fix3.csv")
```

Confirm
```{r}
nrow(tissue_table_PGOD21)-nrow(PGOD21.gcl)
```

Okay, now what is up with those 25 fish, I presume they have 0 genotypes (complete failures). Let's check the fish in `PGOD21.gcl` to see if they all have at least one locus genotyped?
```{r}
PGOD21.gcl %>% 
  dplyr::select(FK_FISH_ID, dplyr::contains("Ogo_")) %>% 
  dplyr::rowwise(FK_FISH_ID) %>% 
  dplyr::mutate(n_alleles = sum(is.na(dplyr::c_across()))) %>% 
  dplyr::select(FK_FISH_ID, n_alleles) %>% 
  dplyr::arrange(n_alleles)
```

Nope, that isn't it. My guess is that those 25 fish were missing and never extracted due to missing tissue, or not enough tissue (regardless of whether they were flagged in **LOKI** as missing tissue.

## What's going on with 50960

Oh boy, so there are two things going on here with 50960:
  1) according to the MTAL transfer records, there should only be 21 samples, but there are 33 in **LOKI**
  2) both the `DNA_TRAY_WELL_POS` (unique to this tray) and `DNA_TRAY_WELL_CODE` (more common) are wrong...
```{r}
tissue_table_PGOD21 %>% 
  dplyr::filter(DNA_TRAY_CODE == "0000050960")
```

```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_CODE == "0000050960") %>% 
  dplyr::select(-dplyr::contains("Ogo_"))
```

### Investigate Fish in Otolith Transfer but NOT in `PGOD21`

These are individual otoliths recorded in the transfer sheet that do NOT appear in `PGOD21`.
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well")
```

There are only 19 otoliths that dropped out, whew. Perhaps that had 0 genotyping success? What's the deal?

How many fish per 96 SWP otolith tray?
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

Okay, just a smattering from here to there, not gonna lose sleep over these :).

## How Many Fish per Silly?

```{r}
PGOD21.gcl %>% 
  dplyr::count(silly)
```

Hrmm, still unclear as to the providence of those 370 otoliths. They are not in `oto_xfer_data`
```{r}
PGOD21.gcl %>% 
  dplyr::anti_join(oto_xfer_data, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```







# START HERE

# Re-import `PGOD21.gcl` from **LOKI**

## Genotypes

Need to re-import `PGOD21.gcl` from **LOKI** to get Heather's fix for 96 SWP otolith tray 50960.
```{r}
LOKI2R.GCL(
  sillyvec = "PGOD21",
  username = .username,
  password = .password,
  test_type = "GTSNP"
)
```

Save for ease of access
```{r}
save_sillys(sillyvec = "PGOD21",
            path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw")
```

Read back in, if necessary
```{r}
load_objects(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/")
loci <- LocusControl$locusnames

load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw")
```

### Confirm `DNA_TRAY_WELL_CODE`

```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_WELL_CODE != 0) %>% 
  dplyr::count(DNA_TRAY_WELL_CODE, DNA_TRAY_WELL_POS)
```

## Tissue Table

Read in the tissue table for `PGOD21` (*note* we may not need this since we are on the `develop` branch)
```{r}
(
  tissue_table_PGOD21 <- GEN_SAMPLED_FISH_TISSUE.GCL(
    sillyvec = "PGOD21",
    username = .username,
    password = .password,
    file = "~/../Desktop/Local_PWS_pinks/OceanAK/GEN_SAMPLED_FISH_TISSUE_PGOD21_20221114.csv"
  )
)
```

## Otolith Transfer from MTAL

Read in the otolith transfer data from our trip down to the MTAL in April 2021. This contains the original 48 DWP information and the 96 SWP otolith transfer locations, but no SILLY or collection information.
```{r}
(oto_xfer_data <- readr::read_csv("otolith_transfer_final.csv"))
```

### Fix `48_DWP_tray_barcode`

Uh oh, it looks like `48_DWP_tray_barcode` is a character vector, why?
```{r}
oto_xfer_data %>% 
  dplyr::count(`48_DWP_tray_barcode`)
```

God damnit, the vial MTAL `otolith_transfer` sheet had NTC in the `48_DWP_tray_barcode` column. Need to purge those and convert to numeric.
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%
    dplyr::mutate(`48_DWP_tray_barcode` = as.numeric(`48_DWP_tray_barcode`))
)
```

## AHRP Salmon Biological Fact

Read in all of the heart metadata.
```{r}
(
  AHRP_oceanAK <-
    readr::read_csv(file = "~/../Desktop/Local_PWS_pinks/OceanAK/AHRP Salmon Biological Data 20220511_174609.csv")
)
```

# Transform Data

We need to join the transfer data with `PGOD21` so we have the `PGOD21` otolith genotypes paired with the 48DWP barcode and original silly.

## Subset 48DWP & Silly

Make a simple tibble of the 48DWP barcode and silly from `AHRP_oceanAK`
```{r}
(
  AHRP_DWP_data <- AHRP_oceanAK %>%
    dplyr::mutate(
      "48_DWP_tray_barcode" = as.numeric(DNA_TRAY_CODE),
      sample_date = lubridate::as_date(SAMPLE_DATE)
    ) %>%
    dplyr::rename(
      silly = SILLY_CODE,
      sample_year = SAMPLE_YEAR,
      stream = LOCATION_CODE
    ) %>%
    dplyr::distinct(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date) %>%
    dplyr::select(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date)
)
```

## Make Data Key

Make a data key with `96_oto_tray_barcode` and `96_oto_tray_position` for both the `oto_xfer_data` and `PGOD21`.

Also, remove NTC wells from `oto_xfer_data`
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%
    tidyr::unite(
      col = "oto_tray_and_well",
      c(`96_oto_tray_barcode`, `96_oto_tray_position`),
      sep = "_",
      remove = FALSE
    )
)

PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

# Join Transfer & 48DWP Data With `PGOD21`

By joining the transfer data we get the original 48DWP, which we can then join to the AHRP OceanAK metadata to get the 48DWP-level sampling data (silly, stream, year, sample date).
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *384 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number) %>% 
  dplyr::count(box_number)
```

Okay, there are 211 otoliths that do not match up to a 48DWP or `box_number`, WTF?!?!?!
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(`48_DWP_tray_barcode`),
                is.na(`box_number`)) %>% 
  dplyr::select(-dplyr::contains("Ogo_"))
```

No clue what these are, still need to resolve...

## How Many Fish per Silly?

```{r}
PGOD21.gcl %>% 
  dplyr::count(silly)
```

Hrmm, still unclear as to the providence of those 1,360 otoliths. They are not in `oto_xfer_data`
```{r}
PGOD21.gcl %>% 
  dplyr::anti_join(oto_xfer_data, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```




















```{r}
# Otolith SILLY
PGOD21 <- "PGOD21"
LOKI2R.GCL(sillyvec = PGOD21, username = .username, password = .password)

# # read in attributes data from last round(s) and remove already processed fish_ids
# attributes_PGOD21_012522 <- read_csv("attributes_PGOD21_012522.csv")
# processed_PGOD21_fish_ids <- attributes_PGOD21_012522$FK_FISH_ID
# RemoveIDs.GCL(silly = "PGOD21", IDs = processed_PGOD21_fish_ids)

# create a csv from the otolith transfer spreadsheet from MTAL, read in the data, and create a concatenated tray and well column
oto_xfer_data <- read_csv("otolith_transfer_111721.csv") # csv mod of MTAL final "otolith_transfer_96_template_LEFT_all trays_17Nov21.xlsx"
oto_xfer_data$DNA_TRAY_AND_WELL <- paste0(oto_xfer_data$`96_oto_tray_barcode`, "_", oto_xfer_data$`96_oto_tray_position`)

# download csv of PGOD21 sample data from OceanAK and append with _PGOD21_DATE
oceanak_PGOD21 <- read_csv("GEN_SAMPLED_FISH_TISSUE_PGOD21_090922.csv")

# pull the attributes table from PGOD21.gcl, create a new tray a well column, and join with the otolith transfer data
attributes_PGOD21 <- PGOD21.gcl$attributes %>%
  transform(DNA_TRAY_CODE = as.numeric(DNA_TRAY_CODE))

write_csv(attributes_PGOD21, "attributes_PGOD21_090922.csv") # use SillySource from prior dates to remove already processed IDs from PGOD21.gcl

attributes_PGOD21$DNA_TRAY_AND_WELL <- paste0(attributes_PGOD21$DNA_TRAY_CODE, "_", attributes_PGOD21$DNA_TRAY_WELL_CODE)
attributes_and_xfer_PGOD21 <- left_join(attributes_PGOD21, oto_xfer_data, by = "DNA_TRAY_AND_WELL")

# get a list of the affected DWPs
affected_DWPs <- unique(attributes_and_xfer_PGOD21$`48_DWP_tray_barcode`)

# filter OceanAK data pull for the list of affected DWPs
AHRP_oceanak_pull <- read_csv(file = "../../OceanAK/AHRP Salmon Biological Data 20220124_151655.csv") %>% # pull if date stamp is old
  transform(DNA_TRAY_CODE = as.numeric(DNA_TRAY_CODE))
oceanak_affected_DWPs <- AHRP_oceanak_pull[AHRP_oceanak_pull$DNA_TRAY_CODE %in% affected_DWPs, ]

write_csv(oceanak_affected_DWPs, "oceanak_affected_DWPs.csv")

# get SILLYs and fish IDs for affected DWPs
DWP_sillys <- unique(oceanak_affected_DWPs$SILLY_CODE)

PERB15_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PERB15") %>% 
  pull(FISH_ID)
PERB16_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PERB16") %>% 
  pull(FISH_ID)
PERB17_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PERB17") %>% 
  pull(FISH_ID)
PERB18_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PERB18") %>% 
  pull(FISH_ID)
PGILMOUR15_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PGILMOUR15") %>% 
  pull(FISH_ID)
PGILMOUR16_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PGILMOUR16") %>% 
  pull(FISH_ID)
PGILMOUR17_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PGILMOUR17") %>% 
  pull(FISH_ID)
PGILMOUR18_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PGILMOUR18") %>% 
  pull(FISH_ID)
PPADDY15_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PPADDY15") %>% 
  pull(FISH_ID)
PPADDY16_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PPADDY16") %>% 
  pull(FISH_ID)
PPADDY17_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PPADDY17") %>% 
  pull(FISH_ID)
PPADDY18_fish_ids <- oceanak_affected_DWPs %>% 
  dplyr::filter(SILLY_CODE == "PPADDY18") %>% 
  pull(FISH_ID)
```

PERB15: 720
PERB16: 3009
PERB17: 1056
PERB18: 0
PGILMOUR15: 2946
PGILMOUR16: 2736
PGILMOUR17: 3667
PGILMOUR18: 1311
PPADDY15: 0
PPADDY16: 2137
PPADDY17: 0
PPADDY18: 0
Sum: 17,582

```{r}
# Project SILLYs by individuals in a SILLY per affected DWP
# Comment out those SILLYs that have empty fish_ids above

# If LOKI2R_ind does not work for a list with >1000 fish IDs, construct the full *.gcl and remove blacklisted individuals as follows
# LOKI2R.GCL(sillyvec = PERB16, username = .username, password = .password)
# all_PERB16_fish_ids <- PERB16.gcl$attributes$FK_FISH_ID
# unused_PERB16_fish_ids <- all_PERB16_fish_ids[!(all_PERB16_fish_ids %in% PERB16_fish_ids)]
# RemoveIDs.GCL(silly = "PERB16", IDs = unused_PERB16_fish_ids)

PERB15 <- "PERB15"
LOKI2R_ind.GCL(sillyvec = PERB15, fish_ids = PERB15_fish_ids, username = .username, password = .password)

PERB16 <- "PERB16"
# LOKI2R_ind.GCL(sillyvec = PERB16, fish_ids = PERB16_fish_ids, username = .username, password = .password)
LOKI2R.GCL(sillyvec = PERB16, username = .username, password = .password)
all_PERB16_fish_ids <- PERB16.gcl$attributes$FK_FISH_ID
unused_PERB16_fish_ids <- all_PERB16_fish_ids[!(all_PERB16_fish_ids %in% PERB16_fish_ids)]
RemoveIDs.GCL(silly = "PERB16", IDs = unused_PERB16_fish_ids)

PERB17 <- "PERB17"
# LOKI2R_ind.GCL(sillyvec = PERB17, fish_ids = PERB17_fish_ids, username = .username, password = .password)
LOKI2R.GCL(sillyvec = PERB17, username = .username, password = .password)
all_PERB17_fish_ids <- PERB17.gcl$attributes$FK_FISH_ID
unused_PERB17_fish_ids <- all_PERB17_fish_ids[!(all_PERB17_fish_ids %in% PERB17_fish_ids)]
RemoveIDs.GCL(silly = "PERB17", IDs = unused_PERB17_fish_ids)

# PERB18 <- "PERB18"
# LOKI2R_ind.GCL(sillyvec = PERB18, fish_ids = PERB18_fish_ids, username = .username, password = .password)

PGILMOUR15 <- "PGILMOUR15"
# LOKI2R_ind.GCL(sillyvec = PGILMOUR15, fish_ids = PGILMOUR15_fish_ids, username = .username, password = .password)
LOKI2R.GCL(sillyvec = PGILMOUR15, username = .username, password = .password)
all_PGILMOUR15_fish_ids <- PGILMOUR15.gcl$attributes$FK_FISH_ID
unused_PGILMOUR15_fish_ids <- all_PGILMOUR15_fish_ids[!(all_PGILMOUR15_fish_ids %in% PGILMOUR15_fish_ids)]
RemoveIDs.GCL(silly = "PGILMOUR15", IDs = unused_PGILMOUR15_fish_ids)

PGILMOUR16 <- "PGILMOUR16"
# LOKI2R_ind.GCL(sillyvec = PGILMOUR16, fish_ids = PGILMOUR16_fish_ids, username = .username, password = .password) 
LOKI2R.GCL(sillyvec = PGILMOUR16, username = .username, password = .password)
all_PGILMOUR16_fish_ids <- PGILMOUR16.gcl$attributes$FK_FISH_ID
unused_PGILMOUR16_fish_ids <- all_PGILMOUR16_fish_ids[!(all_PGILMOUR16_fish_ids %in% PGILMOUR16_fish_ids)]
RemoveIDs.GCL(silly = "PGILMOUR16", IDs = unused_PGILMOUR16_fish_ids)

PGILMOUR17 <- "PGILMOUR17"
# LOKI2R_ind.GCL(sillyvec = PGILMOUR17, fish_ids = PGILMOUR17_fish_ids, username = .username, password = .password)
LOKI2R.GCL(sillyvec = PGILMOUR17, username = .username, password = .password)
all_PGILMOUR17_fish_ids <- PGILMOUR17.gcl$attributes$FK_FISH_ID
unused_PGILMOUR17_fish_ids <- all_PGILMOUR17_fish_ids[!(all_PGILMOUR17_fish_ids %in% PGILMOUR17_fish_ids)]
RemoveIDs.GCL(silly = "PGILMOUR17", IDs = unused_PGILMOUR17_fish_ids)

PGILMOUR18 <- "PGILMOUR18"
# LOKI2R_ind.GCL(sillyvec = PGILMOUR18, fish_ids = PGILMOUR18_fish_ids, username = .username, password = .password)
LOKI2R.GCL(sillyvec = PGILMOUR18, username = .username, password = .password)
all_PGILMOUR18_fish_ids <- PGILMOUR18.gcl$attributes$FK_FISH_ID
unused_PGILMOUR18_fish_ids <- all_PGILMOUR18_fish_ids[!(all_PGILMOUR18_fish_ids %in% PGILMOUR18_fish_ids)]
RemoveIDs.GCL(silly = "PGILMOUR18", IDs = unused_PGILMOUR18_fish_ids)

# PPADDY15 <- "PPADDY15"
# LOKI2R_ind.GCL(sillyvec = PPADDY15, fish_ids = PPADDY18_fish_ids, username = .username, password = .password)

PPADDY16 <- "PPADDY16"
# LOKI2R_ind.GCL(sillyvec = PPADDY16, fish_ids = PPADDY16_fish_ids, username = .username, password = .password)
LOKI2R.GCL(sillyvec = PPADDY16, username = .username, password = .password)
all_PPADDY16_fish_ids <- PPADDY16.gcl$attributes$FK_FISH_ID
unused_PPADDY16_fish_ids <- all_PPADDY16_fish_ids[!(all_PPADDY16_fish_ids %in% PPADDY16_fish_ids)]
RemoveIDs.GCL(silly = "PPADDY16", IDs = unused_PPADDY16_fish_ids)

# PPADDY18 <- "PPADDY17"
# LOKI2R_ind.GCL(sillyvec = PPADDY17, fish_ids = PPADDY17_fish_ids, username = .username, password = .password)

# PPADDY18 <- "PPADDY18"
# LOKI2R_ind.GCL(sillyvec = PPADDY18, fish_ids = PPADDY18_fish_ids, username = .username, password = .password)
```

```{r}
rm(.username, .password)
```

Create new directories and save objects

```{r save_locus_control_sillys}
if(!dir.exists("../../Objects/GOD_21_Final-1/")) {dir.create("../../Objects/GOD_21_Final-1/")}
save_objects(objects = c("LocusControl", "loci", "PGOD21", "PERB15", "PERB16", "PERB17", "PGILMOUR15", "PGILMOUR16", "PGILMOUR17", "PGILMOUR18", "PPADDY16"), path = "../../Objects/GOD_21_Final-1/")

if(!dir.exists("../../Genotypes/GOD_21_Final-1/")) {dir.create("../../Genotypes/GOD_21_Final-1/")}
save_sillys(sillyvec = c("PGOD21", "PERB15", "PERB16", "PERB17", "PGILMOUR15", "PGILMOUR16", "PGILMOUR17", "PGILMOUR18", "PPADDY16"), path = "../../Genotypes/GOD_21_Final-1/")
```

Load objects if revisiting

```{r load_objects}
# load_objects(path = "../../Objects/GOD_21_Final-1")
# load_sillys(path = "../../Genotypes/GOD_21_Final-1")
```