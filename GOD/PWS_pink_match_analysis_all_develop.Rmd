---
title: "1_data_prep_PWS_pink_otolith_match_analysis"
subtitle: "Re-do with `develop` branch GCL-R-Scripts"
author: "Kyle Shedd & Kristen Gruenthal"
date: "Started: 2022-11-10, last opened: `r Sys.Date()`"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
rm(list=ls())

if(!require("pacman")) install.packages("pacman"); library(pacman)

pacman::p_load(
  tidyverse,
  lubridate
)

source("~/../R/Functions.GCL.R")
# source("../../GOD/LOKI2R_ind.GCL.R")
# source("../../GOD/DupCheckBetweenSillys_GOD.GCL.r")

.username = readLines("~/../R/usr_pw.txt", n = 1)
.password = readLines("~/../R/usr_pw.txt" , n = 2)[[2]]

knitr::opts_chunk$set(echo = TRUE)
```

# Objective

The purpose of this notebook is to prepare the data for our attempt to re-pair GT-seq genotypes from otolith-derived DNA with GT-seq genotypes from heart-derived DNA for individuals of unknown origin. This notebook will match up the 96 SWP locations from `PGOD21.gcl` to the original 48 DWP to prepare for matching (separate notebook). This will be done by linking 3 things:  

  1) `PGOD21.gcl` otolith genotypes from 96 SWP,
  2) Otolith transfer records documenting the transfer of otoliths from their original 48 DWP (or box of 48 DWP),
  3) AHRP Salmon Biological Fact data containing field data (silly code, stream, year, 48 DWP, etc.)
  
Bottom line, we need to know to the finest scale possible (48 DWP or box) where otoliths in `PGOD21.gcl` came from so we can limit our search space for matching.

# Background

During shipment of otolith samples in February 2020 to the MTA in Juneau for reading, a significant proportion of otoliths migrated between cells within DWPs due to poor containment of the acetate lids that were attached with rubber bands to the DWPs. This incident is known as "the great otolith debacle", aka the "GOD" incident. Since some otoliths moved from their original cells in the DWP, the paired integrity of the otolith-origin information and the rest of the paired data (genotype + field data) was lost for just under 11,000 individuals. In an attempt to rectify the "GOD" incident, we are extracting DNA from the otolith tissues, genotyping the otolith-derived DNA at 298 GT-seq loci, and attempting to re-pair the otolith-heart samples from their genotypes.  

# Methods

DNA was extracted from left-side or unknown otolith tissues of unknown origin using conventional Machery-Nagel DNA extraction kits. Otoliths were placed in T1 buffer for an overnight soak in clear 96 shallow-well plates (SWP). Preamp at 14 cycles. Final elution volume was 75uL. All otoliths were transferred among plates with a jig. All liquid handling was done by robot.

# Import Data

## Genotypes

### LocusControl

Using our standard 298 SNP pink salmon GT-seq loci.
```{r}
loci <- dget("~/../Desktop/Local_PWS_pinks/loci298.txt") # saved list of loci

CreateLocusControl.GCL(locusnames = loci, username = .username, password = .password)

save_objects(objects = "LocusControl", path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/")
```

### Genotypes

Read in `PGOD21` and heart genotypes for all affected DWPs.
```{r}
LOKI2R.GCL(
  sillyvec = c(
    "PGOD21",
    paste0("PERB", 15:17),
    paste0("PGILMOUR", 15:18),
    "PPADDY16"
  ),
  username = .username,
  password = .password,
  test_type = "GTSNP"
)
```

Save for ease of access
```{r}
save_sillys(
  sillyvec = c(
    "PGOD21",
    paste0("PERB", 15:17),
    paste0("PGILMOUR", 15:18),
    "PPADDY16"
  ),
  path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw"
)
```

Read back in, if necessary
```{r}
load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw", sillyvec = "PGOD21")
```

## Tissue Table

Read in the tissue table for `PGOD21` (*note* we may not need this since we are on the `develop` branch)
```{r}
(
  tissue_table_PGOD21 <- GEN_SAMPLED_FISH_TISSUE.GCL(
    sillyvec = "PGOD21",
    username = .username,
    password = .password,
    file = "~/../Desktop/Local_PWS_pinks/OceanAK/GEN_SAMPLED_FISH_TISSUE_PGOD21_20221111.csv"
  )
)
```

## Otolith Transfer from MTAL

Read in the otolith transfer data from our trip down to the MTAL in March 2021. This contains the original 48 DWP information and the 96 SWP otolith transfer locations, but no SILLY or collection information.
```{r}
(oto_xfer_data <- readr::read_csv("otolith_transfer_111721.csv"))
```

## AHRP Salmon Biological Fact

Read in all of the heart metadata.
```{r}
(
  AHRP_oceanAK <-
    readr::read_csv(file = "~/../Desktop/Local_PWS_pinks/OceanAK/AHRP Salmon Biological Data 20220511_174609.csv")
)
```

# Transform Data

We need to join the otolith transfer data with `PGOD21` so we have the `PGOD21` otolith genotypes paired with the 48DWP barcode and original silly.

## Subset 48DWP & Silly

Make a simple tibble of the 48DWP barcode and silly from `AHRP_oceanAK`
```{r}
(
  AHRP_DWP_data <- AHRP_oceanAK %>%
    dplyr::mutate(
      "48_DWP_tray_barcode" = as.numeric(DNA_TRAY_CODE),
      sample_date = lubridate::as_date(SAMPLE_DATE)
    ) %>%
    dplyr::rename(
      silly = SILLY_CODE,
      sample_year = SAMPLE_YEAR,
      stream = LOCATION_CODE
    ) %>%
    dplyr::distinct(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date) %>%
    dplyr::select(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date)
)
```

## Make Data Key

Make a data key with `96_oto_tray_barcode` and `96_oto_tray_position` for both the `oto_xfer_data` and `PGOD21`.

Also, remove NTC wells from `oto_xfer_data`
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%
    tidyr::unite(
      col = "oto_tray_and_well",
      c(`96_oto_tray_barcode`, `96_oto_tray_position`),
      sep = "_",
      remove = FALSE
    )
)

PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

# Join Transfer & 48DWP Data With `PGOD21`

By joining the transfer data we get the original 48DWP, which we can then join to the AHRP OceanAK metadata to get the 48DWP-level sampling data (silly, stream, year, sample date).
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *384 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number)
```

Whoa, there are 3,052 otoliths that do not match up to a 48DWP...does that mean that they were box/vial otoliths? Or did our joining miss some fish?

### Investigate Fish in Otolith Transfer but NOT in `PGOD21`

These are individual otoliths recorded in the transfer sheet that do NOT appear in `PGOD21`.
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well")
```

There are 1,711 otoliths that dropped out. Perhaps that had 0 genotyping success? What's the deal?

How many fish per 96 SWP otolith tray?
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

44 different 96 SWP otolith trays that have *no* data in `PGOD21`, and most of these appear to be *missing* data for exactly 47 otoliths?!?! WTF?

Let's look in to 96 SWP otolith tray 50902 (missing 47 samples).
```{r}
PGOD21.gcl %>% 
  dplyr::filter(`96_oto_tray_barcode` == 50902)
```

Wait, WTF, the `DNA_TRAY_WELL_POS` appears to be correct, but the `DNA_TRAY_WELL_CODE` is coded as `0` for everything over 48...how bad is this?

Filter for all `DNA_TRAY_WELL_CODE` = 0
```{r}
PGOD21.gcl %>% 
  dplyr::count(DNA_TRAY_CODE)

PGOD21.gcl %>% 
  dplyr::filter(`DNA_TRAY_WELL_CODE` == 0) %>% 
  dplyr::count(DNA_TRAY_CODE)
```

So there are 115 96 SWP otolith trays involved in `PGOD21`, and 48 of them only code `DNA_TRAY_WELL_CODE` out to well 48, defaulting the rest to `DNA_TRAY_WELL_CODE` = 0...this is clearly a mistake!

Were they coded as the wrong `CONTAINER_ARRAY_TYPE_ID`?
```{r}
PGOD21.gcl %>% 
  dplyr::count(CONTAINER_ARRAY_TYPE_ID)
```

Nope, well that is lame. Just gonna have to fix it, rather than wait to update **LOKI** and have to re-pull the data.
```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_WELL_CODE != 0) %>% 
  dplyr::count(DNA_TRAY_WELL_CODE, DNA_TRAY_WELL_POS)
```

Mother fucker, someone coded the `DNA_TRAY_WELL_CODE` to the `DNA_TRAY_WELL_POS` in two freaking different ways!!!!!! The correct orientation per MTALs procedures (see AHRP Tech Doc 7, Figure 4) is from left to right, one row at a time A1 --> 1, A2 --> 2. It appears that the set of 96 SWP otolith trays that had `DNA_TRAY_WELL_CODE` = 0 issues after 48 also had the orientation for the `DNA_TRAY_WELL_CODE` to the `DNA_TRAY_WELL_POS` incorrectly labeled as a 48DWP, not a 96 SWP.

### Make 96 SWP `DNA_TRAY_WELL_CODE` Converter

Just going to make my own `DNA_TRAY_WELL_POS` to `DNA_TRAY_WELL_CODE` converter, sheesh.
```{r}
(
  SWP96_DNA_TRAY_WELL_CODE_converter <- PGOD21.gcl %>%
    dplyr::filter(DNA_TRAY_WELL_CODE != 0) %>%
    dplyr::count(DNA_TRAY_WELL_CODE, DNA_TRAY_WELL_POS) %>%
    dplyr::filter(n > 50) %>%
    dplyr::select(-n)
)
```

# Re-do `PGOD21` Joins

Read `PGOD21` back in, fix `DNA_TRAY_WELL_CODE`, create data key for joining with `oto_xfer_data`, and re-join with `oto_xfer_data` and `AHRP_DWP_data`

## Re-read `PGOD21`

```{r}
load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw", sillyvec = "PGOD21")
```

### Fix `DNA_TRAY_WELL_CODE`

Use `SWP96_DNA_TRAY_WELL_CODE_converter`to correct `PGOD21`
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = SWP96_DNA_TRAY_WELL_CODE_converter,
                   by = "DNA_TRAY_WELL_POS",
                   suffix = c("_bad", ""))
```

## Re-create Data Key

```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

## Re-join With `oto_xfer_data` & `AHRP_DWP_data`

```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *422 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number)
```

Whoa, there are 1,360 otoliths that do not match up to a 48DWP...does that mean that they were box/vial otoliths? Or did our joining miss some fish?

### Investigate Fish in Otolith Transfer but NOT in `PGOD21`

These are individual otoliths recorded in the transfer sheet that do NOT appear in `PGOD21`.
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well")
```

There are only 19 otoliths that dropped out, whew. Perhaps that had 0 genotyping success? What's the deal?

How many fish per 96 SWP otolith tray?
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

Okay, just a smattering from here to there, not gonna lose sleep over these :).

## How Many Fish per Silly?

```{r}
PGOD21.gcl %>% 
  dplyr::count(silly)
```

Hrmm, still unclear as to the providence of those 1,360 otoliths. They are not in `oto_xfer_data`
```{r}
PGOD21.gcl %>% 
  dplyr::anti_join(oto_xfer_data, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

The 96 SWP otolith trays that are in `PGOD21`, but not in `oto_xfer_data` are almost all completely full with 95 samples (one with only 30). Need to figure out where these are from...

Update, I went back through my e-mails searching for "otolith_transfer" and found an e-mail from Jodi Neil from 8/17/21 with all of the **vial otolith** transfer data. I appended that data to `otolith_transfer_111721.csv` to create `otolith_transfer_final.csv` (risky name, I know).

Now let's re-do this all AGAIN.

# Re-do `oto_xfer_data`

## Re-read `PGOD21` & `oto_xfer_data`

```{r}
load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw", sillyvec = "PGOD21")
```

```{r}
(oto_xfer_data <- readr::read_csv("otolith_transfer_final.csv"))
```

### Fix `48_DWP_tray_barcode`

Uh oh, it looks like `48_DWP_tray_barcode` is a character vector, why?
```{r}
oto_xfer_data %>% 
  dplyr::count(`48_DWP_tray_barcode`)
```

God damnit, the vial MTAL `otolith_transfer` sheet had NTC in the `48_DWP_tray_barcode` column. Need to purge those and convert to numeric.
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%
    dplyr::mutate(`48_DWP_tray_barcode` = as.numeric(`48_DWP_tray_barcode`))
)
```

### Fix `DNA_TRAY_WELL_CODE`

Use `SWP96_DNA_TRAY_WELL_CODE_converter`to correct `PGOD21`
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = SWP96_DNA_TRAY_WELL_CODE_converter,
                   by = "DNA_TRAY_WELL_POS",
                   suffix = c("_bad", ""))
```

Dump out for Heather to fix **LOKI**
```{r}
PGOD21.gcl %>%
  dplyr::select(SILLY_CODE,
                FK_FISH_ID,
                DNA_TRAY_CODE,
                DNA_TRAY_WELL_CODE,
                DNA_TRAY_WELL_POS) %>%
  readr::write_csv("PGOD21_tissue_table_DNA_TRAY_WELL_CODE_fix2.csv")
```

## Re-create Data Key

```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    tidyr::unite(
      col = "oto_tray_and_well",
      c(`96_oto_tray_barcode`, `96_oto_tray_position`),
      sep = "_",
      remove = FALSE
    )
)

PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

## Re-join With `oto_xfer_data` & `AHRP_DWP_data`

```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode")
```

## How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
PGOD21.gcl %>% 
  dplyr::distinct(`48_DWP_tray_barcode`)

PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)
```

There are *433 48DWPs* involved in GOD!

What about **box** otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::select(silly, `48_DWP_tray_barcode`, box_number) %>% 
  dplyr::count(box_number)
```

Okay, there are 211 otoliths that do not match up to a 48DWP or `box_number`, WTF?!?!?!
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(`48_DWP_tray_barcode`),
                is.na(`box_number`)) %>% 
  dplyr::select(-dplyr::contains("Ogo_"))
```

No clue what these are, still need to resolve...

## Investigate fish in PGOD21 tissue table, but not PGOD21.gcl

Heather noticed that the "fix" I sent her to correct `DNA_TRAY_WELL_CODE` was missing 25 fish. This is probably because I did it off of `PGOD21.gcl`, which may be different than the tissue table for `PGOD21`.
```{r}
nrow(tissue_table_PGOD21)-nrow(PGOD21.gcl)
```

Use `SWP96_DNA_TRAY_WELL_CODE_converter`to correct `tissue_table_PGOD21`
```{r}
tissue_table_PGOD21 <- tissue_table_PGOD21 %>%
  dplyr::left_join(y = SWP96_DNA_TRAY_WELL_CODE_converter,
                   by = "DNA_TRAY_WELL_POS",
                   suffix = c("_bad", ""))
```

Dump out for Heather to fix **LOKI**
```{r}
tissue_table_PGOD21 %>%
  dplyr::select(FK_COLLECTION_ID,
                FK_FISH_ID,
                DNA_TRAY_CODE,
                DNA_TRAY_WELL_CODE,
                DNA_TRAY_WELL_POS) %>%
  readr::write_csv("output/PGOD21_tissue_table_DNA_TRAY_WELL_CODE_fix3.csv")
```

Confirm
```{r}
nrow(tissue_table_PGOD21)-nrow(PGOD21.gcl)
```

Okay, now what is up with those 25 fish, I presume they have 0 genotypes (complete failures). Let's check the fish in `PGOD21.gcl` to see if they all have at least one locus genotyped?
```{r}
PGOD21.gcl %>% 
  dplyr::select(FK_FISH_ID, dplyr::contains("Ogo_")) %>% 
  dplyr::rowwise(FK_FISH_ID) %>% 
  dplyr::mutate(n_alleles = sum(is.na(dplyr::c_across()))) %>% 
  dplyr::select(FK_FISH_ID, n_alleles) %>% 
  dplyr::arrange(n_alleles)
```

Nope, that isn't it. My guess is that those 25 fish were missing and never extracted due to missing tissue, or not enough tissue (regardless of whether they were flagged in **LOKI** as missing tissue.

## What's going on with 50960

Oh boy, so there are two things going on here with 50960:
  1) according to the MTAL transfer records, there should only be 21 samples, but there are 33 in **LOKI**
  2) both the `DNA_TRAY_WELL_POS` (unique to this tray) and `DNA_TRAY_WELL_CODE` (more common) are wrong...
```{r}
tissue_table_PGOD21 %>% 
  dplyr::filter(DNA_TRAY_CODE == "0000050960")
```

```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_CODE == "0000050960") %>% 
  dplyr::select(-dplyr::contains("Ogo_"))
```

### Investigate Fish in Otolith Transfer but NOT in `PGOD21`

These are individual otoliths recorded in the transfer sheet that do NOT appear in `PGOD21`.
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well")
```

There are only 88 otoliths that dropped out, whew. Perhaps that had 0 genotyping success? What's the deal?

How many fish per 96 SWP otolith tray?
```{r}
oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

Okay, just a smattering from here to there, not gonna lose sleep over these :). 50960 is inflated because it is a partially filled tray.

## How Many Fish per Silly?

```{r}
PGOD21.gcl %>% 
  dplyr::count(silly)
```

Hrmm, still unclear as to the providence of those 370 otoliths. They are not in `oto_xfer_data`
```{r}
PGOD21.gcl %>% 
  dplyr::anti_join(oto_xfer_data, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)
```

# Re-import `PGOD21.gcl` from **LOKI** 2023-01-26

## Genotypes

Need to re-import `PGOD21.gcl` from **LOKI** to get Heather's fix for 96 SWP otolith tray 50960.
```{r}
load_objects(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/", pattern = "LocusControl")

LOKI2R.GCL(
  sillyvec = "PGOD21",
  username = .username,
  password = .password,
  test_type = "GTSNP"
)
```

Save for ease of access
```{r}
save_sillys(sillyvec = "PGOD21",
            path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw")
```

Read back in, if necessary
```{r}
load_objects(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/")
loci <- LocusControl$locusnames

load_sillys(path = "~/../Desktop/Local_PWS_pinks/Genotypes/GOD_develop/Raw")
```

### Confirm `DNA_TRAY_WELL_CODE`

Previously there was an issue with how `DNA_TRAY_WELL_POS` was translated into `DNA_TRAY_WELL_CODE`, remember that otolith trays are filled left to right.
```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_WELL_CODE != 0) %>% 
  dplyr::count(DNA_TRAY_WELL_CODE, DNA_TRAY_WELL_POS)
```

Okay, confirmed that all 96 otolith trays in `PGOD21.gcl` have the correct well code and well position.

## Tissue Table

Read in the tissue table for `PGOD21` (*note* we may not need this since we are on the `develop` branch)
```{r}
# (
#   tissue_table_PGOD21 <- GEN_SAMPLED_FISH_TISSUE.GCL(
#     sillyvec = "PGOD21",
#     username = .username,
#     password = .password,
#     file = "~/../Desktop/Local_PWS_pinks/OceanAK/GEN_SAMPLED_FISH_TISSUE_PGOD21_20230208.csv"
#   )
# )

(
  tissue_table_PGOD21 <-
    readr::read_csv(
      "~/../Desktop/Local_PWS_pinks/OceanAK/GEN_SAMPLED_FISH_TISSUE_PGOD21_20230208.csv"
    )
)
```

There are 10,816 otoliths in PGOD21, but we only read in genotypes from 10,791, what happened to those 25 otoliths? Are they missing?
```{r}
table(tissue_table_PGOD21$IS_MISSING_PAIRED_DATA_EXISTS)
```

Looks like 11 are marked in *LOKI* missing, but that leaves a discrepancy of 14 otoliths. This was also noted above, not entirely sure what the issue is, but they weren't genotyped, so they are going to drop out anyways...

## Otolith Transfer from MTAL

Read in the otolith transfer data from our trip down to the MTAL in March 2021. This contains the original 48 DWP information and the 96 SWP otolith transfer locations, but no SILLY or collection information. The file was a combination of the DWP transfer file sent by Jodi Neil on 2021-11-17 (`otolith_transfer_96_template_LEFT.xlsx`) and the vial otolith transfer file sent by Jodi Neil on 2021-08-17 (`otolith_transfer_96_template_VIALS_LEFT.xlsx`) that Kyle saved as a `.csv` for ease of reading into R.
```{r}
(oto_xfer_data <- readr::read_csv("data/otolith_transfer_final.csv") %>% 
   dplyr::filter(`96_oto_tray_position` != 96))  # filter out NTC
```

Right off the bat, we can see that we only have transfer records for 10,614 otoliths when we should have records for 10,816...that's (202 missing otoliths based on `PGOD21.gcl` tissue inventory).

## AHRP Salmon Biological Fact

Read in all of the heart tissue metadata for all PWS Pink Salmon collections from 2013-2020.
```{r}
(
  AHRP_oceanAK <-
    readr::read_csv(file = "~/../Desktop/Local_PWS_pinks/OceanAK/AHRP Salmon Biological Data 20220511_174609.csv")
)
```

# Transform Data

We need to join the transfer data with `PGOD21` so we have the `PGOD21` otolith genotypes paired with the 48DWP barcode and original silly. This will allow us to compare the `PGOD21` genotypes to the heart genotypes from the same 48DWP and limit our search image.

## Subset 48DWP & Silly

Make a simple tibble of the 48DWP barcode and silly from `AHRP_oceanAK`
```{r}
(
  AHRP_DWP_data <- AHRP_oceanAK %>%
    dplyr::mutate(
      "48_DWP_tray_barcode" = as.numeric(DNA_TRAY_CODE),
      sample_date = lubridate::as_date(SAMPLE_DATE)
    ) %>%
    dplyr::rename(
      silly = SILLY_CODE,
      sample_year = SAMPLE_YEAR,
      stream = LOCATION_CODE
    ) %>%
    dplyr::distinct(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date) %>%
    dplyr::select(`48_DWP_tray_barcode`, silly, stream, sample_year, sample_date)
)
```

## Make Data Key

Make a data key with `96_oto_tray_barcode` and `96_oto_tray_position` for both the `oto_xfer_data` and `PGOD21`.

Already, removed NTC wells from `oto_xfer_data`
```{r}
(
  oto_xfer_data <- oto_xfer_data %>%
    # dplyr::filter(!(`48_DWP_tray_barcode` %in% "NTC")) %>%  # already did this above
    tidyr::unite(
      col = "oto_tray_and_well",
      c(`96_oto_tray_barcode`, `96_oto_tray_position`),
      sep = "_",
      remove = FALSE
    )
)

PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::mutate("96_oto_tray_barcode" = as.numeric(DNA_TRAY_CODE)) %>%
  tidyr::unite(
    col = "oto_tray_and_well",
    c(`96_oto_tray_barcode`, `DNA_TRAY_WELL_CODE`),
    sep = "_",
    remove = FALSE
  )
```

# Join Otolith Transfer & 48DWP Data With `PGOD21`

By joining the transfer data we get the original 48DWP, which we can then join to the AHRP OceanAK metadata to get the 48DWP-level sampling data (silly, stream, year, sample date).
```{r}
PGOD21.gcl <- PGOD21.gcl %>%
  dplyr::left_join(y = oto_xfer_data,
                   by = c("oto_tray_and_well", "96_oto_tray_barcode")) %>%
  dplyr::left_join(y = AHRP_DWP_data, by = "48_DWP_tray_barcode") %>% 
  dplyr::relocate(dplyr::contains("Ogo_"), .after = dplyr::last_col())  # move genotype columns to the end
```

## How Many Fish and How Many 48DWPs?

How many unique 48DPWs have GOD otolith genotypes?
```{r}
dplyr::n_distinct(PGOD21.gcl$`48_DWP_tray_barcode`, na.rm = TRUE)

# Count of 48DWP per silly
PGOD21.gcl %>% 
  dplyr::distinct(silly, `48_DWP_tray_barcode`) %>% 
  dplyr::count(silly)

# Count of fish per silly
PGOD21.gcl %>% 
  dplyr::count(silly) %>% 
  janitor::adorn_totals()
```

There are *432 48DWPs* involved in GOD!

What about **359 otoliths** that did not assign to a 48DWP or silly? Are they all *box* otoliths that were just kicking around in one of the shipping boxes and were later put into vials at the MTAL? Or do we potentially have some data entry errors?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(silly)) %>% 
  dplyr::mutate(is_box = !is.na(box_number)) %>% 
  dplyr::count(is_box)
```

The transfer records for the **159 box otoliths** showing which 48DWPs were in which boxes are here `Oto Boxes that shipped to JNU.xlsx`.

But the bigger issue here is that, there are **200 otoliths** that do not match up to a 48DWP or `box_number`, WTF?!?!?!
```{r}
PGOD21.gcl %>% 
  dplyr::filter(is.na(`48_DWP_tray_barcode`),
                is.na(`box_number`)) %>% 
  dplyr::select(-dplyr::contains("Ogo_")) %>% 
  dplyr::count(DNA_TRAY_CODE)
```

It looks like these 200 otoliths are spread across 3 SWP (2 full, 1 partial). No clue what these are, still need to resolve...

Are these otolith trays present in the transfer data?
```{r}
PGOD21.gcl %>% 
  dplyr::anti_join(oto_xfer_data, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`, PLATE_ID)  # in PGOD21.gcl, not in transfer records

oto_xfer_data %>% 
  dplyr::anti_join(PGOD21.gcl, by = "oto_tray_and_well") %>% 
  dplyr::count(`96_oto_tray_barcode`)  # in transfer records, but not in PGOD21.gcl
```

The two full trays are **not** in the transfer records, however, the partial is, but shows it was only filled until position 21. However, we have genotypes for positions 22 and 25-33.

*Update 2023-02-10* The 2 full 96 otolith trays were from Jodi Estrada's in-house GCL otolith transfer!!!

How many otolith genotypes do we have in the partial?
```{r}
PGOD21.gcl %>% 
  dplyr::filter(DNA_TRAY_CODE == "0000050960")
```

# Oto Transfer Comments

We'll need to review these in the course of re-pairing otoliths with hearts.
```{r}
oto_xfer_data %>% 
  dplyr::count(comment)
```

# Save `PGOD21` Data Pairing

```{r}
PGOD21.gcl %>% 
  dplyr::select(-dplyr::contains("Ogo_")) %>% 
  dplyr::glimpse()
```

Strip to the bare essentials and save.
```{r}
(
  PGOD21_48DWP_paired <- PGOD21.gcl %>%
    dplyr::select(
      SillySource,
      oto_tray_and_well,
      `96_oto_tray_barcode`:sample_date
    )
)

readr::write_csv(x = PGOD21_48DWP_paired, file = "output/PGOD21_48DWP_paired.csv")
```

```{r}
PGOD21_48DWP_paired %>% 
  dplyr::filter(`96_oto_tray_barcode` == 50908)
```

# NEED TO READ IN JODI ESTRADA'S OTOLITH TRANSFERS AND UPDATE

# Final Stats

10,791 otoliths with genotypes.

```{r}
PGOD21_48DWP_paired %>%
  dplyr::mutate(
    match_type = dplyr::case_when(
      !is.na(`48_DWP_tray_barcode`) & !is.na(`48_DWP_tray_position`) ~ "DWP+Position",
      !is.na(`48_DWP_tray_barcode`) & is.na(`48_DWP_tray_position`) ~ "DWP_Only",
      is.na(`48_DWP_tray_barcode`) & !is.na(box_number) ~ "Box",
      is.na(`48_DWP_tray_barcode`) & is.na(box_number) ~ "Nothin",
      TRUE ~ "WTF"
    )
  ) %>% 
  dplyr::count(match_type)
```

# Things to Consider for Matching

Before we finalize otolith-heart "matches", there are a few modifications that I'd like to make:  
  * we need a genotyping success threshold for otoliths, it doesn't have to be very high (likely ~5-10%), but we need something to weed out matches where we only have 5 loci for an otolith
  * we need to implement a heterozygosity filter for hearts, just like we do for parentage analysis, otherwise we'll end up with some very heterozygous heart genotypes that will match *very* well to our highly contaminated (read heterozygous) otoliths 
  * will want to check otolith transfer comments prior to finalizing matches
  * will want to review `raw_working_oto_sheets/working_oto_sheet_combined.xlsm` to see DWP map prior to finalizing

End 2023-02-10