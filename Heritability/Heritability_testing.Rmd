---
title: "Heritability of body length, sample date, location, and RS according to Cross Type"
author: "Kristen Gruenthal"
date: "March 30, 2021"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# Introduction
The purpose of these analyses are to more fully explore the parent-pair offspring trio/triad data (i.e. cross data) in terms of spatiotemporal patterning.
```{r setup, include=FALSE}
rm(list=ls())

library(coin)
library(MASS)
library(scales)
library(tidyverse)
library(leaflet)
library(lubridate)
library(ggExtra)
library(gridExtra)
library(MuMIn)
library(GGally)
library(gganimate)

knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.width = 10)
```

# Mating patterns in the parental generation according to cross type

## Who
Who are the two-parents, both dam and sire, for each cross type offspring?
```{r}
stock_riverdist <- read_csv("../../GIS/R/stockdale/stockdale_distances.csv") %>% 
  mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
                                dist2tide <= 0 ~ "Intertidal")) %>% 
  rename(Distance = mouthdist, Segment = seg)

hogan_riverdist <- read_csv("../../GIS/R/hogan/hogan_distances.csv") %>% 
  mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
                                dist2tide <= 0 ~ "Intertidal")) %>% 
  rename(Distance = mouthdist, Segment = seg)

# gilmour_riverdist <- read_csv("../../GIS/R/gilmour/gilmour_distances.csv") %>% 
#   mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
#                                 dist2tide <= 0 ~ "Intertidal")) %>% 
#   rename(Distance = mouthdist, Segment = seg)
# 
# paddy_riverdist <- read_csv("../../GIS/R/paddy/paddy_distances.csv") %>% 
#   mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
#                                 dist2tide <= 0 ~ "Intertidal")) %>% 
#   rename(Distance = mouthdist, Segment = seg)
# 
# erb_riverdist <- read_csv("../../GIS/R/erb/erb_distances.csv") %>% 
#   mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
#                                 dist2tide <= 0 ~ "Intertidal")) %>% 
#   rename(Distance = mouthdist, Segment = seg)

stock_parents_paired_14_16_cross <- read_csv("../Stockdale/stock_parents_paired_14_16_cross.csv")
hogan_parents_paired_14_16_cross <- read_csv("../Hogan/hogan_parents_paired_14_16_cross.csv")
# gilmour_parents_paired_14_16_cross <- read_csv("../Gilmour/gilmour_parents_paired_14_16_cross.csv")
# paddy_parents_paired_14_16_cross <- read_csv("../Paddy/paddy_parents_paired_14_16_cross.csv")
# erb_parents_paired_14_16_cross <- read_csv("../Erb/erb_parents_paired_14_16_cross.csv")

# organize by sire and dam, join riverdist data
parents_paired_cross_riverdist_spacetime <- function(indata_spacetime = stock_parents_paired_14_16_cross, indata_riverdist = stock_riverdist) {
  indata_spacetime %>% 
  count(cross, `Fish ID`, `Fish ID.par1`, `Sample Date`, `Sample Date.par1`, SEX, SEX.par1, `DNA Tray Code`, `DNA Tray Code.par1`, `DNA Tray Well Code`, `DNA Tray Well Code.par1`, origin.par1, origin, `Length Mm.par1`, `Length Mm`) %>% 
  rename(`Fish ID.par2` = `Fish ID`, 
         `Sample Date.par2` = `Sample Date`,
         SEX.par2 = SEX,
         `DNA Tray Code.par2` = `DNA Tray Code`,
         `DNA Tray Well Code.par2` = `DNA Tray Well Code`,
         origin.par2 = origin,
         `Length Mm.par2` = `Length Mm`) %>% 
  unite(Sample.par1, c("DNA Tray Code.par1", "DNA Tray Well Code.par1"), sep = "_", remove = TRUE) %>% 
  unite(Sample.par2, c("DNA Tray Code.par2", "DNA Tray Well Code.par2"), sep = "_", remove = TRUE) %>% 
  left_join(indata_riverdist, by = c("Sample.par1" = "Sample")) %>% 
  left_join(indata_riverdist, by = c("Sample.par2" = "Sample"), suffix = c(".par1", ".par2")) %>% 
  mutate(fish_id.sire = case_when(SEX.par1 == "M" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(fish_id.dam = case_when(SEX.par1 == "F" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(sample_date.sire = case_when(SEX.par1 == "M" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sample_date.dam = case_when(SEX.par1 == "F" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sex.sire = case_when(SEX.par1 == "M" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>% 
  mutate(sex.dam = case_when(SEX.par1 == "F" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>%
  mutate(origin.sire = case_when(SEX.par1 == "M" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>% 
  mutate(origin.dam = case_when(SEX.par1 == "F" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>%
  mutate(distance.sire = case_when(SEX.par1 == "M" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>% 
  mutate(distance.dam = case_when(SEX.par1 == "F" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>%
  mutate(intertidal.sire = case_when(SEX.par1 == "M" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>% 
  mutate(intertidal.dam = case_when(SEX.par1 == "F" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>%
  mutate(length.sire = case_when(SEX.par1 == "M" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>% 
  mutate(length.dam = case_when(SEX.par1 == "F" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>%
  select(cross, n, ends_with(".sire"), ends_with(".dam"))
}

(stock_parents_paired_14_16_cross_riverdist_spacetime <- parents_paired_cross_riverdist_spacetime())
(hogan_parents_paired_14_16_cross_riverdist_spacetime <- parents_paired_cross_riverdist_spacetime(hogan_parents_paired_14_16_cross, hogan_riverdist))
# (gilmour_parents_paired_14_16_cross_riverdist_spacetime <- parents_paired_cross_riverdist_spacetime(gilmour_parents_paired_14_16_cross, gilmour_riverdist))
# (paddy_parents_paired_14_16_cross_riverdist_spacetime <- parents_paired_cross_riverdist_spacetime(paddy_parents_paired_14_16_cross, paddy_riverdist))
# (erb_parents_paired_14_16_cross_riverdist_spacetime <- parents_paired_cross_riverdist_spacetime(erb_parents_paired_14_16_cross, erb_riverdist)
```


## Body Length
Was there evidence of size assortative mating?
```{r}
parents_paired_cross_riverdist_length <- function(indata_length = stock_parents_paired_14_16_cross_riverdist_spacetime, title = "Parent Length by Cross Type: Stockdale") {
  indata_length%>% 
  filter(length.sire > 300 & length.dam > 300) %>% 
  ggplot(aes(x = length.sire, y = length.dam), alpha = 0.05) +
  geom_jitter(aes(colour = cross, size = n), alpha = 0.5) +
  geom_abline(slope = 1)+
  geom_smooth(method = "lm") +
  theme_bw() +
  labs(title = title) +
  xlab("Sire Length (mm)") +
  ylab("Dam Length (mm)") +
  labs(size = "RS", 
       colour = "Parent: Cross Type") +
  theme(text = element_text(size = 20))
}

(stock_parents_paired_14_16_cross_riverdist_length <- parents_paired_cross_riverdist_length())
(hogan_parents_paired_14_16_cross_riverdist_length <- parents_paired_cross_riverdist_length(hogan_parents_paired_14_16_cross_riverdist_spacetime, title = "Parent Length by Cross Type: Hogan"))
# gilmour_parents_paired_14_16_cross_riverdist_length <- parents_paired_cross_riverdist_length(gilmour_parents_paired_14_16_cross_riverdist_spacetime, title = "Parent Length by Cross Type: Gilmour")
# paddy_parents_paired_14_16_cross_riverdist_length <- parents_paired_cross_riverdist_length(paddy_parents_paired_14_16_cross_riverdist_spacetime, title = "Parent Length by Cross Type: Paddy")
# erb_parents_paired_14_16_cross_riverdist_length <- parents_paired_cross_riverdist_length(erb_parents_paired_14_16_cross_riverdist_spacetime, title = "Parent Length by Cross Type: Erb")
```
**Results:**

1. Stockdale -- no trend
2. Hogan -- bigger fish may tend to mate with bigger fish but nothing really stands out
3. Gilmour -- TBD
4. Paddy -- TBD
5. Erb -- TBD


## When
When were Dams and Sires that mated together sampled? We would expected that they would be sampled within the same time frame.
```{r}
parents_paired_cross_riverdist_date <- function(indata_date = stock_parents_paired_14_16_cross_riverdist_spacetime) {
  indata_date %>% 
  ggplot(aes(x = sample_date.sire, y = sample_date.dam)) +
  geom_jitter(aes(colour = cross, size = n), alpha = 0.5) +
  geom_abline(slope = 1) +
  theme_bw() +
  ggtitle("Sampled Date by Cross Type") +
  xlab("Sire Date") +
  ylab("Dam Date") +
  labs(size = "RS", 
       colour = "Parent: Cross Type") +
  theme(text = element_text(size = 20))
}

(stock_parents_paired_14_16_cross_riverdist_date <- parents_paired_cross_riverdist_date())
(hogan_parents_paired_14_16_cross_riverdist_date <- parents_paired_cross_riverdist_date(hogan_parents_paired_14_16_cross_riverdist_spacetime))
# gilmour_parents_paired_14_16_cross_riverdist_when <- parents_paired_cross_riverdist_when(gilmour_parents_paired_14_16_cross_riverdist_spacetime)
# paddy_parents_paired_14_16_cross_riverdist_when <- parents_paired_cross_riverdist_when(paddy_parents_paired_14_16_cross_riverdist_spacetime)
# erb_parents_paired_14_16_cross_riverdist_when <- parents_paired_cross_riverdist_when(erb_parents_paired_14_16_cross_riverdist_spacetime)
```
**Results:**

1. Stockdale -- females were sampled later on average than males likely due to earlier run timing in males
2. Hogan -- females and males were sampled about the same on average, although there was maybe some variability among the cross types
3. Gilmour -- TBD
4. Paddy -- TBD
5. Erb -- TBD


## Where
Where were Dams and Sires that mated sampled? We would expected that they would be sampled within the same area.
```{r}
parents_paired_cross_riverdist_location <- function(indata_location = stock_parents_paired_14_16_cross_riverdist_spacetime) {
  indata_location %>% 
  ggplot(aes(x = distance.sire, y = distance.dam), alpha = 0.05) +
  geom_jitter(aes(colour = cross, size = n), alpha = 0.5) +
  geom_abline(slope = 1)+
  theme_bw() +
  ggtitle("Distance from Stream Mouth by Cross Type") +
  xlab("Sire Distance (m)") +
  ylab("Dam Distance(m)") +
  labs(size = "RS", 
       colour = "Parent: Cross Type") +
  theme(text = element_text(size = 20))  
}

(stock_parents_paired_14_16_cross_riverdist_location <- parents_paired_cross_riverdist_location())
(hogan_parents_paired_14_16_cross_riverdist_location <- parents_paired_cross_riverdist_location(hogan_parents_paired_14_16_cross_riverdist_spacetime))
# gilmour_parents_paired_14_16_cross_riverdist_location <- parents_paired_cross_riverdist_location(gilmour_parents_paired_14_16_cross_riverdist_spacetime)
# paddy_parents_paired_14_16_cross_riverdist_location <- parents_paired_cross_riverdist_location(paddy_parents_paired_14_16_cross_riverdist_spacetime)
# erb_parents_paired_14_16_cross_riverdist_location <- parents_paired_cross_riverdist_location(erb_parents_paired_14_16_cross_riverdist_spacetime)
```
**Results:** 

1. Stockdale -- dams and sires were found in generally the same area
2. Hogan -- dams tended to be found further upstream on average than males
3. Gilmour -- TBD
4. Paddy -- TBD
5. Erb -- TBD


# Parent-offspring analyses

## Who

### Offspring, dam, and sire relationships
```{r}
# dyad relationships - one row per offspring
stock_parents_paired_14_16 <- read_csv("../Stockdale/stock_parents_paired_14_16.csv") %>% 
     mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery")))
hogan_parents_paired_14_16 <- read_csv("../Hogan/hogan_parents_paired_14_16.csv") %>% 
     mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery")))
gilmour_parents_paired_14_16 <- read_csv("../Gilmour/gilmour_parents_paired_14_16.csv") %>%
     mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery")))
# paddy_parents_paired_14_16 <- read_csv("../Paddy/paddy_parents_paired_14_16.csv") %>% 
#      mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery")))
# erb_parents_paired_14_16 <- read_csv("../Erb/erb_parents_paired_14_16.csv") %>% 
#      mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery")))

# Read in paired data
stock_OceanAK_paired <- read_csv("../Franz/stockdale_postQA_OceanAK_paired_2014_2016_STOCK.csv")
hogan_OceanAK_paired <- read_csv("../Franz/hogan_postQA_OceanAK_paired_2014_2016_HOGAN.csv")
gilmour_OceanAK_paired <- read_csv("../Franz/Gilmour_14_16_postQA_OceanAK_paired_2014_2016_GILMOUR.csv")
# paddy_OceanAK_paired <- read_csv("../Franz/Paddy_14_16_postQA_OceanAK_paired_2014_2016_PADDY.csv")
# erb_OceanAK_paired <- read_csv("../Franz/Erb_14_16_postQA_OceanAK_paired_2014_2016_ERB.csv")

OceanAK_paired <- function(indata_OceanAK_paired = stock_OceanAK_paired) {
   indata_OceanAK_paired %>% 
   select(franz_id, starts_with("Sample"), SILLY, `Fish ID`, starts_with("DNA"), SEX, `Length Mm`, `Otolith Mark Present`, `Otolith Mark ID`) %>% 
   rename(sample_id = "Sample ID", 
          Year = "Sample Year", 
          silly = "SILLY", 
          fish_id = "Fish ID", 
          dna_tray = "DNA Tray Code", 
          dna_well = "DNA Tray Well Code",
          Sex = "SEX",
          Length = "Length Mm") %>% 
   mutate(Origin = case_when(`Otolith Mark Present` == "YES" ~ "Hatchery",
                             `Otolith Mark Present` == "NO" ~ "Natural")) %>% 
   mutate(Origin = factor(x = Origin, levels = c("Natural", "Hatchery")))
}         

stock_OceanAK_paired_14_16 <- OceanAK_paired()
hogan_OceanAK_paired_14_16 <- OceanAK_paired(hogan_OceanAK_paired)
gilmour_OceanAK_paired_14_16 <- OceanAK_paired(gilmour_OceanAK_paired)
# paddy_OceanAK_paired_14_16 <- OceanAK_paired(paddy_OceanAK_paired)
# erb_OceanAK_paired_14_16 <- OceanAK_paired(erb_OceanAK_paired)

# Get offspring, dam, sire relationships and join
ods_relationships <- function(indata_ods = stock_parents_paired_14_16) {
  offspring_sire <- indata_ods %>% 
    filter(SEX.par == "M") %>% 
    select(Offspring, Parent_ID)

  offspring_dam <- indata_ods %>% 
    filter(SEX.par == "F") %>% 
    select(Offspring, Parent_ID)

  offspring_dam_sire <- offspring_dam %>% 
    full_join(offspring_sire, by = "Offspring", suffix = c(".dam", ".sire"))
}

stock_offspring_dam_sire_14_16 <- ods_relationships()
hogan_offspring_dam_sire_14_16 <- ods_relationships(hogan_parents_paired_14_16)
gilmour_offspring_dam_sire_14_16 <- ods_relationships(gilmour_parents_paired_14_16)
# paddy_offspring_dam_sire_14_16 <- ods_relationships(paddy_parents_paired_14_16)
# erb_offspring_dam_sire_14_16 <- ods_relationships(erb_parents_paired_14_16)

# Join back paired data to offspring, dam, and sire
parents_paired_dam_sire <- function(indata_ods2 = stock_offspring_dam_sire_14_16, indata_OceanAK_paired2 = stock_OceanAK_paired_14_16) {
  indata_ods2 %>% 
  left_join(indata_OceanAK_paired2, by = c("Offspring" = "franz_id")) %>% 
  left_join(indata_OceanAK_paired2, by = c("Parent_ID.dam" = "franz_id"), suffix = c(".off", "")) %>% 
  left_join(indata_OceanAK_paired2, by = c("Parent_ID.sire" = "franz_id"), suffix = c(".dam", ".sire")) %>% 
  mutate(DOY.off = yday(`Sample Date.off`),
         DOY.dam = yday(`Sample Date.dam`),
         DOY.sire = yday(`Sample Date.sire`))
}

(stock_parents_paired_14_16_dam_sire <- parents_paired_dam_sire())
(hogan_parents_paired_14_16_dam_sire <- parents_paired_dam_sire(hogan_offspring_dam_sire_14_16, hogan_OceanAK_paired_14_16))

(gilmour_parents_paired_14_16_dam_sire <- gilmour_offspring_dam_sire_14_16 %>% 
  left_join(gilmour_OceanAK_paired_14_16, by = c("Offspring" = "franz_id")) %>% 
  left_join(gilmour_OceanAK_paired_14_16, by = c("Parent_ID.dam" = "franz_id"), suffix = c(".off", "")) %>% 
  left_join(gilmour_OceanAK_paired_14_16, by = c("Parent_ID.sire" = "franz_id"), suffix = c(".dam", ".sire")) %>% 
  mutate(date.off = dmy(`Sample Date.off`),
         date.dam = dmy(`Sample Date.dam`),
         date.sire = dmy(`Sample Date.sire`)) %>% 
  mutate(DOY.off = yday(date.off),
         DOY.dam = yday(date.dam),
         DOY.sire = yday(date.sire)))

# (paddy_parents_paired_14_16_dam_sire <- parents_paired_dam_sire(paddy_offspring_dam_sire_14_16, paddy_OceanAK_paired_14_16))
# (erb_parents_paired_14_16_dam_sire <- parents_paired_dam_sire(erb_offspring_dam_sire_14_16, erb_OceanAK_paired_14_16))
```

### Triads - used for remaining analyses
```{r}
triads <- function(indata_triads = stock_parents_paired_14_16_dam_sire) {
  indata_triads %>% 
  filter(!is.na(Parent_ID.dam) & !is.na(Parent_ID.sire)) 
}

(stock_triads <- triads())
(hogan_triads <- triads(hogan_parents_paired_14_16_dam_sire))
(gilmour_triads <- triads(gilmour_parents_paired_14_16_dam_sire))
# (paddy_triads <- triads(paddy_parents_paired_14_16_dam_sire))
# (erb_triads <- triads(erb_parents_paired_14_16_dam_sire))
```


## Body Length

### Correlation between parent-offspring body length
```{r, fig.width=10}
parents_paired_length <- function(indata_parents_paired_length = stock_parents_paired_14_16) {
  indata_parents_paired_length %>% 
  rename(length.par = "Length Mm.par", 
         length.off = "Length Mm.off") %>% 
  drop_na(length.par, length.off) %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Female",
                             SEX.par == "M" ~ "Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Female",
                             SEX.off == "M" ~ "Male")) %>% 
  group_by(sex.par, sex.off, origin) %>%
  summarise(correlation = round(cor(length.off, length.par), 3), r2 = round(cor(length.off, length.par)^2, 3)) 
}

parents_paired_length_graph <- function(indata_parents_paired_length_graph = stock_parents_paired_14_16, title = "Stockdale_14_16\n\nRegression of Body Length") {
  indata_parents_paired_length_graph %>% 
  rename(length.par = "Length Mm.par", 
         length.off = "Length Mm.off") %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Parent: Female",
                             SEX.par == "M" ~ "Parent: Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Offspring: Female",
                             SEX.off == "M" ~ "Offspring: Male")) %>% 
  group_by(sex.par, sex.off) %>%
  ggplot(aes(x = length.par, y = length.off, colour = origin.par)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.par) +
  labs(title = title,  colour = "Parent: Origin") +
  xlab("Parent Length (mm)") +
  ylab("Offspring Length (mm)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

(stock_parents_paired2_14_16_length_graph <- parents_paired_length_graph())
(stock_parents_paired2_14_16_length <- parents_paired_length())

(hogan_parents_paired2_14_16_length_graph <- parents_paired_length_graph(hogan_parents_paired_14_16, title = "Hogan_14_16\n\nRegression of Body Length"))
(hogan_parents_paired2_14_16_length <- parents_paired_length(hogan_parents_paired_14_16))

(gilmour_parents_paired2_14_16_length_graph <- parents_paired_length_graph(gilmour_parents_paired_14_16, title = "Gilmour_14_16\n\nRegression of Body Length"))
(gilmour_parents_paired2_14_16_length <- parents_paired_length(gilmour_parents_paired_14_16))

# (paddy_parents_paired2_14_16_length_graph <- parents_paired_length_graph(paddy_parents_paired_14_16, title = "Paddy_14_16\n\nRegression of Body Length"))
# (paddy_parents_paired2_14_16_length <- parents_paired_length(paddy_parents_paired_14_16))

# (erb_parents_paired2_14_16_length_graph <- parents_paired_length_graph(erb_parents_paired_14_16, title = "Erb_14_16\n\nRegression of Body Length"))
# (erb_parents_paired2_14_16_length <- parents_paired_length(erb_parents_paired_14_16))
```

**Results:**

1. Stockdale -- slight positive trend but low correlation between parent and offspring body lengths 
2. Hogan -- slight positive trend but low correlation between parent and offspring body lengths, except between female parents and male offspring (no trend)
3. Gilmour -- slight positive trend but generally low correlations except between a hatchery female parents and natural male parents and offspring
4. Paddy -- TBD
5. Erb -- TBD

### Narrow-sense heritability of body length
For traits associated with fitness in natural populations, heritability is typically 0.1–0.2 (Wray and Visscher 2008 [https://www.nature.com/scitable/topicpage/estimating-trait-heritability-46889/] per Visscher et al. 2008). We estimate narrow-sense heritability here, as well as for location and sample date, from r = √(½)h^2.
```{r, fig.width=10}
# mid-parent trait values and cross info
triads_length <- function(indata_triads_length = stock_triads) {
  indata_triads_length %>%
  mutate(Length.par = (Length.dam + Length.sire) / 2) %>% 
  mutate(Cross = case_when(Origin.dam == "Natural" & Origin.sire == "Natural" ~ "NN",
                           Origin.dam == "Natural" & Origin.sire == "Hatchery" ~ "NH",
                           Origin.dam == "Hatchery" & Origin.sire == "Natural" ~ "HN",
                           Origin.dam == "Hatchery" & Origin.sire == "Hatchery" ~ "HH"))
}

stock_triads_length <- triads_length()
hogan_triads_length <- triads_length(hogan_triads)
gilmour_triads_length <- triads_length(gilmour_triads)
# paddy_triads_length <- triads_length(paddy_triads)
# erb_triads_length <- triads_length(erb_triads)

# scatterplot
h2_length_graph <- function(indata_h2_length_graph = stock_triads_length, title = "Stockdale_14_16\n\nHeritability of Body Length - Parent Pair") {
  indata_h2_length_graph %>% 
  ggplot(aes(x = Length.par, y = Length.off, colour = Cross)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = title, colour = "Parent: Origin") +
  xlab("Mid-parent Length (mm)") +
  ylab("Offspring Length (mm)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# correlation
r_for_h2_length <- function(indata_r_for_h2_length = stock_triads_length) {
  as.tibble(c((coef(lm(Length.off ~ Length.par, data = indata_r_for_h2_length))[2]),
              (coef(lm(Length.off ~ Length.par, data = indata_r_for_h2_length %>% filter(Cross == "NN")))[2]),
              (coef(lm(Length.off ~ Length.par, data = indata_r_for_h2_length %>% filter(Cross == "NH")))[2]),
              (coef(lm(Length.off ~ Length.par, data = indata_r_for_h2_length %>% filter(Cross == "HN")))[2]),
              (coef(lm(Length.off ~ Length.par, data = indata_r_for_h2_length %>% filter(Cross == "HH")))[2])))}

stock_r_for_h2_length <- round(r_for_h2_length(), 3) 
hogan_r_for_h2_length <- round(r_for_h2_length(hogan_triads_length), 3)
gilmour_r_for_h2_length <- round(r_for_h2_length(gilmour_triads_length), 3)
# paddy_r_for_h2_length <- round(r_for_h2_length(paddy_triads_length), 3)
# erb_r_for_h2_length <- round(r_for_h2_length(erb_triads_length), 3)

# heritability (from r = √(½)h^2)
stock_h2_length <- lapply(stock_r_for_h2_length, function(r) r*r*2) 
hogan_h2_length <- lapply(hogan_r_for_h2_length, function(r) r*r*2) 
gilmour_h2_length <- lapply(gilmour_r_for_h2_length, function(r) r*r*2)
# paddy_h2_length <- lapply(paddy_r_for_h2_length, function(r) r*r*2) 
# erb_h2_length <- lapply(erb_r_for_h2_length, function(r) r*r*2)

# tables of correlations and heritabilities
h2_length_graph()
stock_r_and_h2_length <- as.data.frame(cbind(stock_r_for_h2_length, stock_h2_length)) %>% round(3)
colnames(stock_r_and_h2_length) <- c("Correlation (r)", "Heritability (h^2)")
rownames(stock_r_and_h2_length) <- c("Stockdale_14_16 Overall", "NN", "NH", "HN", "HH")
stock_r_and_h2_length

h2_length_graph(hogan_triads_length, title = "Hogan_14_16\n\nHeritability of Body Length - Parent Pair")
hogan_r_and_h2_length <- as.data.frame(cbind(hogan_r_for_h2_length, hogan_h2_length)) %>% round(3)
colnames(hogan_r_and_h2_length) <- c("Correlation (r)", "Heritability (h^2)")
rownames(hogan_r_and_h2_length) <- c("Hogan_14_16 Overall", "NN", "NH", "HN", "HH")
hogan_r_and_h2_length

h2_length_graph(gilmour_triads_length, title = "Gilmour_14_16\n\nHeritability of Body Length - Parent Pair")
gilmour_r_and_h2_length <- as.data.frame(cbind(gilmour_r_for_h2_length, gilmour_h2_length)) %>% round(3)
colnames(gilmour_r_and_h2_length) <- c("Correlation (r)", "Heritability (h^2)")
rownames(gilmour_r_and_h2_length) <- c("Gilmour_14_16 Overall", "NN", "NH", "HN", "HH")
gilmour_r_and_h2_length

# h2_length_graph(paddy_triads_length, title = "Paddy_14_16\n\nHeritability of Body Length - Parent Pair")
# paddy_r_and_h2_length <- as.data.frame(cbind(paddy_r_for_h2_length, paddy_h2_length)) %>% round(3)
# colnames(paddy_r_and_h2_length) <- c("Correlation (r)", "Heritability (h^2)")
# rownames(paddy_r_and_h2_length) <- c("Paddy_14_16 Overall", "NN", "NH", "HN", "HH")
# paddy_r_and_h2_length
# 
# h2_length_graph(erb_triads_length, title = "Erb_14_16\n\nHeritability of Body Length - Parent Pair")
# erb_r_and_h2_length <- as.data.frame(cbind(erb_r_for_h2_length, erb_h2_length)) %>% round(3)
# colnames(erb_r_and_h2_length) <- c("Correlation (r)", "Heritability (h^2)")
# rownames(erb_r_and_h2_length) <- c("Erb_14_16 Overall", "NN", "NH", "HN", "HH")
# erb_r_and_h2_length
```

**Results:**

1. Stockdale -- heritability of body length is low except for the HH cross type, which had the fewest number of samples
2. Hogan -- made no sense again; sample size too small
3. Gilmour -- heritability of body length high for NN and especially HN cross types
4. Paddy -- TBD
5. Erb -- TBD


## When

### Correlation between parent-offspring sample dates
```{r, fig.width=10}
parents_paired_date <- function(indata_parents_paired_date = stock_parents_paired_14_16) {
  indata_parents_paired_date %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Female",
                             SEX.par == "M" ~ "Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Female",
                             SEX.off == "M" ~ "Male")) %>% 
  mutate(DOY.par = yday(date.par)) %>% 
  mutate(DOY.off = yday(date.off)) %>% 
  group_by(sex.par, sex.off, origin) %>%
  summarise(correlation = round(cor(DOY.off, DOY.par), 3), r2 = round(cor(DOY.off, DOY.par)^2, 3)) 
}

parents_paired_date_graph <- function(indata_parents_paired_date_graph = stock_parents_paired_14_16, title = "Stockdale_14_16\n\nRegression of Sample Date") {
  indata_parents_paired_date_graph %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Parent: Female",
                             SEX.par == "M" ~ "Parent: Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Offspring: Female",
                             SEX.off == "M" ~ "Offspring: Male")) %>% 
  group_by(sex.par, sex.off) %>%
  ggplot(aes(x = DOY.par, y = DOY.off, colour = origin.par)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.par) +
  labs(title = title,  colour = "Parent: Origin") +
  xlab("Parent Sample Date (DOY)") +
  ylab("Offspring Sample Date (DOY)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

parents_paired_date_graph()
(stock_parents_paired_14_16_date <- parents_paired_date())

parents_paired_date_graph(hogan_parents_paired_14_16, title = "Hogan_14_16\n\nRegression of Sample Date")
(hogan_parents_paired_14_16_date <- parents_paired_date(hogan_parents_paired_14_16))

parents_paired_date_graph(gilmour_parents_paired_14_16, title = "Gilmour_14_16\n\nRegression of Sample Date")
(gilmour_parents_paired_14_16_date <- parents_paired_date(gilmour_parents_paired_14_16))

# parents_paired_date_graph(paddy_parents_paired_14_16, title = "Paddy_14_16\n\nRegression of Sample Date")
# (paddy_parents_paired2_14_16_date <- parents_paired_date(paddy_parents_paired_14_16))

# parents_paired_date_graph(erb_parents_paired_14_16, title = "Erb_14_16\n\nRegression of Sample Date")
# (erb_parents_paired_14_16_date <- parents_paired_date(erb_parents_paired_14_16))
```

**Results:**

1. Stockdale -- higher correlation between parent and offspring sample date for natural vs hatchery fish of both sexes
2. Hogan -- higher correlation between parent and offspring sample date for natural vs hatchery fish of both sexes except male parents with female offspring
3. Gilmour -- higher correlation between parent and offspring sample date for natural vs hatchery fish of both sexes except male parents with female offspring
4. Paddy -- TBD
5. Erb -- TBD

### Narrow-sense heritability of sample date
For traits associated with fitness in natural populations, heritability is typically 0.1–0.2 (Wray and Visscher 2008 [https://www.nature.com/scitable/topicpage/estimating-trait-heritability-46889/] per Visscher et al. 2008). We estimate narrow-sense heritability here, as well as for location and body length, from r = √(½)h^2.
```{r, fig.width=10}
# mid-parent trait values and cross info
triads_date <- function(indata_triads_date = stock_triads) {
  indata_triads_date %>%
  mutate(DOY.par = (DOY.dam + DOY.sire) / 2) %>% 
  mutate(Cross = case_when(Origin.dam == "Natural" & Origin.sire == "Natural" ~ "NN",
                           Origin.dam == "Natural" & Origin.sire == "Hatchery" ~ "NH",
                           Origin.dam == "Hatchery" & Origin.sire == "Natural" ~ "HN",
                           Origin.dam == "Hatchery" & Origin.sire == "Hatchery" ~ "HH"))
}

stock_triads_date <- triads_date()
hogan_triads_date <- triads_date(hogan_triads)
gilmour_triads_date <- triads_date(gilmour_triads)
# paddy_triads_date <- triads_date(paddy_triads)
# erb_triads_date <- triads_date(erb_triads)

# scatterplot
h2_date_graph <- function(indata_h2_date_graph = stock_triads_date, title = "Stockdale_14_16\n\nHeritability of Sample Date - Parent Pair") {
  indata_h2_date_graph %>% 
  ggplot(aes(x = DOY.par, y = DOY.off, colour = Cross)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = title, colour = "Parent: Origin") +
  xlab("Mid-parent Sample Date (DOY)") +
  ylab("Offspring Sample Date (DOY)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# correlation
r_for_h2_date <- function(indata_r_for_h2_date = stock_triads_date) {
  as.tibble(c((coef(lm(DOY.off ~ DOY.par, data = indata_r_for_h2_date))[2]),
              (coef(lm(DOY.off ~ DOY.par, data = indata_r_for_h2_date %>% filter(Cross == "NN")))[2]),
              (coef(lm(DOY.off ~ DOY.par, data = indata_r_for_h2_date %>% filter(Cross == "NH")))[2]),
              (coef(lm(DOY.off ~ DOY.par, data = indata_r_for_h2_date %>% filter(Cross == "HN")))[2]),
              (coef(lm(DOY.off ~ DOY.par, data = indata_r_for_h2_date %>% filter(Cross == "HH")))[2])))}

stock_r_for_h2_date <- round(r_for_h2_date(), 3) 
hogan_r_for_h2_date <- round(r_for_h2_date(hogan_triads_date), 3)
gilmour_r_for_h2_date <- round(r_for_h2_date(gilmour_triads_date), 3)
# paddy_r_for_h2_date <- round(r_for_h2_date(paddy_triads_date), 3)
# erb_r_for_h2_date <- round(r_for_h2_date(erb_triads_date), 3)

# heritability (from r = √(½)h^2)
stock_h2_date <- lapply(stock_r_for_h2_date, function(r) r*r*2) 
hogan_h2_date <- lapply(hogan_r_for_h2_date, function(r) r*r*2) 
gilmour_h2_date <- lapply(gilmour_r_for_h2_date, function(r) r*r*2)
# paddy_h2_date <- lapply(paddy_r_for_h2_date, function(r) r*r*2) 
# erb_h2_date <- lapply(erb_r_for_h2_date, function(r) r*r*2)

# tables of correlations and heritabilities
h2_date_graph()
stock_r_and_h2_date <- as.data.frame(cbind(stock_r_for_h2_date, stock_h2_date)) %>% round(3)
colnames(stock_r_and_h2_date) <- c("Correlation (r)", "Heritability (h^2)")
rownames(stock_r_and_h2_date) <- c("Stockdale_14_16 Overall", "NN", "NH", "HN", "HH")
stock_r_and_h2_date

h2_date_graph(hogan_triads_date, title = "Hogan_14_16\n\nHeritability of Sample Date - Parent Pair")
hogan_r_and_h2_date <- as.data.frame(cbind(hogan_r_for_h2_date, hogan_h2_date)) %>% round(3)
colnames(hogan_r_and_h2_date) <- c("Correlation (r)", "Heritability (h^2)")
rownames(hogan_r_and_h2_date) <- c("Hogan_14_16 Overall", "NN", "NH", "HN", "HH")
hogan_r_and_h2_date

h2_date_graph(gilmour_triads_date, title = "Gilmour_14_16\n\nHeritability of Sample Date - Parent Pair")
gilmour_r_and_h2_date <- as.data.frame(cbind(gilmour_r_for_h2_date, gilmour_h2_date)) %>% round(3)
colnames(gilmour_r_and_h2_date) <- c("Correlation (r)", "Heritability (h^2)")
rownames(gilmour_r_and_h2_date) <- c("Gilmour_14_16 Overall", "NN", "NH", "HN", "HH")
gilmour_r_and_h2_date

# h2_date_graph(paddy_triads_date, title = "Paddy_14_16\n\nHeritability of Sample Date - Parent Pair")
# paddy_r_and_h2_date <- as.data.frame(cbind(paddy_r_for_h2_date, paddy_h2_date)) %>% round(3)
# colnames(paddy_r_and_h2_date) <- c("Correlation (r)", "Heritability (h^2)")
# rownames(paddy_r_and_h2_date) <- c("Paddy_14_16 Overall", "NN", "NH", "HN", "HH")
# paddy_r_and_h2_date
# 
# h2_date_graph(erb_triads_date, title = "Erb_14_16\n\nHeritability of Sample Date - Parent Pair")
# erb_r_and_h2_date <- as.data.frame(cbind(erb_r_for_h2_date, erb_h2_date)) %>% round(3)
# colnames(erb_r_and_h2_date) <- c("Correlation (r)", "Heritability (h^2)")
# rownames(erb_r_and_h2_date) <- c("Erb_14_16 Overall", "NN", "NH", "HN", "HH")
# erb_r_and_h2_date
```

**Results:**

1. Stockdale -- heritability of sample date (run time) is very high in NN crosses, moderately so in HN crosses, and below 0.1 otherwise, but sample size is somewhat low for the HH cross
2. Hogan -- all over the place and ridiculous because sample sizes are too small
3. Gilmour -- strong heritabilities across the board for sample date, with pretty good sample sizes
4. Paddy -- TBD
5. Erb -- TBD


## Where

### Correlation between parent-offspring sample location
Location is reported as distance from stream mouth. 
```{r, fig.width=10}



```

**Results:**

1. Stockdale -- 
2. Hogan -- 
3. Gilmour
4. Paddy -- TBD
5. Erb -- TBD


### Narrow-sense heritability of sample location
For traits associated with fitness in natural populations, heritability is typically 0.1–0.2 (Wray and Visscher 2008 [https://www.nature.com/scitable/topicpage/estimating-trait-heritability-46889/] per Visscher et al. 2008). We estimate narrow-sense heritability here, as well as for sample date and body length, from r = √(½)h^2.
```{r, fig.width=10}



```

**Results:**

1. Stockdale -- 
2. Hogan -- 
3. Gilmour
4. Paddy -- TBD
5. Erb -- TBD

## Fitness

### Narrow-sense heritability of RS
```{r, fig.width=10}



```

**Results:**

1. Stockdale -- 
2. Hogan -- 
3. Gilmour
4. Paddy -- TBD
5. Erb -- TBD
