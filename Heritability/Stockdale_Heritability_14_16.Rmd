---
title: "Heritability of body length, sample date, location, and RS according to Cross Type and Parental/Offspring Sex for Stockdale 2014-2016"
author: "Kristen Gruenthal"
date: "13 January 2022"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# **INTRODUCTION**

The purpose of these analyses are to more fully explore the parent-pair offspring trio/triad data (i.e. cross data) for Stockdale Creek 2014-2016 in terms of spatiotemporal patterning and generate preliminary estimates of narrow-sense heritability using regression slope analysis.

```{r setup, include=FALSE}
rm(list=ls())

library(coin)
library(MASS)
library(scales)
library(tidyverse)
library(leaflet)
library(lubridate)
library(ggExtra)
library(gridExtra)
library(MuMIn)
library(GGally)
library(gganimate)
library(broom)
library(tidyr)
library(purrr)
library(gremlin)
library(nadiv)

knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.width = 10)
```

# **WHO**

Who are the two-parents, both dam and sire, for each cross type offspring and where were they sampled?

```{r, echo=FALSE, warning=FALSE, message=FALSE}
stock_riverdist_14_16 <- read_csv("../../GIS/R/stockdale/stockdale_distances.csv") %>% 
  mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
                                dist2tide <= 0 ~ "Intertidal")) %>% 
  rename(Distance = mouthdist, Segment = seg)

stock_parents_paired_14_16_cross <- read_csv("../Stockdale/stock_parents_paired_14_16_cross.csv")

# organize by sire and dam, join riverdist data
parents_paired_cross_riverdist_spacetime <- function(indata_spacetime = stock_parents_paired_14_16_cross, indata_riverdist = stock_riverdist_14_16) {
  indata_spacetime %>% 
  count(cross, `Fish ID`, `Fish ID.par1`, `Sample Date`, `Sample Date.par1`, SEX, SEX.par1, `DNA Tray Code`, `DNA Tray Code.par1`, `DNA Tray Well Code`, `DNA Tray Well Code.par1`, origin.par1, origin, `Length Mm.par1`, `Length Mm`) %>% 
  rename(`Fish ID.par2` = `Fish ID`, 
         `Sample Date.par2` = `Sample Date`,
         SEX.par2 = SEX,
         `DNA Tray Code.par2` = `DNA Tray Code`,
         `DNA Tray Well Code.par2` = `DNA Tray Well Code`,
         origin.par2 = origin,
         `Length Mm.par2` = `Length Mm`) %>% 
  unite(Sample.par1, c("DNA Tray Code.par1", "DNA Tray Well Code.par1"), sep = "_", remove = TRUE) %>% 
  unite(Sample.par2, c("DNA Tray Code.par2", "DNA Tray Well Code.par2"), sep = "_", remove = TRUE) %>% 
  left_join(indata_riverdist, by = c("Sample.par1" = "Sample")) %>% 
  left_join(indata_riverdist, by = c("Sample.par2" = "Sample"), suffix = c(".par1", ".par2")) %>% 
  mutate(fish_id.sire = case_when(SEX.par1 == "M" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(fish_id.dam = case_when(SEX.par1 == "F" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(sample_date.sire = case_when(SEX.par1 == "M" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sample_date.dam = case_when(SEX.par1 == "F" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sex.sire = case_when(SEX.par1 == "M" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>% 
  mutate(sex.dam = case_when(SEX.par1 == "F" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>%
  mutate(origin.sire = case_when(SEX.par1 == "M" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>% 
  mutate(origin.dam = case_when(SEX.par1 == "F" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>%
  mutate(distance.sire = case_when(SEX.par1 == "M" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>% 
  mutate(distance.dam = case_when(SEX.par1 == "F" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>%
  mutate(intertidal.sire = case_when(SEX.par1 == "M" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>% 
  mutate(intertidal.dam = case_when(SEX.par1 == "F" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>%
  mutate(length.sire = case_when(SEX.par1 == "M" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>% 
  mutate(length.dam = case_when(SEX.par1 == "F" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>%
  select(cross, n, ends_with(".sire"), ends_with(".dam"))
}

(stock_parents_paired_14_16_cross_riverdist_spacetime <- parents_paired_cross_riverdist_spacetime())
```

## Offspring, dam, and sire relationships - dyads and triads

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# dyad relationships - one row per offspring
stock_parents_paired_14_16 <- read_csv("../Stockdale/stock_parents_paired_14_16.csv") %>% 
  mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery"))) %>% 
  filter(`Length Mm.par` > 300)

# Read in paired data
stock_postQA_OceanAK_paired_14_16 <- read_csv("../Franz/stockdale_postQA_OceanAK_paired_2014_2016_STOCK.csv")

OceanAK_paired <- function(indata_OceanAK_paired = stock_postQA_OceanAK_paired_14_16) {
   indata_OceanAK_paired %>% 
   select(franz_id, starts_with("Sample"), SILLY, `Fish ID`, starts_with("DNA"), SEX, `Length Mm`, `Otolith Mark Present`, `Otolith Mark ID`) %>% 
   rename(sample_id = "Sample ID", 
          Year = "Sample Year", 
          silly = "SILLY", 
          fish_id = "Fish ID", 
          dna_tray = "DNA Tray Code", 
          dna_well = "DNA Tray Well Code",
          Sex = "SEX",
          Length = "Length Mm") %>% 
   mutate(Origin = case_when(`Otolith Mark Present` == "YES" ~ "Hatchery",
                             `Otolith Mark Present` == "NO" ~ "Natural")) %>% 
   mutate(Origin = factor(x = Origin, levels = c("Natural", "Hatchery")))
}         

stock_OceanAK_paired_14_16 <- OceanAK_paired()

# Get offspring, dam, sire relationships and join
ods_relationships <- function(indata_ods = stock_parents_paired_14_16) {
  offspring_sire <- indata_ods %>% 
    filter(SEX.par == "M") %>% 
    select(Offspring, Parent_ID)

  offspring_dam <- indata_ods %>% 
    filter(SEX.par == "F") %>% 
    select(Offspring, Parent_ID)

  offspring_dam_sire <- offspring_dam %>% 
    full_join(offspring_sire, by = "Offspring", suffix = c(".dam", ".sire"))
}

stock_offspring_dam_sire_14_16 <- ods_relationships()

# Join back paired data to offspring, dam, and sire
parents_paired_dam_sire <- function(indata_ods2 = stock_offspring_dam_sire_14_16, indata_OceanAK_paired2 = stock_OceanAK_paired_14_16) {
  indata_ods2 %>% 
  left_join(indata_OceanAK_paired2, by = c("Offspring" = "franz_id")) %>% 
  left_join(indata_OceanAK_paired2, by = c("Parent_ID.dam" = "franz_id"), suffix = c(".off", "")) %>% 
  left_join(indata_OceanAK_paired2, by = c("Parent_ID.sire" = "franz_id"), suffix = c(".dam", ".sire")) %>% 
  mutate(DOY.off = yday(`Sample Date.off`),
         DOY.dam = yday(`Sample Date.dam`),
         DOY.sire = yday(`Sample Date.sire`))
}

(stock_parents_paired_14_16_dam_sire <- parents_paired_dam_sire())
```

## Triads - used for remaining analyses

```{r, echo=FALSE, warning=FALSE, message=FALSE}
triads <- function(indata_triads = stock_parents_paired_14_16_dam_sire) {
  indata_triads %>% 
  filter(!is.na(Parent_ID.dam) & !is.na(Parent_ID.sire)) 
}

(stock_triads_14_16 <- triads())
```

# **HERITABILITY**

For traits associated with fitness in natural populations, heritability is typically 0.1--0.2 (Wray and Visscher 2008 [<https://www.nature.com/scitable/topicpage/estimating-trait-heritability-46889/>] per Visscher et al. 2008).

## Body Length

```{r}
# mid-parent trait values and cross info
triads_length <- function(indata_triads_length = stock_triads_14_16) {
  indata_triads_length %>%
  mutate(Length.par = (Length.dam + Length.sire) / 2) %>% 
  mutate(Cross = case_when(Origin.dam == "Natural" & Origin.sire == "Natural" ~ "NN",
                           Origin.dam == "Natural" & Origin.sire == "Hatchery" ~ "NH",
                           Origin.dam == "Hatchery" & Origin.sire == "Natural" ~ "HN",
                           Origin.dam == "Hatchery" & Origin.sire == "Hatchery" ~ "HH"))
}

stock_triads_length_14_16 <- triads_length()

write_csv(stock_triads_length_14_16, "stock_triads_length_14_16.csv")
```

### Scatterplots

```{r}
# overall
h2_length_graph <- function(indata_h2_length_graph = stock_triads_length_14_16, title = "Stockdale_14_16\n\nRegression of Body Length") {
  indata_h2_length_graph %>% 
  ggplot(aes(x = Length.par, y = Length.off)) +
  geom_abline(slope = 1) +
  geom_jitter(size = 2) +
  geom_smooth(method = "lm") +
  labs(title = title) +
  xlab("Mid-parent Length (mm)") +
  ylab("Offspring Length (mm)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# by cross
h2_length_graph_cross <- function(indata_h2_length_graph_cross = stock_triads_length_14_16, title = "Stockdale_14_16\n\nRegression of Body Length by Cross") {
  indata_h2_length_graph_cross %>% 
  ggplot(aes(x = Length.par, y = Length.off, colour = Cross)) +
  geom_abline(slope = 1) +
  geom_jitter(size = 2) +
  geom_smooth(method = "lm") +
  labs(title = title, colour = "Cross") +
  xlab("Mid-parent Length (mm)") +
  ylab("Offspring Length (mm)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# by sex
h2_length_graph_sex <- function(indata_parents_paired_length_graph = stock_parents_paired_14_16, title = "Stockdale_14_16\n\nRegression of Body Length by Sex") {
  indata_parents_paired_length_graph %>% 
  rename(length.par = "Length Mm.par", 
         length.off = "Length Mm.off") %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Dam",
                             SEX.par == "M" ~ "Sire")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Female",
                             SEX.off == "M" ~ "Male")) %>% 
  group_by(sex.par, sex.off) %>%
  ggplot(aes(x = length.par, y = length.off, colour = origin.par)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.par) +
  labs(title = title,  colour = "Parent Origin") +
  xlab("Parent Length (mm)") +
  ylab("Offspring Length (mm)") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

h2_length_graph()
h2_length_graph_cross()
h2_length_graph_sex()
```

### Correlation

We estimate narrow-sense heritability here, as well as for location and sample date, from r = √(½)h\^2.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
parents_paired_length <- function(indata_triads_length = stock_triads_length_14_16) {
  indata_triads_length %>% 
  drop_na(Length.par, Length.off) %>% 
  mutate(sex.dam = case_when(Sex.dam == "F" ~ "Female")) %>%
  mutate(sex.sire = case_when(Sex.sire == "M" ~ "Male")) %>%
  mutate(sex.off = case_when(Sex.off == "F" ~ "Female",
                             Sex.off == "M" ~ "Male")) 
}

# overall
stock_parents_paired_14_16_length0 <- parents_paired_length() %>% 
  summarise(correlation = round(cor(Length.off, Length.par), 3), r2 = round(cor(Length.off, Length.par)^2, 3))

# by cross
stock_parents_paired_14_16_length1 <- parents_paired_length() %>% 
  group_by(Cross) %>%
  summarise(correlation = round(cor(Length.off, Length.par), 3), r2 = round(cor(Length.off, Length.par)^2, 3))

# all offspring
stock_parents_paired_14_16_length4 <- parents_paired_length() %>% 
  group_by(sex.dam) %>%
  summarise(correlation = round(cor(Length.off, Length.dam), 3), r2 = round(cor(Length.off, Length.dam)^2, 3))

stock_parents_paired_14_16_length5 <- parents_paired_length() %>% 
  group_by(sex.sire) %>%
  summarise(correlation = round(cor(Length.off, Length.sire), 3), r2 = round(cor(Length.off, Length.sire)^2, 3))

# by sex
stock_parents_paired_14_16_length2 <- parents_paired_length() %>% 
  group_by(sex.dam, sex.off) %>%
  summarise(correlation = round(cor(Length.off, Length.dam), 3), r2 = round(cor(Length.off, Length.dam)^2, 3))

stock_parents_paired_14_16_length3 <- parents_paired_length() %>% 
  group_by(sex.sire, sex.off) %>%
  summarise(correlation = round(cor(Length.off, Length.sire), 3), r2 = round(cor(Length.off, Length.sire)^2, 3))

# make dfs
stock_parents_paired_14_16_length0_All <- as.data.frame(c(stock_parents_paired_14_16_length0[1,1], stock_parents_paired_14_16_length0[1,2]*2))
stock_parents_paired_14_16_length1_NN <- as.data.frame(c(stock_parents_paired_14_16_length1[4,2], stock_parents_paired_14_16_length1[4,3]*2))
stock_parents_paired_14_16_length1_NH <- as.data.frame(c(stock_parents_paired_14_16_length1[3,2], stock_parents_paired_14_16_length1[3,3]*2))
stock_parents_paired_14_16_length1_HN <- as.data.frame(c(stock_parents_paired_14_16_length1[2,2], stock_parents_paired_14_16_length1[2,3]*2))
stock_parents_paired_14_16_length1_HH <- as.data.frame(c(stock_parents_paired_14_16_length1[1,2], stock_parents_paired_14_16_length1[1,3]*2))
stock_parents_paired_14_16_length4_dAll <- as.data.frame(c(stock_parents_paired_14_16_length4[1,2], stock_parents_paired_14_16_length4[1,3]*2))
stock_parents_paired_14_16_length5_sAll <- as.data.frame(c(stock_parents_paired_14_16_length5[1,2], stock_parents_paired_14_16_length5[1,3]*2))
stock_parents_paired_14_16_length2_dF <- as.data.frame(c(stock_parents_paired_14_16_length2[1,3], stock_parents_paired_14_16_length2[1,4]*2))
stock_parents_paired_14_16_length2_dM <- as.data.frame(c(stock_parents_paired_14_16_length2[2,3], stock_parents_paired_14_16_length2[2,4]*2))
stock_parents_paired_14_16_length3_sF <- as.data.frame(c(stock_parents_paired_14_16_length3[1,3], stock_parents_paired_14_16_length3[1,4]*2))
stock_parents_paired_14_16_length3_sM <- as.data.frame(c(stock_parents_paired_14_16_length3[2,3], stock_parents_paired_14_16_length3[2,4]*2))

stock_r_and_h2_length_14_16 <- rbind(stock_parents_paired_14_16_length0_All,
                                     stock_parents_paired_14_16_length1_NN, 
                                     stock_parents_paired_14_16_length1_NH, 
                                     stock_parents_paired_14_16_length1_HN, 
                                     stock_parents_paired_14_16_length1_HH,
                                     stock_parents_paired_14_16_length4_dAll,
                                     stock_parents_paired_14_16_length5_sAll,
                                     stock_parents_paired_14_16_length2_dF, 
                                     stock_parents_paired_14_16_length2_dM, 
                                     stock_parents_paired_14_16_length3_sF, 
                                     stock_parents_paired_14_16_length3_sM) %>%
                                round(3)

colnames(stock_r_and_h2_length_14_16) <- c("Correlation (r)", "Heritability (h^2)")
stock_r_and_h2_length_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")

(stock_r_and_h2_length_14_16 <- stock_r_and_h2_length_14_16[,c(3,1,2)])
```

### Slope

If we use the parents' phenotypic variance as a measure of VP, we can estimate h\^2 by solving for: trait_value_offspring = Cov_parent_offspring / Var_parent x trait_value_parent + c. The slope of the line (number under "estimate" for "Length.\*" in the tibbles below) is mathematically equivalent to h\^2.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# overall
stock_h2_length_14_16_all_slope <- lm(Length.off ~ Length.par, data = stock_triads_length_14_16, na.action = na.omit)
stock_h2_length_14_16_all_slope_tbl <- tidy(stock_h2_length_14_16_all_slope)

# by cross
stock_h2_length_14_16_NN_slope <- lm(Length.off ~ Length.par, data = stock_triads_length_14_16 %>% filter(Cross == "NN"), na.action = na.omit)
stock_h2_length_14_16_NN_slope_tbl <- tidy(stock_h2_length_14_16_NN_slope)

stock_h2_length_14_16_NH_slope <- lm(Length.off ~ Length.par, data = stock_triads_length_14_16 %>% filter(Cross == "NH"), na.action = na.omit)
stock_h2_length_14_16_NH_slope_tbl <- tidy(stock_h2_length_14_16_NH_slope)

stock_h2_length_14_16_HN_slope <- lm(Length.off ~ Length.par, data = stock_triads_length_14_16 %>% filter(Cross == "HN"), na.action = na.omit)
stock_h2_length_14_16_HN_slope_tbl <- tidy(stock_h2_length_14_16_HN_slope)

stock_h2_length_14_16_HH_slope <- lm(Length.off ~ Length.par, data = stock_triads_length_14_16 %>% filter(Cross == "HH"), na.action = na.omit)
stock_h2_length_14_16_HH_slope_tbl <- tidy(stock_h2_length_14_16_HH_slope)

# all offspring
stock_h2_length_14_16_dam_slope <- lm(Length.off ~ Length.dam, data = stock_triads_length_14_16, na.action = na.omit)
stock_h2_length_14_16_dam_slope_tbl <- tidy(stock_h2_length_14_16_dam_slope)

stock_h2_length_14_16_sire_slope <- lm(Length.off ~ Length.sire, data = stock_triads_length_14_16, na.action = na.omit)
stock_h2_length_14_16_sire_slope_tbl <- tidy(stock_h2_length_14_16_sire_slope)

# by sex
stock_h2_length_14_16_dF_slope <- lm(Length.off ~ Length.dam, data = stock_triads_length_14_16 %>% filter(Sex.off == "F"), na.action = na.omit)
stock_h2_length_14_16_dF_slope_tbl <- tidy(stock_h2_length_14_16_dF_slope)

stock_h2_length_14_16_dM_slope <- lm(Length.off ~ Length.dam, data = stock_triads_length_14_16 %>% filter(Sex.off == "M"), na.action = na.omit)
stock_h2_length_14_16_dM_slope_tbl <- tidy(stock_h2_length_14_16_dM_slope)

stock_h2_length_14_16_sF_slope <- lm(Length.off ~ Length.sire, data = stock_triads_length_14_16 %>% filter(Sex.off == "F"), na.action = na.omit)
stock_h2_length_14_16_sF_slope_tbl <- tidy(stock_h2_length_14_16_sF_slope)

stock_h2_length_14_16_sM_slope <- lm(Length.off ~ Length.sire, data = stock_triads_length_14_16 %>% filter(Sex.off == "M"), na.action = na.omit)
stock_h2_length_14_16_sM_slope_tbl <- tidy(stock_h2_length_14_16_sM_slope)

# make df
stock_slope_as_h2_length_14_16 <- as.data.frame(cbind((rbind(stock_h2_length_14_16_all_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_NN_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_NH_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_HN_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_HH_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_dam_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_sire_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_dF_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_dM_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_sF_slope_tbl[2,2], 
                                                      stock_h2_length_14_16_sM_slope_tbl[2,2]) %>% 
                                                  round(3)),
                                                  (rbind(stock_h2_length_14_16_all_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_NN_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_NH_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_HN_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_HH_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_dam_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_sire_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_dF_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_dM_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_sF_slope_tbl[2,3], 
                                                      stock_h2_length_14_16_sM_slope_tbl[2,3]) %>% 
                                                  round(3)),
                                                  (rbind(stock_h2_length_14_16_all_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_NN_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_NH_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_HN_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_HH_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_dam_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_sire_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_dF_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_dM_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_sF_slope_tbl[2,5], 
                                                      stock_h2_length_14_16_sM_slope_tbl[2,5]) %>% 
                                                  round(3))))

colnames(stock_slope_as_h2_length_14_16) <- c("Heritability (h^2)", "+/- SE", "P")
stock_slope_as_h2_length_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")

(stock_slope_as_h2_length_14_16 <- stock_slope_as_h2_length_14_16[,c(4,1,2,3)])
```

### ~~~~~~~~~~~~~~~~~~~Animal model

Narrow-sense heritabilities (h\^2) of were estimated from the proportion of the total phenotypic variance explained by the additive genetic variance component (h\^2 = VA/VP) per Evans et al. (2019) [<https://link.springer.com/article/10.1007/s10592-019-01174-4>]. Maternal (M) versus paternal (S) effects were estimated as the proportion of total phenotypic variance explained by each parental variance component (M = VM/VP; S = VS/VP).

```{r}
# # gremlin LME REML approach (https://github.com/matthewwolak/gremlin)
# # basic model: Trait.off ~ bv.Trait + Sex.off + Origin.dam + Origin.sire
# 
# # load pedigree file
# stock_triads_14_16_JH_ped <- read_csv("stock_triads_14_16_JH_ped.csv")
# 
# # breeding values
# mean_length <- stock_triads_length_14_16 %>% 
#   select(Length.off, Length.dam, Length.sire) %>% 
#   stack() 
# stock_triads_length_14_16_mean <- mean(mean_length$values, na.rm = TRUE)
# 
# stock_triads_length_14_16_bv <- stock_triads_length_14_16 %>% 
#   mutate(Length.bv.off = stock_slope_as_h2_length_14_16[1,2] * (Length.off - stock_triads_length_14_16_mean))
# 
# # overall
# stock_h2_length_14_16_all_am <- gremlin(Length.off ~ Length.bv.off + Sex.off + Origin.dam + Origin.sire, 
#                                         data = stock_triads_length_14_16_bv, 
#                                         na.action = na.omit)
# (summary(stock_h2_length_14_16_all_am))
# plot(stock_h2_length_14_16_all_am)
# hist(resid(stock_h2_length_14_16_all_am))
# 
# # by cross
# stock_h2_length_14_16_NN <- stock_triads_length_14_16_bv %>% filter(Cross == "NN")
# stock_h2_length_14_16_dam_sire_NN <- lmer(Length.bv.off ~ Sex.off + (1|Parent_ID.sire)+(1|Parent_ID.dam)+(1|Length.bv.sire)+(1|Length.bv.dam), 
#                                           data = stock_h2_length_14_16_NN, 
#                                           na.action = na.omit)
# (summary(stock_h2_length_14_16_dam_sire_NN))
# 
# stock_h2_length_14_16_NH <- stock_triads_length_14_16_bv %>% filter(Cross == "NH")
# stock_h2_length_14_16_dam_sire_NH <- lmer(Length.bv.off ~ Sex.off + (1|Parent_ID.sire)+(1|Parent_ID.dam)+(1|Length.bv.sire)+(1|Length.bv.dam), 
#                                           data = stock_h2_length_14_16_NH, 
#                                           na.action = na.omit)
# (summary(stock_h2_length_14_16_dam_sire_NH))
# 
# stock_h2_length_14_16_HN <- stock_triads_length_14_16_bv %>% filter(Cross == "HN")
# stock_h2_length_14_16_dam_sire_HN <- lmer(Length.bv.off ~ Sex.off + (1|Parent_ID.sire)+(1|Parent_ID.dam)+(1|Length.bv.sire)+(1|Length.bv.dam), 
#                                           data = stock_h2_length_14_16_HN,
#                                           na.action = na.omit)
# (summary(stock_h2_length_14_16_dam_sire_HN))
# 
# stock_h2_length_14_16_HH <- stock_triads_length_14_16_bv %>% filter(Cross == "HH")
# stock_h2_length_14_16_dam_sire_HH <- lmer(Length.bv.off ~ Sex.off + (1|Parent_ID.sire)+(1|Parent_ID.dam)+(1|Length.bv.sire)+(1|Length.bv.dam), 
#                                           data = stock_h2_length_14_16_HH, 
#                                           na.action = na.omit)
# (summary(stock_h2_length_14_16_dam_sire_HH))
# 
# # by sex
# stock_h2_length_14_16_F <- stock_triads_length_14_16_bv %>% filter(Sex.off == "F")
# stock_h2_length_14_16_dam_sire_F <- lmer(Length.bv.off ~ Origin.dam+Origin.sire + (1|Parent_ID.sire)+(1|Parent_ID.dam)+(1|Length.bv.sire)+(1|Length.bv.dam), 
#                                          data = stock_h2_length_14_16_F, 
#                                          na.action = na.omit)
# (summary(stock_h2_length_14_16_dam_sire_F))
# 
# stock_h2_length_14_16_M <- stock_triads_length_14_16_bv %>% filter(Sex.off == "M")
# stock_h2_length_14_16_dam_sire_M <- lmer(Length.bv.off ~ Origin.dam+Origin.sire + (1|Parent_ID.sire)+(1|Parent_ID.dam)+(1|Length.bv.sire)+(1|Length.bv.dam), 
#                                          data = stock_h2_length_14_16_M, 
#                                          na.action = na.omit)
# (summary(stock_h2_length_14_16_dam_sire_M))
```

```{r}
# # calc H^2 and make table
# # overall
# (stock_h2_length_14_16_all <- 374 / (0.00000000007264 + 374))
# 
# # by cross
# stock_h2_length_14_16_NN <- (0.00000000000002205 + 59.15) / (0.00000000000002205 + 59.15 + 482.3)
# stock_h2_length_14_16_NH <- (0.000003134 + 26.35) / (0.000003134 + 26.35 + 429.2)
# stock_h2_length_14_16_HN <- (41.26 + 0.00) / (41.26 + 0.00 + 512.72)
# stock_h2_length_14_16_HH <- (0.00 + 19.17) / (0.00 + 19.17 + 300.66)
# 
# # all offspring
# stock_h2_length_14_16_dAll <- (13.357) / (0.00 + 13.35 + 482.61)
# stock_h2_length_14_16_sAll <- (0.00) / (0.00 + 13.35 + 482.61)
# 
# # by sex
# stock_h2_length_14_16_dam_F <- (29.54) / (0.00000000000000004950 + 39.54 + 299.0)
# stock_h2_length_14_16_sire_F <- (0.00000000000000004950) / (0.00000000000000004950 + 39.54 + 299.0)
# stock_h2_length_14_16_dam_M <- (12.49) / (22.47 + 12.49 + 639.19)
# stock_h2_length_14_16_sire_M <- (22.47) / (22.47 + 12.49 + 639.19)
# 
# # make dfs
# stock_am_for_h2_length_14_16 <- as.data.frame(c(stock_h2_length_14_16_all,
#                                                 stock_h2_length_14_16_NN,
#                                                 stock_h2_length_14_16_NH,
#                                                 stock_h2_length_14_16_HN,
#                                                 stock_h2_length_14_16_HH,
#                                                 stock_h2_length_14_16_dAll,
#                                                 stock_h2_length_14_16_sAll,
#                                                 stock_h2_length_14_16_dam_F,
#                                                 stock_h2_length_14_16_dam_M,
#                                                 stock_h2_length_14_16_sire_F,
#                                                 stock_h2_length_14_16_sire_M)) %>%
#                                               round(3)
# 
# colnames(stock_am_for_h2_length_14_16) <- c("Heritability (h^2)")
# stock_am_for_h2_length_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")
# 
# (stock_am_for_h2_length_14_16 <- stock_am_for_h2_length_14_16[,c(2,1)])
```


### ~~~~~~~~~~~~~~~~~~~*Summary*

```{r}
# stock_r_and_h2_length_14_16 <- stock_r_and_h2_length_14_16[,c(1,3)]
# 
# stock_h2_length_14_16 <- merge(stock_r_and_h2_length_14_16, stock_slope_as_h2_length_14_16,  by="Category") %>% 
#     merge(stock_am_for_h2_length_14_16, by="Category") %>% 
#     rename(Stockdale_14_16 = Category, "h^2.correlation" = "Heritability (h^2).x", "h^2.slope" = "Heritability (h^2).y", "h^2.variance" = "Heritability (h^2)")
# (stock_h2_length_14_16 <- stock_h2_length_14_16[c(8,7,6,5,4,1,9,2,3,10,11),])
```

Some evidence for heritability of body size, but it is sporadic and not overly consistent among methods.

## Sample Date

```{r}
# mid-parent trait values and cross info
triads_date <- function(indata_triads_date = stock_triads_14_16) {
  indata_triads_date %>%
  mutate(DOY.par = (DOY.dam + DOY.sire) / 2) %>% 
  mutate(Cross = case_when(Origin.dam == "Natural" & Origin.sire == "Natural" ~ "NN",
                           Origin.dam == "Natural" & Origin.sire == "Hatchery" ~ "NH",
                           Origin.dam == "Hatchery" & Origin.sire == "Natural" ~ "HN",
                           Origin.dam == "Hatchery" & Origin.sire == "Hatchery" ~ "HH"))
}

stock_triads_date_14_16 <- triads_date()
```

### Scatterplots

```{r}
# overall
h2_date_graph <- function(indata_h2_date_graph = stock_triads_date_14_16, title = "Stockdale_14_16\n\nRegression of Sample Date") {
  indata_h2_date_graph %>% 
  ggplot(aes(x = DOY.par, y = DOY.off)) +
  geom_abline(slope = 1) +
  geom_jitter(size = 2) +
  geom_smooth(method = "lm") +
  labs(title = title) +
  xlab("Mid-parent DOY") +
  ylab("Offspring DOY") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# by cross
h2_date_graph_cross <- function(indata_h2_date_graph = stock_triads_date_14_16, title = "Stockdale_14_16\n\nRegression of Sample Date by Cross") {
  indata_h2_date_graph %>% 
  ggplot(aes(x = DOY.par, y = DOY.off, colour = Cross)) +
  geom_abline(slope = 1) +
  geom_jitter(size = 2) +
  geom_smooth(method = "lm") +
  labs(title = title, colour = "Cross") +
  xlab("Mid-parent DOY") +
  ylab("Offspring DOY") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# by sex
h2_date_graph_sex <- function(indata_parents_paired_date_graph = stock_parents_paired_14_16, title = "Stockdale_14_16\n\nRegression of Sample Date by Sex") {
  indata_parents_paired_date_graph %>% 
  rename(DOY.par = "DOY.par", 
         DOY.off = "DOY.off") %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Dam",
                             SEX.par == "M" ~ "Sire")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Female",
                             SEX.off == "M" ~ "Male")) %>% 
  group_by(sex.par, sex.off) %>%
  ggplot(aes(x = DOY.par, y = DOY.off, colour = origin.par)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.par) +
  labs(title = title,  colour = "Parent Origin") +
  xlab("Parent DOY") +
  ylab("Offspring DOY") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

h2_date_graph()
h2_date_graph_cross()
h2_date_graph_sex()
```

### Correlation

We estimate narrow-sense heritability here, as well as for location and sample date, from r = √(½)h\^2.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
parents_paired_date <- function(indata_triads_date = stock_triads_date_14_16) {
  indata_triads_date %>% 
  drop_na(DOY.par, DOY.off) %>% 
  mutate(sex.dam = case_when(Sex.dam == "F" ~ "Female")) %>%
  mutate(sex.sire = case_when(Sex.sire == "M" ~ "Male")) %>%
  mutate(sex.off = case_when(Sex.off == "F" ~ "Female",
                             Sex.off == "M" ~ "Male")) 
}

# overall
(stock_parents_paired_14_16_date0 <- parents_paired_date() %>% 
  summarise(correlation = round(cor(DOY.off, DOY.par), 3), r2 = round(cor(DOY.off, DOY.par)^2, 3)))

# by cross
(stock_parents_paired_14_16_date1 <- parents_paired_date() %>% 
  group_by(Cross) %>%
  summarise(correlation = round(cor(DOY.off, DOY.par), 3), r2 = round(cor(DOY.off, DOY.par)^2, 3)))

# all offspring
(stock_parents_paired_14_16_date4 <- parents_paired_date() %>% 
  group_by(sex.dam) %>%
  summarise(correlation = round(cor(DOY.off, DOY.dam), 3), r2 = round(cor(DOY.off, DOY.dam)^2, 3)))

(stock_parents_paired_14_16_date5 <- parents_paired_date() %>% 
  group_by(sex.sire) %>%
  summarise(correlation = round(cor(DOY.off, DOY.sire), 3), r2 = round(cor(DOY.off, DOY.sire)^2, 3)))

# by sex
(stock_parents_paired_14_16_date2 <- parents_paired_date() %>% 
  group_by(sex.dam, sex.off) %>%
  summarise(correlation = round(cor(DOY.off, DOY.dam), 3), r2 = round(cor(DOY.off, DOY.dam)^2, 3)))

(stock_parents_paired_14_16_date3 <- parents_paired_date() %>% 
  group_by(sex.sire, sex.off) %>%
  summarise(correlation = round(cor(DOY.off, DOY.sire), 3), r2 = round(cor(DOY.off, DOY.sire)^2, 3)))

# make dfs
stock_parents_paired_14_16_date0_All <- as.data.frame(c(stock_parents_paired_14_16_date0[1,1], stock_parents_paired_14_16_date0[1,2]*2))
stock_parents_paired_14_16_date1_NN <- as.data.frame(c(stock_parents_paired_14_16_date1[4,2], stock_parents_paired_14_16_date1[4,3]*2))
stock_parents_paired_14_16_date1_NH <- as.data.frame(c(stock_parents_paired_14_16_date1[3,2], stock_parents_paired_14_16_date1[3,3]*2))
stock_parents_paired_14_16_date1_HN <- as.data.frame(c(stock_parents_paired_14_16_date1[2,2], stock_parents_paired_14_16_date1[2,3]*2))
stock_parents_paired_14_16_date1_HH <- as.data.frame(c(stock_parents_paired_14_16_date1[1,2], stock_parents_paired_14_16_date1[1,3]*2))
stock_parents_paired_14_16_date4_dAll <- as.data.frame(c(stock_parents_paired_14_16_date4[1,2], stock_parents_paired_14_16_date4[1,3]*2))
stock_parents_paired_14_16_date5_sAll <- as.data.frame(c(stock_parents_paired_14_16_date5[1,2], stock_parents_paired_14_16_date5[1,3]*2))
stock_parents_paired_14_16_date2_dF <- as.data.frame(c(stock_parents_paired_14_16_date2[1,3], stock_parents_paired_14_16_date2[1,4]*2))
stock_parents_paired_14_16_date2_dM <- as.data.frame(c(stock_parents_paired_14_16_date2[2,3], stock_parents_paired_14_16_date2[2,4]*2))
stock_parents_paired_14_16_date3_sF <- as.data.frame(c(stock_parents_paired_14_16_date3[1,3], stock_parents_paired_14_16_date3[1,4]*2))
stock_parents_paired_14_16_date3_sM <- as.data.frame(c(stock_parents_paired_14_16_date3[2,3], stock_parents_paired_14_16_date3[2,4]*2))

stock_r_and_h2_date_14_16 <- rbind(stock_parents_paired_14_16_date0_All,
                                     stock_parents_paired_14_16_date1_NN, 
                                     stock_parents_paired_14_16_date1_NH, 
                                     stock_parents_paired_14_16_date1_HN, 
                                     stock_parents_paired_14_16_date1_HH,
                                     stock_parents_paired_14_16_date4_dAll,
                                     stock_parents_paired_14_16_date5_sAll,
                                     stock_parents_paired_14_16_date2_dF, 
                                     stock_parents_paired_14_16_date2_dM, 
                                     stock_parents_paired_14_16_date3_sF, 
                                     stock_parents_paired_14_16_date3_sM) %>%
                                round(3)

colnames(stock_r_and_h2_date_14_16) <- c("Correlation (r)", "Heritability (h^2)")
stock_r_and_h2_date_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")

(stock_r_and_h2_date_14_16 <- stock_r_and_h2_date_14_16[,c(3,1,2)])
```

### Slope

If we use the parents' phenotypic variance as a measure of VP, we can estimate h\^2 by solving for: trait_value_offspring = Cov_parent_offspring / Var_parent x trait_value_parent + c. The slope of the line is mathematically equivalent to h\^2.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# overall
stock_h2_date_14_16_all_slope <- lm(DOY.off ~ DOY.par, data = stock_triads_date_14_16, na.action = na.omit)
stock_h2_date_14_16_all_slope_tbl <- tidy(stock_h2_date_14_16_all_slope)

# by cross
stock_h2_date_14_16_NN_slope <- lm(DOY.off ~ DOY.par, data = stock_triads_date_14_16 %>% filter(Cross == "NN"), na.action = na.omit)
stock_h2_date_14_16_NN_slope_tbl <- tidy(stock_h2_date_14_16_NN_slope)

stock_h2_date_14_16_NH_slope <- lm(DOY.off ~ DOY.par, data = stock_triads_date_14_16 %>% filter(Cross == "NH"), na.action = na.omit)
stock_h2_date_14_16_NH_slope_tbl <- tidy(stock_h2_date_14_16_NH_slope)

stock_h2_date_14_16_HN_slope <- lm(DOY.off ~ DOY.par, data = stock_triads_date_14_16 %>% filter(Cross == "HN"), na.action = na.omit)
stock_h2_date_14_16_HN_slope_tbl <- tidy(stock_h2_date_14_16_HN_slope)

stock_h2_date_14_16_HH_slope <- lm(DOY.off ~ DOY.par, data = stock_triads_date_14_16 %>% filter(Cross == "HH"), na.action = na.omit)
stock_h2_date_14_16_HH_slope_tbl <- tidy(stock_h2_date_14_16_HH_slope)

# all offspring
stock_h2_date_14_16_dam_slope <- lm(DOY.off ~ DOY.dam, data = stock_triads_date_14_16, na.action = na.omit)
stock_h2_date_14_16_dam_slope_tbl <- tidy(stock_h2_date_14_16_dam_slope)

stock_h2_date_14_16_sire_slope <- lm(DOY.off ~ DOY.sire, data = stock_triads_date_14_16, na.action = na.omit)
stock_h2_date_14_16_sire_slope_tbl <- tidy(stock_h2_date_14_16_sire_slope)

# by sex
stock_h2_date_14_16_dF_slope <- lm(DOY.off ~ DOY.dam, data = stock_triads_date_14_16 %>% filter(Sex.off == "F"), na.action = na.omit)
stock_h2_date_14_16_dF_slope_tbl <- tidy(stock_h2_date_14_16_dF_slope)

stock_h2_date_14_16_dM_slope <- lm(DOY.off ~ DOY.dam, data = stock_triads_date_14_16 %>% filter(Sex.off == "M"), na.action = na.omit)
stock_h2_date_14_16_dM_slope_tbl <- tidy(stock_h2_date_14_16_dM_slope)

stock_h2_date_14_16_sF_slope <- lm(DOY.off ~ DOY.sire, data = stock_triads_date_14_16 %>% filter(Sex.off == "F"), na.action = na.omit)
stock_h2_date_14_16_sF_slope_tbl <- tidy(stock_h2_date_14_16_sF_slope)

stock_h2_date_14_16_sM_slope <- lm(DOY.off ~ DOY.sire, data = stock_triads_date_14_16 %>% filter(Sex.off == "M"), na.action = na.omit)
stock_h2_date_14_16_sM_slope_tbl <- tidy(stock_h2_date_14_16_sM_slope)

# make df
stock_slope_as_h2_date_14_16 <- as.data.frame(cbind((rbind(stock_h2_date_14_16_all_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_NN_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_NH_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_HN_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_HH_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_dam_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_sire_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_dF_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_dM_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_sF_slope_tbl[2,2], 
                                                      stock_h2_date_14_16_sM_slope_tbl[2,2]) %>% 
                                                  round(3)),
                                                  (rbind(stock_h2_date_14_16_all_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_NN_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_NH_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_HN_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_HH_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_dam_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_sire_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_dF_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_dM_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_sF_slope_tbl[2,3], 
                                                      stock_h2_date_14_16_sM_slope_tbl[2,3]) %>% 
                                                  round(3)),
                                                  (rbind(stock_h2_date_14_16_all_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_NN_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_NH_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_HN_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_HH_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_dam_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_sire_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_dF_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_dM_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_sF_slope_tbl[2,5], 
                                                      stock_h2_date_14_16_sM_slope_tbl[2,5]) %>% 
                                                  round(3))))

colnames(stock_slope_as_h2_date_14_16) <- c("Heritability (h^2)", "+/- SE", "P")
stock_slope_as_h2_date_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")

(stock_slope_as_h2_date_14_16 <- stock_slope_as_h2_date_14_16[,c(4,1,2,3)])
```

### ~~~~~~~~~~~~~~~~~~~Animal model

Narrow-sense heritabilities (h\^2) of were estimated from the proportion of the total phenotypic variance explained by the additive genetic variance component (h\^2 = VA/VP) per Evans et al. (2019) [<https://link.springer.com/article/10.1007/s10592-019-01174-4>]. Maternal (M) versus paternal (S) effects were estimated as the proportion of total phenotypic variance explained by each parental variance component (M = VM/VP; S = VS/VP).

```{r}
# # lme4::lmer
# # overall
# # stock_h2_date_14_16_dam_sire <- lmer(DOY.off ~ (1|DOY.sire)+(1|DOY.dam), data = stock_triads_date_14_16, na.action = na.omit)
# stock_h2_date_14_16_dam_sire <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                         data = stock_triads_date_14_16, 
#                                         na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire))
# plot(stock_h2_date_14_16_dam_sire)
# hist(resid(stock_h2_date_14_16_dam_sire))
# 
# # by cross
# stock_h2_date_14_16_NN <- stock_triads_date_14_16 %>% filter(Cross == "NN")
# # stock_h2_date_14_16_dam_sire_NN <- lmer(DOY.off ~ (1|DOY.sire)+(1|DOY.dam), data = stock_h2_date_14_16_NN, na.action = na.omit)
# stock_h2_date_14_16_dam_sire_NN <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                           data = stock_h2_date_14_16_NN, 
#                                           na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire_NN))
# 
# stock_h2_date_14_16_NH <- stock_triads_date_14_16 %>% filter(Cross == "NH")
# # stock_h2_date_14_16_dam_sire_NH <- lmer(DOY.off ~ (1|DOY.sire)+(1|DOY.dam), data = stock_h2_date_14_16_NH, na.action = na.omit)
# stock_h2_date_14_16_dam_sire_NH <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                           data = stock_h2_date_14_16_NH, 
#                                           na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire_NH))
# 
# stock_h2_date_14_16_HN <- stock_triads_date_14_16 %>% filter(Cross == "HN")
# # stock_h2_date_14_16_dam_sire_HN <- lmer(DOY.off ~ (1|DOY.sire)+(1|date.dam), data = stock_h2_date_14_16_HN, na.action = na.omit)
# stock_h2_date_14_16_dam_sire_HN <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                           data = stock_h2_date_14_16_HN,
#                                           na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire_HN))
# 
# stock_h2_date_14_16_HH <- stock_triads_date_14_16 %>% filter(Cross == "HH")
# # stock_h2_date_14_16_dam_sire_HH <- lmer(DOY.off ~ (1|DOY.sire)+(1|DOY.dam), data = stock_h2_date_14_16_HH, na.action = na.omit)
# stock_h2_date_14_16_dam_sire_HH <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                           data = stock_h2_date_14_16_HH, 
#                                           na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire_HH))
# 
# # all offspring
# 
# # by sex
# stock_h2_date_14_16_F <- stock_triads_date_14_16 %>% filter(Sex.off == "F")
# # stock_h2_date_14_16_dam_sire_F <- lmer(DOY.off ~ (1|DOY.sire)+(1|DOY.dam), data = stock_h2_date_14_16_F, na.action = na.omit)
# stock_h2_date_14_16_dam_sire_F <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                          data = stock_h2_date_14_16_F, 
#                                          na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire_F))
# 
# stock_h2_date_14_16_M <- stock_triads_date_14_16 %>% filter(Sex.off == "M")
# # stock_h2_date_14_16_dam_sire_M <- lmer(DOY.off ~ (1|DOY.sire)+(1|DOY.dam), data = stock_h2_date_14_16_M, na.action = na.omit)
# stock_h2_date_14_16_dam_sire_M <- lmer(DOY.off ~ DOY.par + (1|DOY.sire)+(1|DOY.dam), 
#                                          data = stock_h2_date_14_16_M, 
#                                          na.action = na.omit)
# (summary(stock_h2_date_14_16_dam_sire_M))
# 
# ```
# 
# ```{r}
# # calc h^2 and make table
# 
# # overall
# stock_h2_date_14_16_all <- (1.753 + 0.00) / (1.753 + 0.00 + 49.522)
# 
# # by cross
# stock_h2_date_14_16_NN <- (5.082 + 1.011) / (5.082 + 1.011 + 39.891)
# stock_h2_date_14_16_NH <- (0.00 + 9.867) / (0.00 + 9.867 + 87.151)
# stock_h2_date_14_16_HN <- (26.14 + 0.00) / (26.14 + 0.00 + 34.04)
# stock_h2_date_14_16_HH <- (25.39 + 0.00) / (25.39 + 0.00 + 29.25)
# 
# # all offspring
# stock_h2_date_14_16_dAll <- (0.00) / (1.753 + 0.00 + 49.522)
# stock_h2_date_14_16_sAll <- (1.753) / (1.753 + 0.00 + 49.522)
# 
# # by sex
# stock_h2_date_14_16_dam_F <- (3.2257) / (3.2257 + 0.1196 + 39.6428)
# stock_h2_date_14_16_sire_F <- (0.1196) / (3.2257 + 0.1196 + 39.6428)
# stock_h2_date_14_16_dam_M <- (0.7172) / (0.00 + 0.7172 + 59.3910)
# stock_h2_date_14_16_sire_M <- (0.00) / (0.00 + 0.7172 + 59.3910)
# 
# # make dfs
# stock_am_for_h2_date_14_16 <- as.data.frame(c(stock_h2_date_14_16_all,
#                                                 stock_h2_date_14_16_NN,
#                                                 stock_h2_date_14_16_NH,
#                                                 stock_h2_date_14_16_HN,
#                                                 stock_h2_date_14_16_HH,
#                                                 stock_h2_date_14_16_dAll,
#                                                 stock_h2_date_14_16_sAll,
#                                                 stock_h2_date_14_16_dam_F,
#                                                 stock_h2_date_14_16_dam_M,
#                                                 stock_h2_date_14_16_sire_F,
#                                                 stock_h2_date_14_16_sire_M)) %>%
#                                               round(3)
# 
# colnames(stock_am_for_h2_date_14_16) <- c("Heritability (h^2)")
# stock_am_for_h2_date_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")
# 
# (stock_am_for_h2_date_14_16 <- stock_am_for_h2_date_14_16[,c(2,1)])
```

### ~~~~~~~~~~~~~~~~~~~*Summary*

```{r}
# stock_r_and_h2_date_14_16 <- stock_r_and_h2_date_14_16[,c(1,3)]
# 
# stock_h2_date_14_16 <- merge(stock_r_and_h2_date_14_16, stock_slope_as_h2_date_14_16,  by="Category") %>% 
#     merge(stock_am_for_h2_date_14_16, by="Category") %>% 
#     rename(Stockdale_14_16 = Category, "h^2.correlation" = "Heritability (h^2).x", "h^2.slope" = "Heritability (h^2).y", "h^2.variance" = "Heritability (h^2)")
# (stock_h2_date_14_16 <- stock_h2_date_14_16[c(8,7,6,5,4,1,9,2,3,10,11),])
```

Better evidence for heritability of sample date as a proxy for return time, especially between female parents and offspring. There's some inconsistency among estimation methods, however.

## Reproductive success

```{r}
# Read in data
stock_paired_14_16_filter_parents_n <- read_csv("../Stockdale/stock_paired_14_16_filter_parents.csv") %>% 
  select(franz_id, n) %>% 
  rename(n_14 = n)
stock_paired_16_18_filter_parents_n <- read_csv("../Stockdale/stock_paired_16_18_filter_parents.csv") %>% 
  select(franz_id, n) %>% 
  rename(n.off = n)

# join by n (i.e. individual RS)
triads_n <- function(indata_triads = stock_triads_14_16, indata_paired_filter_parents_n = stock_paired_14_16_filter_parents_n, indata_paired_filter_offspring_n = stock_paired_16_18_filter_parents_n) {
  inner_join(indata_triads, indata_paired_filter_parents_n, by = c("Parent_ID.dam" = "franz_id")) %>% 
  rename(n.dam = n_14) %>% 
  inner_join(indata_paired_filter_parents_n, by = c("Parent_ID.sire" = "franz_id")) %>% 
  rename(n.sire = n_14) %>% 
  inner_join(indata_paired_filter_offspring_n, by = c("Offspring" = "franz_id"))
}

stock_triads_n_14_16 <- triads_n()

# mid-parent trait values and cross info
triads_rs <- function(indata_triads_rs = stock_triads_n_14_16) {
  indata_triads_rs %>%
  mutate(rs.par = (n.dam + n.sire) / 2) %>% 
  mutate(Cross = case_when(Origin.dam == "Natural" & Origin.sire == "Natural" ~ "NN",
                           Origin.dam == "Natural" & Origin.sire == "Hatchery" ~ "NH",
                           Origin.dam == "Hatchery" & Origin.sire == "Natural" ~ "HN",
                           Origin.dam == "Hatchery" & Origin.sire == "Hatchery" ~ "HH"))
}

stock_triads_rs_14_16 <- triads_rs()
```

### Scatterplots

```{r}
# overall
h2_rs_graph <- function(indata_h2_rs_graph = stock_triads_rs_14_16, title = "Stockdale_14_16\n\nRegression of RS") {
  indata_h2_rs_graph %>% 
  ggplot(aes(x = rs.par, y = n.off)) +
  geom_abline(slope = 1) +
  geom_jitter(size = 2) +
  geom_smooth(method = "lm") +
  labs(title = title) +
  xlab("Mid-parent RS") +
  ylab("Offspring RS") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

# by cross
h2_rs_graph_cross <- function(indata_h2_rs_graph = stock_triads_rs_14_16, title = "Stockdale_14_16\n\nHeritability of RS by Cross") {
  indata_h2_rs_graph %>% 
  ggplot(aes(x = rs.par, y = n.off, colour = Cross)) +
  geom_abline(slope = 1) +
  geom_jitter(size = 2) +
  geom_smooth(method = "lm") +
  labs(title = title, colour = "Cross") +
  xlab("Mid-parent RS") +
  ylab("Offspring RS") +
  theme_bw() +
  theme(text = element_text(size = 20))
}

h2_rs_graph()
h2_rs_graph_cross()

# by sex
stock_triads_rs_14_16 %>% 
  mutate(sex.dam = case_when(Sex.dam == "F" ~ "Dam")) %>% 
  mutate(sex.off = case_when(Sex.off == "F" ~ "Female",
                             Sex.off == "M" ~ "Male")) %>% 
  group_by(sex.off) %>%
  ggplot(aes(x = rs.par, y = n.off, colour = Origin.dam)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.dam) +
  labs(title = "Stockdale_14_16\n\nRegression of RS:  Offspring Sex by Female Parent",  colour = "Parent Origin") +
  xlab("Parent RS") +
  ylab("Offspring RS") +
  theme_bw() +
  theme(text = element_text(size = 20))

stock_triads_rs_14_16 %>% 
  mutate(sex.sire = case_when(Sex.sire == "M" ~ "Sire")) %>%
  mutate(sex.off = case_when(Sex.off == "F" ~ "Female",
                             Sex.off == "M" ~ "Male")) %>% 
  group_by(sex.off) %>%
  ggplot(aes(x = rs.par, y = n.off, colour = Origin.sire)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.sire) +
  labs(title = "Stockdale_14_16\n\nRegression of RS: Offspring Sex by Male Parent",  colour = "Parent Origin") +
  xlab("Parent RS") +
  ylab("Offspring RS") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

### Correlation

```{r, echo=FALSE, warning=FALSE, message=FALSE}
parents_paired_rs <- function(indata_triads_rs = stock_triads_rs_14_16) {
  indata_triads_rs %>% 
  drop_na(rs.par, n.off) %>% 
  mutate(sex.dam = case_when(Sex.dam == "F" ~ "Female")) %>%
  mutate(sex.sire = case_when(Sex.sire == "M" ~ "Male")) %>%
  mutate(sex.off = case_when(Sex.off == "F" ~ "Female",
                             Sex.off == "M" ~ "Male")) 
}

# overall
(stock_parents_paired_14_16_rs0 <- parents_paired_rs() %>% 
  summarise(correlation = round(cor(n.off, rs.par), 3), r2 = round(cor(n.off, rs.par)^2, 3)))

# by cross
(stock_parents_paired_14_16_rs1 <- parents_paired_rs() %>% 
  group_by(Cross) %>%
  summarise(correlation = round(cor(n.off, rs.par), 3), r2 = round(cor(n.off, rs.par)^2, 3)))

# all offspring
(stock_parents_paired_14_16_rs4 <- parents_paired_rs() %>% 
  group_by(sex.dam) %>%
  summarise(correlation = round(cor(n.off, n.dam), 3), r2 = round(cor(n.off, n.dam)^2, 3)))

(stock_parents_paired_14_16_rs5 <- parents_paired_rs() %>% 
  group_by(sex.sire) %>%
  summarise(correlation = round(cor(n.off, n.sire), 3), r2 = round(cor(n.off, n.sire)^2, 3)))

# by sex
(stock_parents_paired_14_16_rs2 <- parents_paired_rs() %>% 
  group_by(sex.dam, sex.off) %>%
  summarise(correlation = round(cor(n.off, rs.par), 3), r2 = round(cor(n.off, rs.par)^2, 3)))
(stock_parents_paired_14_16_rs3 <- parents_paired_rs() %>% 
  group_by(sex.sire, sex.off) %>%
  summarise(correlation = round(cor(n.off, rs.par), 3), r2 = round(cor(n.off, rs.par)^2, 3)))

stock_parents_paired_14_16_rs0_All <- as.data.frame(c(stock_parents_paired_14_16_rs0[1,1], stock_parents_paired_14_16_rs0[1,2]*2))
stock_parents_paired_14_16_rs1_NN <- as.data.frame(c(stock_parents_paired_14_16_rs1[4,2], stock_parents_paired_14_16_rs1[4,3]*2))
stock_parents_paired_14_16_rs1_NH <- as.data.frame(c(stock_parents_paired_14_16_rs1[3,2], stock_parents_paired_14_16_rs1[3,3]*2))
stock_parents_paired_14_16_rs1_HN <- as.data.frame(c(stock_parents_paired_14_16_rs1[2,2], stock_parents_paired_14_16_rs1[2,3]*2))
stock_parents_paired_14_16_rs1_HH <- as.data.frame(c(stock_parents_paired_14_16_rs1[1,2], stock_parents_paired_14_16_rs1[1,3]*2))
stock_parents_paired_14_16_rs4_dAll <- as.data.frame(c(stock_parents_paired_14_16_rs4[1,2], stock_parents_paired_14_16_rs4[1,3]*2))
stock_parents_paired_14_16_rs5_sAll <- as.data.frame(c(stock_parents_paired_14_16_rs5[1,2], stock_parents_paired_14_16_rs5[1,3]*2))
stock_parents_paired_14_16_rs2_dF <- as.data.frame(c(stock_parents_paired_14_16_rs2[1,3], stock_parents_paired_14_16_rs2[1,4]*2))
stock_parents_paired_14_16_rs2_dM <- as.data.frame(c(stock_parents_paired_14_16_rs2[2,3], stock_parents_paired_14_16_rs2[2,4]*2))
stock_parents_paired_14_16_rs3_sF <- as.data.frame(c(stock_parents_paired_14_16_rs3[1,3], stock_parents_paired_14_16_rs3[1,4]*2))
stock_parents_paired_14_16_rs3_sM <- as.data.frame(c(stock_parents_paired_14_16_rs3[2,3], stock_parents_paired_14_16_rs3[2,4]*2))

stock_r_and_h2_rs_14_16 <- rbind(stock_parents_paired_14_16_rs0_All,
                                     stock_parents_paired_14_16_rs1_NN, 
                                     stock_parents_paired_14_16_rs1_NH, 
                                     stock_parents_paired_14_16_rs1_HN, 
                                     stock_parents_paired_14_16_rs1_HH,
                                     stock_parents_paired_14_16_rs4_dAll,
                                     stock_parents_paired_14_16_rs5_sAll,
                                     stock_parents_paired_14_16_rs2_dF, 
                                     stock_parents_paired_14_16_rs2_dM, 
                                     stock_parents_paired_14_16_rs3_sF, 
                                     stock_parents_paired_14_16_rs3_sM) %>%
                                round(3)

colnames(stock_r_and_h2_rs_14_16) <- c("Correlation (r)", "Heritability (h^2)")
stock_r_and_h2_rs_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")

(stock_r_and_h2_rs_14_16 <- stock_r_and_h2_rs_14_16[,c(3,1,2)])
```

### Slope

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# overall
stock_h2_rs_14_16_all_slope <- lm(n.off ~ rs.par, data = stock_triads_rs_14_16, na.action = na.omit)
stock_h2_rs_14_16_all_slope_tbl <- tidy(stock_h2_rs_14_16_all_slope)

# by cross
stock_h2_rs_14_16_NN_slope <- lm(n.off ~ rs.par, data = stock_triads_rs_14_16 %>% filter(Cross == "NN"), na.action = na.omit)
stock_h2_rs_14_16_NN_slope_tbl <- tidy(stock_h2_rs_14_16_NN_slope)

stock_h2_rs_14_16_NH_slope <- lm(n.off ~ rs.par, data = stock_triads_rs_14_16 %>% filter(Cross == "NH"), na.action = na.omit)
stock_h2_rs_14_16_NH_slope_tbl <- tidy(stock_h2_rs_14_16_NH_slope)

stock_h2_rs_14_16_HN_slope <- lm(n.off ~ rs.par, data = stock_triads_rs_14_16 %>% filter(Cross == "HN"), na.action = na.omit)
stock_h2_rs_14_16_HN_slope_tbl <- tidy(stock_h2_rs_14_16_HN_slope)

stock_h2_rs_14_16_HH_slope <- lm(n.off ~ rs.par, data = stock_triads_rs_14_16 %>% filter(Cross == "HH"), na.action = na.omit)
stock_h2_rs_14_16_HH_slope_tbl <- tidy(stock_h2_rs_14_16_HH_slope)

# all offspring
stock_h2_rs_14_16_dam_slope <- lm(n.off ~ n.dam, data = stock_triads_rs_14_16, na.action = na.omit)
stock_h2_rs_14_16_dam_slope_tbl <- tidy(stock_h2_rs_14_16_dam_slope)

stock_h2_rs_14_16_sire_slope <- lm(n.off ~ n.sire, data = stock_triads_rs_14_16, na.action = na.omit)
stock_h2_rs_14_16_sire_slope_tbl <- tidy(stock_h2_rs_14_16_sire_slope)

# by sex
stock_h2_rs_14_16_dF_slope <- lm(n.off ~ n.dam, data = stock_triads_rs_14_16 %>% filter(Sex.off == "F"), na.action = na.omit)
stock_h2_rs_14_16_dF_slope_tbl <- tidy(stock_h2_rs_14_16_dF_slope)

stock_h2_rs_14_16_dM_slope <- lm(n.off ~ n.dam, data = stock_triads_rs_14_16 %>% filter(Sex.off == "M"), na.action = na.omit)
stock_h2_rs_14_16_dM_slope_tbl <- tidy(stock_h2_rs_14_16_dM_slope)

stock_h2_rs_14_16_sF_slope <- lm(n.off ~ n.sire, data = stock_triads_rs_14_16 %>% filter(Sex.off == "F"), na.action = na.omit)
stock_h2_rs_14_16_sF_slope_tbl <- tidy(stock_h2_rs_14_16_sF_slope)

stock_h2_rs_14_16_sM_slope <- lm(n.off ~ n.sire, data = stock_triads_rs_14_16 %>% filter(Sex.off == "M"), na.action = na.omit)
stock_h2_rs_14_16_sM_slope_tbl <- tidy(stock_h2_rs_14_16_sM_slope)

# make df
stock_slope_as_h2_rs_14_16 <- as.data.frame(cbind((rbind(stock_h2_rs_14_16_all_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_NN_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_NH_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_HN_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_HH_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_dam_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_sire_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_dF_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_dM_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_sF_slope_tbl[2,2], 
                                                      stock_h2_rs_14_16_sM_slope_tbl[2,2]) %>% 
                                                  round(3)),
                                                  (rbind(stock_h2_rs_14_16_all_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_NN_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_NH_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_HN_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_HH_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_dam_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_sire_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_dF_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_dM_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_sF_slope_tbl[2,3], 
                                                      stock_h2_rs_14_16_sM_slope_tbl[2,3]) %>% 
                                                  round(3)),
                                                  (rbind(stock_h2_rs_14_16_all_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_NN_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_NH_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_HN_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_HH_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_dam_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_sire_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_dF_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_dM_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_sF_slope_tbl[2,5], 
                                                      stock_h2_rs_14_16_sM_slope_tbl[2,5]) %>% 
                                                  round(3))))

colnames(stock_slope_as_h2_rs_14_16) <- c("Heritability (h^2)", "+/- SE", "P")
stock_slope_as_h2_rs_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")

(stock_slope_as_h2_rs_14_16 <- stock_slope_as_h2_rs_14_16[,c(4,1,2,3)])
```

### ~~~~~~~~~~~~~~~~~~~Animal model

```{r}
# run linear model

# # lme4::glmer.nb
# # RS has a (probably zero-inflated) negative binomial distribution; lmer not appropriate for model fitting
# # the residual variance is fixed to (π^2)/3 in GLMMs with logistic regression (Nakagawa and Schielzeth. 2010. Biol. Rev. 85:935-956; Wu et al. 2012. Contempory Clinical Trials 33: 869-880)
# 
# # overall
# stock_h2_rs_14_16_dam_sire <- glmer.nb(n.off ~ rs.par + (1|n.sire)+(1|n.dam), data = stock_triads_rs_14_16, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire))
# plot(stock_h2_rs_14_16_dam_sire)
# hist(resid(stock_h2_rs_14_16_dam_sire))
# 
# # by cross
# stock_h2_rs_14_16_NN <- stock_triads_rs_14_16 %>% filter(Cross == "NN")
# stock_h2_rs_14_16_dam_sire_NN <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_NN, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_NN))
# 
# stock_h2_rs_14_16_NH <- stock_triads_rs_14_16 %>% filter(Cross == "NH")
# stock_h2_rs_14_16_dam_sire_NH <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_NH, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_NH))
# 
# stock_h2_rs_14_16_HN <- stock_triads_rs_14_16 %>% filter(Cross == "HN")
# stock_h2_rs_14_16_dam_sire_HN <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_HN, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_HN))
# 
# # stock_h2_rs_14_16_HH <- stock_triads_rs_14_16 %>% filter(Cross == "HH")
# # stock_h2_rs_14_16_dam_sire_HH <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_HH, na.action = na.omit)
# # (summary(stock_h2_rs_14_16_dam_sire_HH))
# 
# # by sex
# stock_h2_rs_14_16_F <- stock_triads_rs_14_16 %>% filter(Sex.off == "F")
# stock_h2_rs_14_16_dam_sire_F <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_F, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_F))
# 
# stock_h2_rs_14_16_M <- stock_triads_rs_14_16 %>% filter(Sex.off == "M")
# stock_h2_rs_14_16_dam_sire_M <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_M, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_M))

# mgcv::ziP??? or pscl
# assuming RS has a zero-inflated negative binomial (or Poisson) distribution, we tried packages that incorporate zero-inflation for model fitting
# the residual variance is fixed to (π^2)/3 in GLMMs with logistic regression (Nakagawa and Schielzeth. 2010. Biol. Rev. 85:935-956; Wu et al. 2012. Contempory Clinical Trials 33: 869-880)

# overall
# stock_h2_rs_14_16_dam_sire <- glmer.nb(n.off ~ rs.par + (1|n.sire)+(1|n.dam), data = stock_triads_rs_14_16, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire))
# plot(stock_h2_rs_14_16_dam_sire)
# hist(resid(stock_h2_rs_14_16_dam_sire))
# 
# # by cross
# stock_h2_rs_14_16_NN <- stock_triads_rs_14_16 %>% filter(Cross == "NN")
# stock_h2_rs_14_16_dam_sire_NN <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_NN, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_NN))
# 
# stock_h2_rs_14_16_NH <- stock_triads_rs_14_16 %>% filter(Cross == "NH")
# stock_h2_rs_14_16_dam_sire_NH <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_NH, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_NH))
# 
# stock_h2_rs_14_16_HN <- stock_triads_rs_14_16 %>% filter(Cross == "HN")
# stock_h2_rs_14_16_dam_sire_HN <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_HN, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_HN))
# 
# stock_h2_rs_14_16_HH <- stock_triads_rs_14_16 %>% filter(Cross == "HH")
# stock_h2_rs_14_16_dam_sire_HH <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_HH, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_HH))
# 
# # by sex
# stock_h2_rs_14_16_F <- stock_triads_rs_14_16 %>% filter(Sex.off == "F")
# stock_h2_rs_14_16_dam_sire_F <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_F, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_F))
# 
# stock_h2_rs_14_16_M <- stock_triads_rs_14_16 %>% filter(Sex.off == "M")
# stock_h2_rs_14_16_dam_sire_M <- glmer.nb(n.off ~ (1|n.sire)+(1|n.dam), data = stock_h2_rs_14_16_M, na.action = na.omit)
# (summary(stock_h2_rs_14_16_dam_sire_M))
# ```
# ```{r}
# # calc h^2 and make table
# 
# # overall
# stock_h2_rs_14_16_all <- (0.0000000002037 + 0.00000000007082) / (0.0000000002037 + 0.00000000007082 + (pi * pi / 3))
# 
# # by cross
# stock_h2_rs_14_16_NN <- (0.000 + 0.000000000001826) / (0.000 + 0.000000000001826 + (pi * pi / 3))
# stock_h2_rs_14_16_NH <- (0.000 + 0.000) / (0.000 + 0.000 + (pi * pi / 3))
# stock_h2_rs_14_16_HN <- (0.000 + 0.0000000000006283) / (0.000 + 0.0000000000006283 + (pi * pi / 3))
# stock_h2_rs_14_16_HH <- 0.000
# 
# # all offspring
# stock_h2_rs_14_16_dAll <- (0.00000000007082) / (0.0000000002037 + 0.00000000007082 + (pi * pi / 3))
# stock_h2_rs_14_16_sAll <- (0.0000000002037) / (0.0000000002037 + 0.00000000007082 + (pi * pi / 3))
# 
# # by sex
# stock_h2_rs_14_16_dam_F <- (0.2110) / (0.9592 + 0.2110 + (pi * pi / 3))
# stock_h2_rs_14_16_sire_F <- (0.9592) / (0.9592 + 0.2110 + (pi * pi / 3))
# stock_h2_rs_14_16_dam_M <- (0.00000000006653) / (0.000000000001743 + 0.00000000006653 + (pi * pi / 3))
# stock_h2_rs_14_16_sire_M <- (0.000000000001743) / (0.000000000001743 + 0.00000000006653 + (pi * pi / 3))
# 
# # make dfs
# stock_am_for_h2_rs_14_16 <- as.data.frame(c(stock_h2_rs_14_16_all,
#                                               stock_h2_rs_14_16_NN,
#                                               stock_h2_rs_14_16_NH,
#                                               stock_h2_rs_14_16_HN,
#                                               stock_h2_rs_14_16_HH,
#                                               stock_h2_rs_14_16_dAll,
#                                               stock_h2_rs_14_16_sAll,
#                                               stock_h2_rs_14_16_dam_F,
#                                               stock_h2_rs_14_16_dam_M,
#                                               stock_h2_rs_14_16_sire_F,
#                                               stock_h2_rs_14_16_sire_M)) %>%
#                                             round(3)
# 
# colnames(stock_am_for_h2_rs_14_16) <- c("Heritability (h^2)")
# stock_am_for_h2_rs_14_16$Category <- c("Overall", "NN", "NH", "HN", "HH", "Dam/All offspring", "Sire/All offspring", "Dam/Female offspring", "Dam/Male offspring", "Sire/Female offspring", "Sire/Male offspring")
# 
# (stock_am_for_h2_rs_14_16 <- stock_am_for_h2_rs_14_16[,c(2,1)])
```

HH: 0.000 as placeholder; could not be calculated ("Error in asMethod(object) : not a positive definite matrix")

### ~~~~~~~~~~~~~~~~~~~*Summary*

```{r}
# stock_r_and_h2_rs_14_16 <- stock_r_and_h2_rs_14_16[,c(1,3)]
# 
# stock_h2_rs_14_16 <- merge(stock_r_and_h2_rs_14_16, stock_slope_as_h2_rs_14_16,  by="Category") %>% 
#     merge(stock_am_for_h2_rs_14_16, by="Category") %>% 
#     rename(Stockdale_14_16 = Category, "h^2.correlation" = "Heritability (h^2).x", "h^2.slope" = "Heritability (h^2).y", "h^2.variance" = "Heritability (h^2)")
# (stock_h2_rs_14_16 <- stock_h2_rs_14_16[c(8,7,6,5,4,1,9,2,3,10,11),])
```

Nothing to see here.

## ##################################
## IN PREP -- Sample Location: riverdist DNE

**Note:** Correlation between parent-offspring sample location and narrow-sense heritability of sample location *not yet available* for parental years beyond 2014. GIS-based stream distance mapping is *in progress* by Chase Jalbert.

```{r}

```

### Scatterplots

```{r}

```

### Correlation

Location is reported as distance from stream mouth.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

```

### Slope

```{r, echo=FALSE, warning=FALSE, message=FALSE}

```

### Animal model

```{r}

```

### *Results*

```{r}

```
