---
title: "Hogan Sample Locations"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

The purpose of these analyses is to relate spatial information with reproductive success (RS), with origin and sex as interactions. Note that we are only doing this for the even-year lineage (2014-2016) because there are not enough parent-offspring assignments from the odd lineage (2013-2015) to draw firm conclusions.

Our hypothesis is that there will be spatial separation between hatchery- and natural-origin Pink Salmon and that this separation may account for observed differences in RS. Spatial separation in spawning location has been observed in farmed- versus wild- Atlantic salmon, with farmed salmon more often found upriver of wild salmon (Moe et al. 2016; Okland et al. 1995; Thorstad et al. 1998). In contrast, wild Chinook from the Wenatchee River (WA) were found upstream of hatchery fish and had higher RS (Williamson et al. 2010). Additionally, spawning location may be influenced by return time if late-returning females have to choose less desirable locations (Fleming and Reynolds 2003). 

To test our hypothesis, we obtained sample location information from finsight, which included both processing area and GPS coordinates. Because processing areas overlapped and were inconsistent among years, we decided we couldn't use this variable as a proxy for sample location. Instead, we used an R script developed by Pete Rand that allows us to convert GPS coordinates to distance from the mouth of the stream. We did this transformation and then combined this new variable with our .csv file from our RS analyses. We did exploratory plotting to examine relationships among stream distance and RS, length, and timing. We also tested for multicollinearity among our variables. Following Bernston et al. (2011), Ford et al. (2012), and Janowitz-Koch et al. (2018), we used generalized linear models (GLM's) to evaluate relationships among RS, stream distance, length, origin and run timing separately for each sex.   

```{r setup, include=FALSE}
library(coin)
library(MASS)
library(scales)
library(tidyverse)
library(leaflet)
library(lubridate)
```

# Read in, format, and filter data

Spatial data are saved in finsight in two ways: sample processing area and GPS coordinates. 

```{r read in and filter finsight data}
finsight_hogan <- read_csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Hogan/finsight_hogan.csv")

finsight_hogan$SurveyDate <- as.Date(finsight_hogan$SurveyDate, "%m/%d/%Y") 

finsight_hogan <- finsight_hogan %>%  
  mutate(year = as.numeric(format(SurveyDate, format = "%Y")),
         month = as.numeric(format(SurveyDate, format = "%m")),
        day = as.numeric(format(SurveyDate, format = "%d")))

finsight_hogan <- finsight_hogan %>% 
  mutate(Longitude = -abs(Longitude))

finsight_hogan_filtered <- finsight_hogan %>% 
  filter(Latitude>60.207 & Longitude < -147.758)

finsight_hogan_filtered$ProcessingAreaNum <- as.factor(finsight_hogan_filtered$ProcessingAreaNum)
```

# Plot processing areas

```{r plot sample locations}
finsight_hogan_filtered %>%
count(year, ProcessingAreaNum, Longitude, Latitude) %>%
ggplot(aes(x = Longitude, y = Latitude, color= ProcessingAreaNum, size = n)) +
geom_point (alpha=0.2) +
facet_wrap(~year)

finsight_hogan %>%
count(year, ProcessingAreaNum, Longitude, Latitude) 

```

Seven processing areas were identified each year of sampling. These plots show the locations of the processing areas, with the size of the dot representing the number of individuals sampled. We plotted these locations to determine whether we could use this variable as a proxy for sample location. However, these plots reveal that processing areas are not discrete (they overlap) and that their locations are not consistent across years. 

# Convert coordinates to distance from stream mouth

Because we were not able to use processing area as a proxy for sample location, we used a script from Pete Rand to transform GPS coordinates into a more meaningful measure: distance from the mouth of the stream. We then saved the output as a new variable, 'distance.'

```{r convert coordinates to distances}

long1 <- min(finsight_hogan_filtered$Longitude)
lat1 <- min(finsight_hogan_filtered$Latitude)
long2 <- finsight_hogan_filtered$Longitude
lat2 <- finsight_hogan_filtered$Latitude

# Calculates the geodesic distance between two points specified by radian latitude/longitude using the
# Haversine formula (hf)
gcd.hf <- function(long1, lat1, long2, lat2) {
   R <- 6371 # Earth mean radius [km]
  delta.long <- (long2 - long1)
  delta.lat <- (lat2 - lat1)
  a <- sin(delta.lat/2)^2 + cos(lat1) * cos(lat2) * sin(delta.long/2)^2
  c <- 2 * asin(min(1,sqrt(a)))
  d = R * c
  return(d) # Distance in km
}

distance <- apply(finsight_hogan_filtered[,c("Latitude", "Longitude")], 1, function(x) {
  gcd.hf(long1 = min(finsight_hogan_filtered$Longitude), 
         lat1 = min(finsight_hogan_filtered$Latitude), 
         long2 = x["Longitude"], 
         lat2 = x["Latitude"])
  })

finsight_hogan_filtered$Distance <- distance
      

# A function to convert degrees to radians
deg2rad <- function(deg) return(deg*pi/180)

```

# Join finsight table with parentage data

We joined spatial data from finsight with parentage data.

```{r join tables}
paired_14_16_filter_parents <- read_csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Hogan/paired_14_16_filter_parents.csv")


finsight_parentage_hogan <- left_join(paired_14_16_filter_parents, finsight_hogan_filtered, by = c("DNA Tray Code" = "SampleTrayId" , "DNA Tray Well Code" = "SampleCell")) %>% 
 mutate(origin = factor(origin, c("Natural", "Hatchery")))  # make factor to ensure hatchery != red


write_csv(finsight_parentage_hogan, "finsight_parentage_hogan.csv")
```

# Plot RS by distance

```{r exploratory plot of RS by distance}
finsight_parentage_hogan %>% 
  ggplot(aes(x = Distance, y = n, color= origin)) +
  geom_point () +
  geom_smooth() +
  geom_jitter(height = 0.5) +
  facet_grid(Sex ~.) +
  labs(title = "Reproductive Success by Parental Sample Location",  colour = "Parent: Origin",
       shape = "Parent: Sex") +
  xlab("Distance from Stream Mouth (m)") +
  ylab("Reproductive Success")
```

These plots show RS (number of offspring) by distance from stream mouth (m), faceted by sex. For both sexes, natural-origin individuals had higher RS closer to the stream mouth than hatchery-origin individuals. Hatchery-origin individuals tended to have higher RS further from the mouth and were more commonly sampled further upstream than natural-origin individuals. Gray bars represent loess smoothing. Note that plots are jittered to prevent overplotting. 

```{r exploratory plot of RS by size}
finsight_parentage_hogan %>% 
  ggplot(aes(x = Distance, y = `Length Mm`, color= origin)) +
  geom_point () +
  geom_smooth() +
  geom_jitter(height = 0.5) +
  facet_grid(Sex ~.) +
  labs(title = "Distance from Stream Mouth by Parental Length",  colour = "Parent: Origin",
       shape = "Parent: Sex") +
  xlab("Distance from Stream Mouth (m)") +
  ylab("Parental Length (mm)")
```

These plots show the relationship between parent length (mm) and distance from the stream mouth (m), faceted by sex. Overall, for both sexes, there were large size ranges at each sampling location. Smaller natural-origin females and males appear further upstream than larger individuals, perhaps indicating an inability to compete downstream. There is also a strong dip in the size of natural-origin males compared to hatchery-origin at about 10-15m from the stream mouth. Gray bars represent loess smoothing and points are jittered to prevent overplotting.   

# Plot sample location by sample date 

```{r plot location by date}
finsight_parentage_hogan %>% 
  ggplot(aes(x = `Sample Date`, y = Distance, color= origin)) +
  geom_point (alpha = 0.2) +
  geom_jitter(height = 2, size = 2) +
  geom_smooth() +
  facet_grid(Sex ~.) +
  labs(title = "Parental Sample Location by Date",  colour = "Parent: Origin",
       shape = "Parent: Sex", size = "Reproductive Success") +
  xlab("Parental Sample Date") +
  ylab("Distance from Stream Mouth (m)")
```

This plot shows the relationship between stream distance (m) and parental sample date, faceted by sex. Natural-origin fish, on average, arrive earlier than hatchery-origin. For both sexes, hatchery-origin fish tended to be sampled further upstream than natural-origin fish throughout the season, with a couple of exceptions (late August for females and early September for males). After ~ September 6, the majority of the fish were sampled within ~20m from the stream mouth. Gray bars represent loess smoothing and points are jittered to avoid overplotting. 

# Check for multi-collinearity

We checked for multi-collinearity among variables because we assumed that there would be some degree of non-independence. 

```{r multi-collinearity}
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col="cyan", ...)
}
panel.cor <- function(x, y, digits=2, prefix="", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y)
    txt <- format(c(r, 0.123456789), digits=digits)[1]
    txt <- paste0(prefix, txt, sep="")
    if(missing(cex.cor)) cex.cor <- 1/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

pairs(finsight_parentage_hogan[, c(7,9,13,57)], diag.panel = panel.hist, lower.panel=panel.smooth, 
upper.panel=panel.cor, main = "All individuals pooled")



```

These plots show males and females of both origins pooled. Histograms of each variable's distribution appear on the diagonal. The lower panels show scatterplots with smoothed averages. The upper panels show correlations. Distance was negatively correlated with sample date (-0.071) and RS (indicated by n; -0.10).

# Check for multi-collinearity separately for males and females

We then checked for multi-collinearity separately for males and females. 
```{r MC males}

Male.even <-  
  finsight_parentage_hogan %>% 
  filter(SEX == "M")
 
pairs(Male.even[, c(7,9,13,57)], diag.panel = panel.hist, lower.panel=panel.smooth, 
upper.panel=panel.cor, main = "Males")
```

For males, distance was negatively correlated with RS (n; -0.012) and sample date (-0.063). 

```{r MC females}

Female.even <-  
  finsight_parentage_hogan %>% 
  filter(SEX == "F")
 
pairs(Female.even[, c(7,9,13,57)], diag.panel = panel.hist, lower.panel=panel.smooth, 
upper.panel=panel.cor, main = "Females")
```

For females, distance was negatively correlated with RS (n; -0.077) and sample date (-0.094). 

# Test for multi-collinearity by origin

We then tested for multi-collinearity by origin. 

```{r MC hatchery}

Hatchery.even <-  
  finsight_parentage_hogan %>% 
  filter(origin == "Hatchery")
 
pairs(Hatchery.even[, c(7,9,13,57)], diag.panel = panel.hist, lower.panel=panel.smooth, 
upper.panel=panel.cor, main = "Hatchery")
```

For hatchery-origin individuals, distance was negatively correlated with RS (n; -0.042) and sample date (-0.15).

```{r MC natural}

Natural.even <-  
  finsight_parentage_hogan %>% 
  filter(origin == "Natural")
 
pairs(Natural.even[, c(7,9,13,57)], diag.panel = panel.hist, lower.panel=panel.smooth, 
upper.panel=panel.cor, main = "Natural")
```

For natural-origin individuals, distance was negatively correlated with RS (n; -0.17) and sample date (-0.023). 

The most striking differences are the differences in correlations between distance and sample date and RS for hatchery- and natural-origin individuals. Distance and sample date were strongly negatively correlated for hatchery-origin fish (-0.15), but not natural-origin (-0.023) and distance was strongly correlated with RS for natural-origin fish (-0.17), but not hatchery-origin (-0.042).  

# Use GLM's to associate RS with sample location, date, origin, and length by sex

Following Janowitz-Koch et al. (2018) and Ford et al. (2012), we used a negative binomial distribution model and log-linked function to evaluation associations between RS and origin, length, and sample date separately for females and males. 

```{r Female Even GLM}
Female.even <-  
  finsight_parentage_hogan %>% 
  filter(SEX == "F")
  
(RS.glm.F.full <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin + Distance, data = Female.even, link = log))
summary(RS.glm.full)

(RS.glm.F.2 <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin, data = Female.even, link = log))
summary(RS.glm.2)

(RS.glm.F.3 <- glm.nb(n ~ `Length Mm` + origin, data = Female.even, link = log))
summary(RS.glm.3)

(RS.glm.F.4 <- glm.nb(n ~ origin, data = Female.even, link = log))
summary(RS.glm.4)

(RS.glm.F.5 <- glm.nb(n ~ `Length Mm`, data = Female.even, link = log))
summary(RS.glm.5)

(RS.glm.F.6 <- glm.nb(n ~ `Sample Date`, data = Female.even, link = log))
summary(RS.glm.6)

(RS.glm.F.7 <- glm.nb(n ~ Distance, data = Female.even, link = log))
summary(RS.glm.7)

(RS.glm.F.8 <- glm.nb(n ~ `Sample Date` + `Length Mm` + Distance, data = Female.even, link = log))
summary(RS.glm.8)

(RS.glm.F.9 <- glm.nb(n ~ `Length Mm` + Distance, data = Female.even, link = log))
summary(RS.glm.9)

(RS.glm.F.10 <- glm.nb(n ~ `Sample Date` + origin, data = Female.even, link = log))
summary(RS.glm.10)

(RS.glm.F.11 <- glm.nb(n ~ `Sample Date` + Distance, data = Female.even, link = log))
summary(RS.glm.11)

(RS.glm.F.12 <- glm.nb(n ~ `Sample Date` + Distance + origin, data = Female.even, link = log))
summary(RS.glm.12)

(RS.glm.F.13 <- glm.nb(n ~ Distance + origin, data = Female.even, link = log))
summary(RS.glm.13)
```

For females, origin (p < 0.001) was significantly associated with RS.

```{r Male Even GLM}
Male.even <-  
  finsight_parentage_hogan %>% 
  filter(SEX == "M")
  
(RS.glm.M <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin + Distance, data = Male.even, link = log))
summary(RS.glm.M)
```

For males, length is the only statistically significant factor (p=0.018), but distance is almost significant (0.088).