---
title: "Hogan Sample Locations"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

The purpose of these analyses is to relate spatial information with reproductive success (RS), with origin date, and sex as interactions. Note that we are only doing this for the even-year lineage (2014-2016) because there are not enough parent-offspring assignments from the odd lineage (2013-2015) to draw firm conclusions. Also note that Hogan is a short stream (~30m) and we assume that the entire stream was sampled each day. 

Our hypothesis is that there will be spatial separation between hatchery- and natural-origin Pink Salmon and that this separation may account for observed differences in RS. Spatial separation in spawning location has been observed in farmed- versus wild- Atlantic salmon, with farmed salmon more often found upriver of wild salmon (Moe et al. 2016; Okland et al. 1995; Thorstad et al. 1998). In contrast, wild Chinook from the Wenatchee River (WA) were found upstream of hatchery fish and had higher RS (Williamson et al. 2010). Additionally, spawning location may be influenced by return time if late-returning females have to choose less desirable locations (Fleming and Reynolds 2003). 

To test our hypothesis, we obtained sample location information from finsight, which included both processing area and GPS coordinates. Because processing areas overlapped and were inconsistent among years, we decided we couldn't use this variable as a proxy for sample location. Instead, we used an R script developed by Pete Rand that allows us to convert GPS coordinates to distance from the mouth of the stream. We did this transformation and then combined this new variable with our .csv file from our RS analyses. We did exploratory plotting to examine relationships among stream distance and RS, length, and timing. We also tested for multicollinearity among our variables. Following Bernston et al. (2011), Ford et al. (2012), and Janowitz-Koch et al. (2018), we used generalized linear models (GLM's) to evaluate relationships among RS, stream distance, length, origin and run timing separately for each sex.   

```{r setup, include=FALSE}
library(coin)
library(MASS)
library(scales)
library(tidyverse)
library(leaflet)
library(lubridate)
library(ggExtra)
library(gridExtra)
library(MuMIn)
library(GGally)

knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

# Read in, format, and filter data

Spatial data are saved in finsight in two ways: sample processing area and GPS coordinates. 

```{r read in and filter finsight data}
finsight_hogan <- read_csv("finsight_hogan.csv")

finsight_hogan$SurveyDate <- as.Date(finsight_hogan$SurveyDate, "%m/%d/%Y") 

finsight_hogan <- finsight_hogan %>%  
  mutate(year = as.numeric(format(SurveyDate, format = "%Y")),
         month = as.numeric(format(SurveyDate, format = "%m")),
         day = as.numeric(format(SurveyDate, format = "%d")))

finsight_hogan <- finsight_hogan %>% 
  mutate(Longitude = -abs(Longitude))

finsight_hogan_filtered <- finsight_hogan %>% 
  filter(Latitude > 60.207 & Longitude < -147.758)

finsight_hogan_filtered$ProcessingAreaNum <- as.factor(finsight_hogan_filtered$ProcessingAreaNum)
```

# Plot processing areas

```{r plot sample locations}
finsight_hogan_filtered %>%
  count(year, ProcessingAreaNum, Longitude, Latitude) %>%
  ggplot(aes(x = Longitude, y = Latitude, color = ProcessingAreaNum, size = n)) +
  geom_point(alpha = 0.2) +
  theme_bw() +
  facet_wrap(~ year)

finsight_hogan %>%
  count(year, ProcessingAreaNum, Longitude, Latitude) 
```

Seven processing areas were identified each year of sampling. These plots show the locations of the processing areas, with the size of the dot representing the number of individuals sampled. We plotted these locations to determine whether we could use this variable as a proxy for sample location. However, these plots reveal that processing areas are not discrete (they overlap) and that their locations are not consistent across years. 

# Convert coordinates to distance from stream mouth

Because we were not able to use processing area as a proxy for sample location, we used a script from Pete Rand to transform GPS coordinates into a more meaningful measure: distance from the mouth of the stream. We then saved the output as a new variable, 'distance.'

```{r convert coordinates to distances}

long1 <- min(finsight_hogan_filtered$Longitude)
lat1 <- min(finsight_hogan_filtered$Latitude)
long2 <- finsight_hogan_filtered$Longitude
lat2 <- finsight_hogan_filtered$Latitude

# Calculates the geodesic distance between two points specified by radian latitude/longitude using the
# Haversine formula (hf)
gcd.hf <- function(long1, lat1, long2, lat2) {
  R <- 6371 # Earth mean radius [km]
  delta.long <- (long2 - long1)
  delta.lat <- (lat2 - lat1)
  a <- sin(delta.lat/2)^2 + cos(lat1) * cos(lat2) * sin(delta.long/2)^2
  c <- 2 * asin(min(1, sqrt(a)))
  d = R * c
  return(d) # Distance in km
}

distance <- apply(finsight_hogan_filtered[, c("Latitude", "Longitude")], 1, function(x) {
  gcd.hf(long1 = min(finsight_hogan_filtered$Longitude), 
         lat1 = min(finsight_hogan_filtered$Latitude), 
         long2 = x["Longitude"], 
         lat2 = x["Latitude"])
})

finsight_hogan_filtered$Distance <- distance


# A function to convert degrees to radians
deg2rad <- function(deg) return(deg*pi/180)
```

# Join finsight table with parentage data

We joined spatial data from finsight with parentage data.

```{r join tables}
paired_14_16_filter_parents <- read_csv("paired_14_16_filter_parents.csv")

finsight_parentage_hogan <- left_join(paired_14_16_filter_parents, finsight_hogan_filtered, 
                                      by = c("DNA Tray Code" = "SampleTrayId" , "DNA Tray Well Code" = "SampleCell")) %>% 
  mutate(origin = factor(origin, c("Natural", "Hatchery")))  # make factor to ensure hatchery != red

write_csv(finsight_parentage_hogan, "finsight_parentage_hogan.csv")
```



# Plot sample location by sample date 

```{r plot location by date}
pMain <- ggplot(finsight_parentage_hogan, aes(x = `Sample Date`, y = Distance, color = origin)) +
  theme_bw() +
  theme(legend.position = "none") +
  geom_point (alpha = 0.2) +
  geom_jitter(height = 2, size = 2) +
  geom_smooth() +
  facet_grid(Sex ~ .) +
  labs(colour = "Parent: Origin",
       shape = "Parent: Sex", size = "Reproductive Success") +
  xlab("Parental Sample Date") +
  ylab("Distance from Stream Mouth (m)")

pTop <- ggplot(finsight_parentage_hogan, aes(x = `Sample Date`, fill = origin)) + 
  geom_histogram(position = "dodge2") +
  theme(legend.position = "none")

pRight <- ggplot(finsight_parentage_hogan, aes(x = Distance, fill = origin)) +
  geom_histogram(position = "dodge2") +
  theme(legend.position = "none") +
  coord_flip() +
  facet_grid(SEX ~ . )

g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

pEmpty <- ggplot(finsight_parentage_hogan, aes(x = `Sample Date`, fill = origin)) + 
  geom_histogram(position = "dodge2") +
  theme_bw()

legend <- g_legend(pEmpty) 

grid.arrange(pTop, legend, pMain, pRight, ncol = 2, nrow = 2, widths = c(3,1), heights = c(1,3))

# ggExtra::ggMarginal(pMain, type = "histogram")
```

This plot shows the relationship between stream distance (m) and parental sample date, faceted by sex. Natural-origin fish, on average, arrive earlier than hatchery-origin. For both sexes, hatchery-origin fish tended to be sampled further upstream than natural-origin fish throughout the season, with a couple of exceptions (late August for females and early September for males). After ~ September 6, the majority of the fish were sampled within ~20m from the stream mouth. Gray bars represent loess smoothing and points are jittered to avoid overplotting. 



# Check for multi-collinearity

We checked for multi-collinearity among variables because we assumed that there would be some degree of non-independence. Note that these plots exclude individuals with missing data. 



```{r try ggpairs, fig.width=10, fig.height=10, warning=FALSE, message=FALSE}
reduced <- na.omit(finsight_parentage_hogan[,c(7,8,9,12,13,57)]) %>% 
  rename(RS = n, Sex = SEX) %>% 
  mutate(Origin = case_when(origin == "Natural" ~ "N", 
                            origin == "Hatchery" ~ "H")) %>% 
  mutate(Origin = factor(Origin, levels = c("N", "H")))

#ggpairs(reduced, diag = list(continuous="density", discrete="bar"), axisLabels = "show")

#ggpairs(reduced, columns=c("Sample Date", "Length Mm", "RS", "Distance"), diag = list(continous="points", discrete = "bar"), ggplot2::aes(colour = origin, shape = SEX, alpha = SEX))

# ggpairs(reduced, 
#         mapping = aes(color = Origin, alpha = 0.5), 
#         columns = c("Sample Date", "Length Mm", "Distance","RS", "Sex"), 
#         columnLabels = c("Sample Date", "Length (mm)", "Distance (m)", "RS", "Sex"), 
#         progress = FALSE, 
#         lower = list(continuous = "smooth_loess", combo = "facethist"),
#         upper = list(continuous = wrap("cor", size = 4, hjust = 0.8), combo = "box")
#         ) + 
#   theme_bw() +
#   theme(axis.text.x  = element_text(angle = 45, hjust = 1), 
#         text = element_text(size = 16))

ggpairs(reduced, 
        mapping = aes(color = Origin, alpha = 0.5), 
        columns = c("Sample Date", "Length Mm", "Distance","RS", "Sex"), 
        columnLabels = c("Sample Date", "Length (mm)", "Distance (m)", "RS", "Sex"), 
        progress = FALSE, 
        lower = list(continuous = "smooth_loess", combo = wrap(ggally_facethist, position = "dodge2")),
        upper = list(continuous = wrap("cor", size = 4, hjust = 0.8), combo = "box"),
        diag = list(discrete = wrap(ggally_barDiag, position = "dodge2"))
        ) + 
  theme_bw() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1), 
        text = element_text(size = 16))
```


Overall, correlations are pretty weak. Positive correlations were found between length and date, RS and date, distance and length, and RS and length. Negative correlations were found between distance and date and RS and distance. 

# Plot RS by distance

```{r exploratory plot of RS by distance}
pMain <- finsight_parentage_hogan %>% 
  ggplot(aes(x = Distance, y = n, color = origin)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  geom_jitter(height = 0.5) +
  theme_bw() +
  theme(legend.position = "bottom") +
  facet_grid(Sex ~ .) +
  labs(colour = "Parent: Origin",
       shape = "Parent: Sex") +
  xlab("Distance from Stream Mouth (m)") +
  ylab("Reproductive Success")

pTop <- ggplot(finsight_parentage_hogan, aes(x = Distance)) +
  theme_bw() +
  geom_histogram(aes(fill = origin)) +
  theme(legend.position = "none")

grid.arrange(pTop, pMain, ncol = 1, nrow = 2, heights = c(1, 3))
```

These plots show RS (number of offspring) by distance from stream mouth (m), faceted by sex. For both sexes, natural-origin individuals had higher RS closer to the stream mouth than hatchery-origin individuals. Hatchery-origin individuals tended to have higher RS further from the mouth and were more commonly sampled further upstream than natural-origin individuals. Gray bars represent loess smoothing. Note that plots are jittered to prevent overplotting. 

```{r exploratory plot of RS by size}
finsight_parentage_hogan %>% 
  ggplot(aes(x = Distance, y = `Length Mm`, color = origin)) +
  geom_point(alpha = 0.2) +
  theme_bw() +
  geom_smooth() +
  geom_jitter(height = 0.5) +
  facet_grid(Sex ~ .) +
  labs(title = "Distance from Stream Mouth by Parental Length", 
       colour = "Parent: Origin",
       shape = "Parent: Sex") +
  xlab("Distance from Stream Mouth (m)") +
  ylab("Parental Length (mm)")
```

These plots show the relationship between parent length (mm) and distance from the stream mouth (m), faceted by sex. Overall, for both sexes, there were large size ranges at each sampling location. Smaller natural-origin females and males appear further upstream than larger individuals, perhaps indicating an inability to compete downstream. There is also a strong dip in the size of natural-origin males compared to hatchery-origin at about 10-15m from the stream mouth. Gray bars represent loess smoothing and points are jittered to prevent overplotting.


# Plot by statistical week

```{r make new stat week variable}
finsight_parentage_hogan_sw <- finsight_parentage_hogan %>% 
  dplyr::mutate(statweek = dplyr::case_when(
    `Sample Date` == "2014-08-16" ~ "33",
    `Sample Date` == "2014-08-20" | `Sample Date` == "2014-08-22" ~ "34",
    `Sample Date` >= "2014-08-25" & `Sample Date` <= "2014-08-31" ~ "35",
    `Sample Date` >= "2014-09-03" & `Sample Date` <= "2014-09-06" ~ "36",
    `Sample Date` >= "2014-09-10" & `Sample Date` <= "2014-09-14" ~ "37"))

finsight_parentage_hogan_sw %>% 
  ggplot(aes(x = Distance, y = n, color = origin, shape = SEX)) +
  theme_bw() +
  geom_point(alpha = 0.2) +
  geom_jitter() +
  facet_grid(statweek ~ . ) +
  labs(title = "Reproductive Success by Parental Sample Location",
       colour = "Parent: Origin",
       shape = "Parent: Sex") +
  xlab("Distance from Stream Mouth (m)") +
  ylab("Reproductive Success")

finsight_parentage_hogan_sw %>% 
  ggplot(aes(x = Distance, y = n, color = origin)) +
  theme_bw() +
  geom_point(alpha = 0.2) +
  geom_jitter() +
  geom_smooth() +
  facet_grid(statweek ~ SEX) +
  labs(title = "Reproductive Success by Parental Sample Location",
       colour = "Parent: Origin",
       shape = "Parent: Sex") +
  xlab("Distance from Stream Mouth (m)") +
  ylab("Reproductive Success")
```

This plot shows distance from the stream mouth (m) by RS (number of offspring), faceted by sex and statistical week. Natural-origin fish of box sexes are more abundant earlier in the season than later. Fish sampled closer to the stream mouth appear to have higher RS than those sampled further upstream - this is particularly true for natural-origin. At the end of the season, most individuals were sampled closer to the stream mouth. Gray bars represent loess smoothing and points are jittered to reduce overplotting. 

# Use GLM's to associate RS with sample location, date, origin, and length by sex

we used a negative binomial distribution model and log-linked function to evaluation associations between RS and origin, length, and sample date separately for females and males. We ran 16 models for each sex, identified statistically significant variables, and selected the best model based on AIC and model complexity. The first 13 models included various combinations of the four independent variables (date, length, origin, distance). For both sexes, only one variable was significant in these models: origin for females and length for males. In the last 3 models, we included the significant variable and interactions with the remaining 3 variables. 

```{r Female Even GLM}
Female.even <-  
  finsight_parentage_hogan %>% 
  filter(SEX == "F")

(RS.glm.full <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin + Distance, data = Female.even, link = log))
summary(RS.glm.full)

(RS.glm.2 <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin, data = Female.even, link = log))
summary(RS.glm.2)

(RS.glm.3 <- glm.nb(n ~ `Length Mm` + origin, data = Female.even, link = log))
summary(RS.glm.3)

(RS.glm.4 <- glm.nb(n ~ origin, data = Female.even, link = log))
summary(RS.glm.4)

(RS.glm.5 <- glm.nb(n ~ `Length Mm`, data = Female.even, link = log))
summary(RS.glm.5)

(RS.glm.6 <- glm.nb(n ~ `Sample Date`, data = Female.even, link = log))
summary(RS.glm.6)

(RS.glm.7 <- glm.nb(n ~ Distance, data = Female.even, link = log))
summary(RS.glm.7)

(RS.glm.8 <- glm.nb(n ~ `Sample Date` + `Length Mm` + Distance, data = Female.even, link = log))
summary(RS.glm.8)

(RS.glm.9 <- glm.nb(n ~ `Length Mm` + Distance, data = Female.even, link = log))
summary(RS.glm.9)

(RS.glm.10 <- glm.nb(n ~ `Sample Date` + origin, data = Female.even, link = log))
summary(RS.glm.10)

(RS.glm.11 <- glm.nb(n ~ `Sample Date` + Distance, data = Female.even, link = log))
summary(RS.glm.11)

(RS.glm.12 <- glm.nb(n ~ `Sample Date` + Distance + origin, data = Female.even, link = log))
summary(RS.glm.12)

(RS.glm.13 <- glm.nb(n ~ Distance + origin, data = Female.even, link = log))
summary(RS.glm.13)

(RS.glm.14 <- glm.nb(n ~ Distance * origin, data = Female.even, link = log))
summary(RS.glm.14)

(RS.glm.15 <- glm.nb(n ~ `Sample Date` * origin, data = Female.even, link = log))
summary(RS.glm.15)

(RS.glm.16 <- glm.nb(n ~ `Length Mm` * origin, data = Female.even, link = log))
summary(RS.glm.16)
```

For females, origin was consistently significantly associated with RS. The model with the lowest AIC included date, length, and origin (AIC = 736.2). The next best model included only length and origin (Delta AIC = 0.1).  

# Extract Akaike Weights

Akaike weights are another way of determining which model has the best fit, by calculating their conditional probabilities. 

```{r Extract Akaike weights for females}
Female.Weights <- round(
  Weights(
    AICc(RS.glm.full, RS.glm.2, RS.glm.3, RS.glm.4, RS.glm.5, RS.glm.6, RS.glm.7, RS.glm.8, RS.glm.9, RS.glm.10, RS.glm.11, RS.glm.12, RS.glm.13, RS.glm.14, RS.glm.15, RS.glm.16)
    ), 3)

Female.Weights
```

The model with the highest weight (0.231) included both length and origin. 

```{r Male Even GLM}
Male.even <-  
  finsight_parentage_hogan %>% 
  filter(SEX == "M")

(RS.glm.full <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin + Distance, data = Male.even, link = log))
summary(RS.glm.full)

(RS.glm.2 <- glm.nb(n ~ `Sample Date` + `Length Mm` + origin, data = Male.even, link = log))
summary(RS.glm.2)

(RS.glm.3 <- glm.nb(n ~ `Length Mm` + origin, data = Male.even, link = log))
summary(RS.glm.3)

(RS.glm.4 <- glm.nb(n ~ origin, data = Male.even, link = log))
summary(RS.glm.4)

(RS.glm.5 <- glm.nb(n ~ `Length Mm`, data = Male.even, link = log))
summary(RS.glm.5)

(RS.glm.6 <- glm.nb(n ~ `Sample Date`, data = Male.even, link = log))
summary(RS.glm.6)

(RS.glm.7 <- glm.nb(n ~ Distance, data = Male.even, link = log))
summary(RS.glm.7)

(RS.glm.8 <- glm.nb(n ~ `Sample Date` + `Length Mm` + Distance, data = Male.even, link = log))
summary(RS.glm.8)

(RS.glm.9 <- glm.nb(n ~ `Length Mm` + Distance, data = Male.even, link = log))
summary(RS.glm.9)

(RS.glm.10 <- glm.nb(n ~ `Sample Date` + origin, data = Male.even, link = log))
summary(RS.glm.10)

(RS.glm.11 <- glm.nb(n ~ `Sample Date` + Distance, data = Male.even, link = log))
summary(RS.glm.11)

(RS.glm.12 <- glm.nb(n ~ `Sample Date` + Distance + origin, data = Male.even, link = log))
summary(RS.glm.12)

(RS.glm.13 <- glm.nb(n ~ Distance + origin, data = Male.even, link = log))
summary(RS.glm.13)

(RS.glm.14 <- glm.nb(n ~ Distance * `Length Mm`, data = Male.even, link = log))
summary(RS.glm.14)

(RS.glm.15 <- glm.nb(n ~ `Sample Date` * `Length Mm`, data = Male.even, link = log))
summary(RS.glm.15)

(RS.glm.16 <- glm.nb(n ~ origin * `Length Mm`, data = Male.even, link = log))
summary(RS.glm.16)
```


For males, length was the only statistically significant factor across models. The model with the best fit included length and distance (AIC = 651.7).  

```{r Extract Akaike weights for males}
Male.Weights <- round(
  Weights(
    AICc(RS.glm.full, RS.glm.2, RS.glm.3, RS.glm.4, RS.glm.5, RS.glm.6, RS.glm.7, RS.glm.8, RS.glm.9, RS.glm.10, RS.glm.11, RS.glm.12, RS.glm.13, RS.glm.14, RS.glm.15, RS.glm.16)
    ), 3)

Male.Weights
```

The model with the highest weight was also the one with the lowest AIC (weight = 0.333). The model includes length and distance. 