---
title: "Figures for Hogan-Stockdale 13-16 MS"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

The purpose of this notebook is to create figures for the manuscript focused on RRS from Hogan and Stockdale for years 2013-2016.

```{r setup, include=FALSE}
library(coin)
library(MASS)
library(scales)
library(tidyverse)
# library(leaflet)
library(lubridate)
library(PBSmapping)
library(grid)
library(ggthemes)
library(mapproj) 
library(gridExtra)
# Load
```

# Figure 1: Map of study area

Try PBSmapping, clunky, but great basemap for AK coastlines. Got the idea from Ben Williams GitHub [link](https://ben-williams.github.io/updated_ggplot_figures.html). Still used the idea from Quantitative Palaeoecology [link](https://quantpalaeo.wordpress.com/2016/06/05/ggplot2-maps-with-inset/)

```{r map of study area, message=FALSE, warning=FALSE}
# Load data
dat <- read_csv("map_data_2.csv")

dat <- dat %>%
  mutate(Legend = case_when(type == "Hogan" ~ "Hogan Bay",
                            type == "Stockdale" ~ "Stockdale Creek",
                            type == "Fitness Stream" ~ "Fitness Stream",
                            type == "Hatchery" & name != "VFDA" ~ "PWSAC",
                            name == "VFDA" ~ "VFDA")) %>% 
  mutate(Legend = factor(x = Legend, levels = c("Hogan Bay", "Stockdale Creek", "Fitness Stream", "VFDA", "PWSAC"))) %>% 
  mutate(abbr = case_when(name == "AFK" ~ "AFK",
                          name == "WHN" ~ "WNH",
                          name == "Cannery Creek" ~ "CCH",
                          name == "VFDA" ~ "SGH"))

x_lim <- range(dat$long) + c(-0.25, 0.25)
y_lim <- range(dat$lat) + c(-0.25, 0.25)

dat <- dat %>%
  filter(type != "City")

# Plot map with PBS mapping
data("nepacLLhigh")
ak <- nepacLLhigh %>% 
  dplyr::select(group = PID, POS = POS,long = X, lat = Y)

maptheme <- theme(
  panel.grid = element_blank(),
  panel.border = element_rect(fill = NA, colour = "black"),
  panel.background = element_blank()
)

# PWS map
pws_map <- ggplot() + 
  geom_polygon(data = ak, aes(long, lat, group = group), fill = "grey90", color = "black", lwd = 0.3) +
  geom_point(data = dat, aes(x = long, y = lat, fill = Legend), shape = 21, colour = "black", stroke = 2, size = 5) +
  geom_label(data = filter(dat, type == "Hatchery"), aes(long, lat, label = abbr), hjust = 0, nudge_x = 0.1) +
  geom_segment(aes(x = -148.7, xend = -148.7, y = 59.85, yend = 60.02), lineend = "butt", linejoin = "round", size = 2, arrow = arrow(length = unit(0.2, "inches"))) +
  theme(panel.background = element_rect(fill = 'white')) +
  scale_y_continuous(breaks = c(60.0, 60.5, 61.0)) +
  xlab(expression(paste(Longitude^o, ~'W'))) +
  ylab(expression(paste(Latitude^o, ~'N'))) +
  coord_map(xlim = x_lim, ylim = y_lim) +
  maptheme

# north2(pws_map, symbol = 12, 0.18, 0.20)  # couldn't get this to work with the inset

# Inset map
ak_map <- ggplot() + 
  geom_polygon(data = ak, aes(long, lat, group = group), fill = "grey90", color = "black", lwd = 0.3) +
  geom_rect(data = data.frame(), aes(xmin = x_lim[1], xmax = x_lim[2], ymin = y_lim[1], ymax = y_lim[2]), colour = "red", fill = NA, lwd = 1.3) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  coord_map(xlim = c(-170, -130), ylim = c(53, 65))

# Create map with inset and North arrow
grid.newpage()
vp_b <- viewport(width = 1, height = 1, x = 0.5, y = 0.5)  # the larger map
vp_a <- viewport(width = 0.23, height = 0.35, x = 0.605, y = 0.24)  # the inset in lower left
print(pws_map, vp = vp_b)
print(ak_map + maptheme, vp = vp_a)
```

This is the code used to actually save the map as a .png file
```{r save_map}
png(filename = "V:/Documents/5_Coastwide/Multispecies/AHRP/Manuscripts/02.Hogan_Stockdale_EA/0002.Figures&Tables/Figures/Figure1_map.png", width = 6.5, height = 6.5, units = "in", res = 300)
grid.newpage()
vp_b <- viewport(width = 1, height = 1, x = 0.5, y = 0.5)  # the larger map
vp_a <- viewport(width = 0.23, height = 0.35, x = 0.65, y = 0.3)  # the inset in lower left
print(pws_map, vp = vp_b)
print(ak_map + maptheme, vp = vp_a)
dev.off()
```

# Figure 2: Sample sizes throughout run
```{r sample sizes throughout run}
paired_13_15_filter <- read_csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Hogan/paired_13_15_filter.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery")))

paired_14_16_filter <- read.csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Hogan/paired_14_16_filter.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery")))

stock_paired_13_15_filter <- read_csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Stockdale/stock_paired_13_15_filter.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery")))

stock_paired_14_16_filter <- read_csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Stockdale/stock_paired_14_16_filter.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery")))

#Stacked
Hogan_Odd <- paired_13_15_filter %>% 
  ggplot(aes(x= Julian)) +
  theme_bw() +
  theme(axis.title.x = element_blank()) +
  theme(legend.position = c(0.85, 0.75)) +
  theme(legend.title = element_text(size = 4)) +
  theme(legend.text = element_text(size = 4)) +
  scale_y_continuous(limits = c(0,500), breaks = seq(0,500, by = 100)) +
  geom_bar(aes(fill=origin)) +
  facet_grid(`Sample Year` ~ .) +
  labs(title = "Hogan", y = "Number of Samples", fill = "Origin") +
  ylab(expression(atop("Odd", paste("Number of Samples"))))
  
Hogan_Even <- paired_14_16_filter %>% 
  ggplot(aes(x= Julian)) +
  theme_bw() +
  scale_y_continuous(limits = c(0,500), breaks = seq(0,500, by = 100)) +
  theme(legend.position = 'none') +
  geom_bar(aes(fill=origin)) +
  facet_grid(Sample.Year ~ .) +
  labs(y = "Number of Samples", x = "Julian Date") +
  ylab(expression(atop("Even", paste("Number of Samples"))))

Stock_Odd <- stock_paired_13_15_filter %>% 
  ggplot(aes(x=Julian)) +
  theme_bw() +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  scale_y_continuous(limits = c(0,500), breaks = seq(0,500, by = 100)) +
  theme(legend.position = 'none') +
  geom_bar(aes(fill=origin)) +
  facet_grid(`Sample Year` ~ .) +
  labs(title = "Stockdale")

Stock_Even <- stock_paired_14_16_filter %>% 
  ggplot(aes(x=Julian)) +
  theme_bw() +
  theme(axis.title.y = element_blank()) +
  scale_y_continuous(limits = c(0,500), breaks = seq(0,500, by = 100)) +
   theme(legend.position = 'none') +
  geom_bar(aes(fill=origin)) +
  facet_grid(`Sample Year` ~ .) +
  labs(x = "Julian Date")

Figure_2 <- 
grid.arrange(Hogan_Odd, Stock_Odd, Hogan_Even, Stock_Even,nrow = 2)


ggsave("Figure_2.pdf", plot = Figure_2, path = "V:/Documents/5_Coastwide/Multispecies/AHRP/Manuscripts/02.Hogan_Stockdale_EA/0002.Figures&Tables/Figures", height = 6, width = 12)
```

# Figure 3: Reproductive success

```{r Plot RS}
paired_13_15_filter_parents <- read_csv("V:/Analysis/5_Coastwide/Multispecies/Alaska Hatchery Research Program/PWS Pink/GitHub-PWS-Pink-Parentage/Hogan/paired_13_15_filter_parents.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery"))) %>% 
mutate(sex = case_when(SEX == "M" ~ "Male",
                         SEX == "F" ~ "Female"))

Hogan_Odd_RS <- paired_13_15_filter_parents %>% 
  count(SEX, origin, n) %>% 
  group_by(SEX, origin) %>% 
  mutate(p = nn / sum(nn)) %>% 
  ggplot(aes(x = n, y = p, fill = origin)) +
  theme_bw() +
  theme(legend.position = c(0.85, 0.75)) +
  geom_col(position = position_dodge2(preserve="single")) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(~ SEX, labeller = labeller(F = "Female", M = "Male")) +
  labs(title="Hogan",
       fill = "Parent: Origin") +
  xlab("Number of Offspring (RS)")+
  ylab("Proportion of Parents") 
```