---
title: "Stockdale Generalized Linear Models"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# Pro Tips {#protip}

Anything in [red](#protip) is a hyperlink that will either take you to the relevant location in this R Notebook .html file, or will link to an external reference (i.e. a publication we cite). If you just want to see the text and figures and **do not** want to see any of the `code` used to generate this R Notebook, click on the grey box in the upper right corner that says "Code" and select "Hide All Code". Happy data exploring!

# Introduction

The purpose of these analyses are to follow up on the previous notebook and fully consider all of the Stockdale Creek data holistically by model fitting reproducitve success (RS) to generalized linear models (GLMâ€™s), as is commonly done in the literature (see [Bernston et al. 2011](https://afspubs.onlinelibrary.wiley.com/doi/pdf/10.1080/00028487.2011.584489), [Ford et al. 2012](https://onlinelibrary.wiley.com/doi/full/10.1111/j.1755-263X.2012.00261.x), and [Janowitz-Koch et al. 2018](https://onlinelibrary.wiley.com/doi/full/10.1111/eva.12725)).

```{r setup, include=FALSE}
library(coin)
library(MASS)
library(scales)
library(tidyverse)
library(leaflet)
library(lubridate)
library(ggExtra)
library(gridExtra)
library(MuMIn)
library(GGally)
library(gganimate)

knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.width = 10)
```

# Load Data
```{r}
(riverdist_parentage_stock <- read_csv("riverdist_parentage_stock.csv") %>% 
   mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery")))
)
```

# Explore Data

## Visualize RS in Space and Time

Here we'll create an animation that walks through each sample date to show that fishes sample location (latitude and longitude) with the color of the point indicating the fish's origin (hatchery vs. natural), the shape the fish's sex (male/female), and the size of the point indicating how many offspring were assigned to it (reproductive success). This will show us two important things:  

  1) where high reproductive success ocurred in space and time
  2) the degree of spatio-temporal overlap between hatchery- and natural-origin pink salmon in Stockdale in 2014

*Note*, in this plot, Stockdale flows from bottom right to the mouth on the top left.
```{r}
sample_dates <- unique(sort(riverdist_parentage_stock$`Sample Date`))

my.animation <- riverdist_parentage_stock %>%
  mutate(Sex = case_when(SEX == "F" ~ "Female",
                         SEX == "M" ~ "Male")) %>% 
  mutate(grpI = as.numeric(factor(`Sample Date`))) %>%
  ggplot(aes(x = Longitude, y = Latitude, colour = origin, shape = Sex, size = n, alpha = 0.05, group = seq_along(`Sample Date`))) +
  coord_equal() +
  geom_jitter() +
  theme_bw() +
  guides(alpha = FALSE,
         colour = guide_legend(order = 1),
         shape = guide_legend(order = 2),
         size = guide_legend(order = 3)) +
  labs(size = "RS", 
       colour = "Parent: Origin", 
       shape = "Parent: Sex") +
  # theme(text = element_text(size = 20)) +
  transition_reveal(grpI) +
  ggtitle("Date: {sample_dates[floor(frame_along)]}")

animate(my.animation, height = 1200, width = 2400, res = 300)
```

```{r}
anim_save(filename = "Stockdale spatial RS over time.gif", path = "../")
```

```{r}
knitr::include_graphics("../Stockdale spatial RS over time.gif")
```

Another way to look at this is to use river distance instead of latitude/longitude, so we can view it in 2D as opposed to an animation. Here is a simple plot of RS by parent sample date and distance (both origins and sexes combined).
```{r, out.width="100%"}
riverdist_parentage_stock %>% 
    mutate(Sex = case_when(SEX == "F" ~ "Female",
                         SEX == "M" ~ "Male")) %>% 
  ggplot(aes(x = `Sample Date`, y = Distance, size = n, colour = origin, alpha = 0.05)) +
  geom_hline(aes(yintercept = tidedist), size = 2) +
  geom_jitter(width = 0.25) +
  theme_bw() +
  guides(alpha = FALSE,
         colour = guide_legend(order = 1),
         size = guide_legend(order = 3)) +
  labs(size = "RS", 
       colour = "Parent: Origin") +
  ggtitle("RS by Timing and Location of Parent Sampled ") +
  theme(text = element_text(size = 20))
```

Interesting, we can certainly see how hatchery- and natural-origin fish are separated in space and time, although there is some spatio-temporal overlap. Here we'll split out the "Unsuccessful" potential parents (i.e. those with RS = 0, no offspring assigned) as well as females and males.
```{r}
riverdist_parentage_stock %>% 
  mutate(Sex = case_when(SEX == "F" ~ "Female",
                         SEX == "M" ~ "Male")) %>% 
  ggplot(aes(x = `Sample Date`, y = Distance, size = n, colour = origin, alpha = 0.01)) +
  geom_hline(aes(yintercept = tidedist), size = 1) +
  geom_jitter(width = 0.25, height = 25) +
  theme_bw() +
  guides(alpha = FALSE,
         colour = guide_legend(order = 1),
         size = guide_legend(order = 3)) +
  labs(size = "RS", 
       colour = "Parent: Origin") +
  ggtitle("RS by Timing and Location of Parent Sampled") +
  facet_grid(Sex ~ Success) +
  theme(text = element_text(size = 20))  
```

How about the cross type data (offspring with two-parents, dam and sire)? What are the spatio-temporal patterns in matings of different cross types?
```{r}
parents_paired_14_16_cross <- read_csv("stock_parents_paired_14_16_cross.csv")

# organize by sire and dam, join riverdist data
parents_paired_14_16_cross_riverdist <- parents_paired_14_16_cross %>% 
  count(cross, `Fish ID`, `Fish ID.par1`, `Sample Date`, `Sample Date.par1`, SEX, SEX.par1, `DNA Tray Code`, `DNA Tray Code.par1`, `DNA Tray Well Code`, `DNA Tray Well Code.par1`, origin.par1, origin, `Length Mm.par1`, `Length Mm`) %>% 
  rename(`Fish ID.par2` = `Fish ID`, 
         `Sample Date.par2` = `Sample Date`,
         SEX.par2 = SEX,
         `DNA Tray Code.par2` = `DNA Tray Code`,
         `DNA Tray Well Code.par2` = `DNA Tray Well Code`,
         origin.par2 = origin,
         `Length Mm.par2` = `Length Mm`) %>% 
  unite(Sample.par1, c("DNA Tray Code.par1", "DNA Tray Well Code.par1"), sep = "_", remove = TRUE) %>% 
  unite(Sample.par2, c("DNA Tray Code.par2", "DNA Tray Well Code.par2"), sep = "_", remove = TRUE) %>% 
  left_join(riverdist, by = c("Sample.par1" = "Sample")) %>% 
  left_join(riverdist, by = c("Sample.par2" = "Sample"), suffix = c(".par1", ".par2")) %>% 
  mutate(fish_id.sire = case_when(SEX.par1 == "M" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(fish_id.dam = case_when(SEX.par1 == "F" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(sample_date.sire = case_when(SEX.par1 == "M" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sample_date.dam = case_when(SEX.par1 == "F" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sex.sire = case_when(SEX.par1 == "M" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>% 
  mutate(sex.dam = case_when(SEX.par1 == "F" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>%
  mutate(origin.sire = case_when(SEX.par1 == "M" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>% 
  mutate(origin.dam = case_when(SEX.par1 == "F" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>%
  mutate(distance.sire = case_when(SEX.par1 == "M" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>% 
  mutate(distance.dam = case_when(SEX.par1 == "F" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>%
  mutate(intertidal.sire = case_when(SEX.par1 == "M" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>% 
  mutate(intertidal.dam = case_when(SEX.par1 == "F" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>%
  mutate(length.sire = case_when(SEX.par1 == "M" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>% 
  mutate(length.dam = case_when(SEX.par1 == "F" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>%
  select(cross, n, ends_with(".sire"), ends_with(".dam"))
```

**When** were Dams and Sires that mated together sampled? We would expected that they would be sampled within the same time frame. However, it looks like females were sampled later (on average) than males. This is likely due to earlier run timing in males.
```{r}
parents_paired_14_16_cross_riverdist %>% 
  ggplot(aes(x = sample_date.sire, y = sample_date.dam)) +
  geom_jitter(aes(colour = cross, size = n), alpha = 0.5) +
  geom_abline(slope = 1) +
  theme_bw() +
  ggtitle("Parent Sample Date by Cross Type") +
  xlab("Sire Sample Date") +
  ylab("Dam Sample Date") +
  labs(size = "RS", 
       colour = "Parent: Cross Type") +
  theme(text = element_text(size = 20))  
```

**Where** were Dams and Sires that mated together sampled? We would expected that they would be sampled within the same area.
```{r}
parents_paired_14_16_cross_riverdist %>% 
  ggplot(aes(x = distance.sire, y = distance.dam), alpha = 0.05) +
  geom_jitter(aes(colour = cross, size = n), alpha = 0.5) +
  geom_abline(slope = 1)+
  theme_bw() +
  ggtitle("Parent Distance by Cross Type") +
  xlab("Sire Sample Distance from Mouth") +
  ylab("Dam Sample Distance from Mouth") +
  labs(size = "RS", 
       colour = "Parent: Cross Type") +
  theme(text = element_text(size = 20))  
```

Was there evidence of size assortative mating? Did larger fish mate with each other? Nope, doesn't look like it.
```{r}
parents_paired_14_16_cross_riverdist %>% 
  filter(length.sire > 300 & length.dam > 300) %>% 
  ggplot(aes(x = length.sire, y = length.dam), alpha = 0.05) +
  geom_jitter(aes(colour = cross, size = n), alpha = 0.5) +
  geom_abline(slope = 1)+
  geom_smooth(method = "lm") +
  theme_bw() +
  ggtitle("Parent Length by Cross Type")+
  xlab("Sire Length") +
  ylab("Dam Length") +
  labs(size = "RS", 
       colour = "Parent: Cross Type") +
  theme(text = element_text(size = 20))  
```

# Check for multi-collinearity {#multi-collinearity}

Before modeling RS, we checked for multi-collinearity among variables because we assumed that there would be some degree of non-independence. *Note* that these plots exclude individuals with missing data.
```{r try ggpairs, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
reduced <- riverdist_parentage_stock %>% 
  rename(RS = n, Sex = SEX) %>% 
  mutate(Origin = case_when(origin == "Natural" ~ "N", 
                            origin == "Hatchery" ~ "H")) %>% 
  mutate(Origin = factor(Origin, levels = c("N", "H"))) %>% 
  select(`Sample Date`, Sex, `Length Mm`, Origin, RS, Success, Intertidal, Distance) %>% 
  drop_na()

ggpairs(reduced, 
        mapping = aes(color = Origin, alpha = 0.5), 
        columns = c("Sample Date", "Length Mm", "Distance","RS", "Success", "Intertidal", "Sex"), 
        columnLabels = c("Sample Date", "Length (mm)", "Distance (m)", "RS", "Success", "Intertidal", "Sex"), 
        progress = FALSE, 
        lower = list(continuous = "smooth_loess", combo = wrap(ggally_facethist, position = "dodge2")),
        upper = list(continuous = wrap("cor", size = 4, hjust = 0.8), combo = "box"),
        diag = list(discrete = wrap(ggally_barDiag, position = "dodge2"))
        ) + 
  theme_bw() +
  theme(axis.text.x  = element_text(angle = 45, hjust = 1), 
        text = element_text(size = 16))
```

Overall, correlations among potential explanatory variables (sample date, length, and stream distance) are pretty weak, so there are not big concernc with multi-collinearity (i.e. we can have all variables in a model). Weak positive correlations were found between length and date (r = 0.26), distance and date (0.08), and RS and length (0.05). Weak negative correlations were found between distance and length (-0.05), distance and RS (-0.10), and RS and date (-0.25). Reproductive success was negatively correlated with sample date (-0.25) and stream distance (-0.37), and slightly positively correlated with length (0.05).

# Cross Data

## Each row as a cross
```{r}
riverdist <- read_csv("../../GIS/R/stockdale/stockdale_distances.csv") %>% 
  mutate(Intertidal = case_when(dist2tide > 0 ~ "Upstream",
                                dist2tide <= 0 ~ "Intertidal")) %>% 
  rename(Distance = mouthdist, Segment = seg)

parents_paired_14_16_cross <- read_csv("stock_parents_paired_14_16_cross.csv")

# organize by sire and dam, join riverdist data
parents_paired_14_16_cross_riverdist <- parents_paired_14_16_cross %>% 
  count(cross, `Fish ID`, `Fish ID.par1`, `Sample Date`, `Sample Date.par1`, SEX, SEX.par1, `DNA Tray Code`, `DNA Tray Code.par1`, `DNA Tray Well Code`, `DNA Tray Well Code.par1`, origin.par1, origin, `Length Mm.par1`, `Length Mm`) %>% 
  rename(`Fish ID.par2` = `Fish ID`, 
         `Sample Date.par2` = `Sample Date`,
         SEX.par2 = SEX,
         `DNA Tray Code.par2` = `DNA Tray Code`,
         `DNA Tray Well Code.par2` = `DNA Tray Well Code`,
         origin.par2 = origin,
         `Length Mm.par2` = `Length Mm`) %>% 
  unite(Sample.par1, c("DNA Tray Code.par1", "DNA Tray Well Code.par1"), sep = "_", remove = TRUE) %>% 
  unite(Sample.par2, c("DNA Tray Code.par2", "DNA Tray Well Code.par2"), sep = "_", remove = TRUE) %>% 
  left_join(riverdist, by = c("Sample.par1" = "Sample")) %>% 
  left_join(riverdist, by = c("Sample.par2" = "Sample"), suffix = c(".par1", ".par2")) %>% 
  mutate(fish_id.sire = case_when(SEX.par1 == "M" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(fish_id.dam = case_when(SEX.par1 == "F" ~ `Fish ID.par1`,
                                  TRUE ~ `Fish ID.par2`)) %>% 
  mutate(sample_date.sire = case_when(SEX.par1 == "M" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sample_date.dam = case_when(SEX.par1 == "F" ~ `Sample Date.par1`,
                                  TRUE ~ `Sample Date.par2`)) %>% 
  mutate(sex.sire = case_when(SEX.par1 == "M" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>% 
  mutate(sex.dam = case_when(SEX.par1 == "F" ~ SEX.par1,
                                  TRUE ~ SEX.par2)) %>%
  mutate(origin.sire = case_when(SEX.par1 == "M" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>% 
  mutate(origin.dam = case_when(SEX.par1 == "F" ~ origin.par1,
                                  TRUE ~ origin.par2)) %>%
  mutate(distance.sire = case_when(SEX.par1 == "M" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>% 
  mutate(distance.dam = case_when(SEX.par1 == "F" ~ Distance.par1,
                                  TRUE ~ Distance.par2)) %>%
  mutate(intertidal.sire = case_when(SEX.par1 == "M" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>% 
  mutate(intertidal.dam = case_when(SEX.par1 == "F" ~ Intertidal.par1,
                                  TRUE ~ Intertidal.par2)) %>%
  mutate(length.sire = case_when(SEX.par1 == "M" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>% 
  mutate(length.dam = case_when(SEX.par1 == "F" ~ `Length Mm.par1`,
                                  TRUE ~ `Length Mm.par2`)) %>%
  select(cross, n, ends_with(".sire"), ends_with(".dam"))
```

```{r}
parents_paired_14_16_cross_riverdist
```

# Each row as a parent
```{r}
riverdist_parentage_stock
```

# Each row as an offspring
```{r}
riverdist
```

```{r}
(parents_paired_14_16 <- read_csv("stock_parents_paired_14_16.csv") %>% 
     mutate(origin.par = factor(x = origin.par, levels = c("Natural", "Hatchery")))
)
```

```{r}
parents_paired_14_16 %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Parent: Female",
                             SEX.par == "M" ~ "Parent: Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Offspring: Female",
                             SEX.off == "M" ~ "Offspring: Male")) %>% 
  group_by(sex.par, sex.off) %>% 
  summarise(correlation = round(cor(Julian.off, Julian.par), 3))

parents_paired_14_16 %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Parent: Female",
                             SEX.par == "M" ~ "Parent: Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Offspring: Female",
                             SEX.off == "M" ~ "Offspring: Male")) %>% 
  ggplot(aes(x = Julian.par, y = Julian.off, colour = origin.par)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.par) +
  labs(title = "Heritability of Sample Date",  colour = "Parent: Origin") +
  xlab("Parent Sample Date (Julian)") +
  ylab("Offspring Sample Date (Julian)") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

# Each row as an offspring, dam and sire

## read paired data
```{r}
(paired_14_16 <- read_csv("../Franz/stockdale_postQA_OceanAK_paired_2014_2016_STOCK.csv") %>% 
   select(franz_id, starts_with("Sample"), SILLY, `Fish ID`, starts_with("DNA"), SEX, `Length Mm`, `Otolith Mark Present`, `Otolith Mark ID`) %>% 
   rename(sample_id = "Sample ID", 
          Year = "Sample Year", 
          silly = "SILLY", 
          fish_id = "Fish ID", 
          dna_tray = "DNA Tray Code", 
          dna_well = "DNA Tray Well Code",
          Sex = "SEX",
          Length = "Length Mm") %>% 
   mutate(Origin = case_when(`Otolith Mark Present` == "YES" ~ "Hatchery",
                             `Otolith Mark Present` == "NO" ~ "Natural")) %>% 
   mutate(Origin = factor(x = Origin, levels = c("Natural", "Hatchery")))
)
```

## get offspring, dam, sire relationships and join
```{r}
offspring_14_16_sire <- parents_paired_14_16 %>% 
  filter(SEX.par == "M") %>% 
  select(Offspring, Parent_ID)

offspring_14_16_dam <- parents_paired_14_16 %>% 
  filter(SEX.par == "F") %>% 
  select(Offspring, Parent_ID)

(offspring_14_16_dam_sire <- offspring_14_16_dam %>% 
    full_join(offspring_14_16_sire, by = "Offspring", suffix = c(".dam", ".sire")))
```

## join back paired data to offspring, dam, and sire
```{r}
parents_paired_14_16_dam_sire <- offspring_14_16_dam_sire %>% 
  left_join(paired_14_16, by = c("Offspring" = "franz_id")) %>% 
  left_join(paired_14_16, by = c("Parent_ID.dam" = "franz_id"), suffix = c(".off", "")) %>% 
  left_join(paired_14_16, by = c("Parent_ID.sire" = "franz_id"), suffix = c(".dam", ".sire")) %>% 
  mutate(Julian.off = yday(`Sample Date.off`),
         Julian.dam = yday(`Sample Date.dam`),
         Julian.sire = yday(`Sample Date.sire`))
```

```{r}
offspring_both_parents <- parents_paired_14_16_dam_sire %>% 
  filter(!is.na(Parent_ID.dam) & !is.na(Parent_ID.sire)) %>% 
  pull(Offspring)

parents_paired_14_16 %>% 
  filter(Offspring %in% offspring_both_parents) %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Parent: Female",
                             SEX.par == "M" ~ "Parent: Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Offspring: Female",
                             SEX.off == "M" ~ "Offspring: Male")) %>% 
  group_by(sex.par, sex.off) %>% 
  summarise(correlation = round(cor(Julian.off, Julian.par), 3))

parents_paired_14_16 %>% 
  filter(Offspring %in% offspring_both_parents) %>% 
  mutate(sex.par = case_when(SEX.par == "F" ~ "Parent: Female",
                             SEX.par == "M" ~ "Parent: Male")) %>% 
  mutate(sex.off = case_when(SEX.off == "F" ~ "Offspring: Female",
                             SEX.off == "M" ~ "Offspring: Male")) %>% 
  ggplot(aes(x = Julian.par, y = Julian.off, colour = origin.par)) +
  geom_abline(slope = 1) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = "lm") +
  facet_grid(sex.off ~ sex.par) +
  labs(title = "Heritability of Sample Date",  colour = "Parent: Origin") +
  xlab("Parent Sample Date (Julian)") +
  ylab("Offspring Sample Date (Julian)") +
  theme_bw() +
  theme(text = element_text(size = 20))
```