---
title: "Stockdale 2013-2016 Results for Science Panel"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(coin)
library(MASS)
library(scales)
library(tidyverse)
library(lubridate)
# library(leaflet)
library(lubridate)
library(PBSmapping)
library(grid)
library(ggthemes) # Load

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, out.width = "100%", fig.width = 10)
```

# Introduction
This is a summary of parentage analysis and relative reproductive success (RRS) results from Stockdale Creek 2013-2016 for the Science Panel. Similar to the Hogan Bay results, the even year lineage had many more parentage assignments than the odd year lineage due to the higher sampling rates in 2014 compared to 2013 and the smaller escapements in 2014/2016 than in 2013/2015. While this does not mean that the odd lineage results are not valid, they are certainly less robust than the even lineage results. These results will be used to inform additional, future analyses  (e.g. investigating the impact of spawning location upstream/intertidal on reproductive success). We intend to present these results at both the March 7th AHRP Informational Meeting and at the Alaska Chapter of the American Fisheries Society meeting in Sitka March 19-22. Note that while the odd year Stockdale analyses were fully funded by the AHRP, the even year genetic analyses were funded by a Saltonstall-Kennedy grant which ends June 30, 2019.

# Odd lineage (2013/2015)

## Sample sizes
Below is a comparison of sample dates for genotyped individuals collected in 2013 and 2015. These plots allow us to examine differences in run timing between hatchery- and natural-origin fish in the parent generation (2013) and look for completeness of sampling throughout the run for both years. Note that only natural-origin individuals collected in 2015 were genotyped as potential offspring.  

From this histogram, we can see that in the parent generation (2013), natural-origin fish tended to have earlier sampling dates than hatchery-origin fish, which confirms what we know about differences in run timing. We can also see how sparse the field sampling was in 2013 compared to 2015. Offspring in 2015 were sampled throughout the run.

```{r odd_sample_sizes_plot}
paired_13_15_filter <- read_csv("stock_paired_13_15_filter.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery"))) %>% 
  mutate(Sex = case_when(SEX == "M" ~ "Male", SEX == "F" ~ "Female"))

paired_13_15_filter %>% 
  ggplot(aes(x = `Julian`)) +
  theme_bw() +
  geom_bar(aes(fill = origin), colour = "black") +
  facet_grid(`Sample Year` ~ .) +
  geom_hline(yintercept = 0, colour = "black") +
  ylab("Count") +
  xlab("Julian Date") +
  labs(title= "Number of Samples per Year\nby Date and Origin",
       fill = "Origin") +
  theme(text = element_text(size = 20))
```

Here are our sample sizes are for potential parents (2013) and potential offspring (2015) by sex and origin.

```{r odd_sample_sizes}
paired_13_15_filter %>% 
  count(`Sample Year`, Sex, origin) %>% 
  spread(origin, n, fill = 0)
```

Below are analyses of parentage results calculated separately for Odd (2013-2015) lineage using *FRANz*. 

## *FRANz* parameters
*FRANz* was run on February 12, 2019. We used the following parameters:
FRANz.exe --Nmmax 5659 --Nfmax 5659 --femrepro 1:2 --malerepro 1:2 --typingerror 0.006 --updatefreqs --poutformat 2 --fullsibtest "V:\Analysis\5_Coastwide\Multispecies\Alaska Hatchery Research Program\PWS Pink\Franz\stock_postQA_2013_2015_STOCK.dat"

The parameters are defined as follows:  
--Nmmax and --Nfmax are the maximum numbers of candidate mothers and fathers. To obtain our values, we used an estimated escapement of 11,318 and divided by 2. This escapement number came from the smaller of the two estimates (aerial survey AUC and stream walk AUC). This estimate is listed under 'pop est aerial' in the Excel file found here: "V:\Documents\5_Coastwide\Multispecies\AHRP\Field data\Sample Summary Extract and Genotype.xlsx"  
--femrepro and --malerepro specify the age range in which an individual can reproduce  
--typingerror refers to the overall genotyping error rate. Ours was ~0.006 (from QC)  
--updatefreqs specifies that *FRANz* should update allele frequencies using MCMC sampling  
--poutformat specifies that all potential parents should be listed, not just the most likely  
--fullsibtest tests for full siblings among offspring  

All output files can be found here: "V:\Analysis\5_Coastwide\Multispecies\Alaska Hatchery Research Program\PWS Pink\Franz\Stockdale\Odd_Run 2"  

The summary file provides information about the power of our marker suite:   
Cumulative exclusion probability when 1 to 7 fullsibs are genotyped  
  First Parent              : 1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000   
  Second Parent             : 1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000   
  Parent Pair               : 1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000
  
According to the *FRANz* manual, marker sets are not considered powerful if these cumulative exclusion probabilities are less than 0.95, which indicates that the probability that a random pair of individuals in the population has a 5% chance of having a genotype pair compatible to an offspring genotype. Since all of our probabilities are 1, we can be **confident** in the power of our 298 amplicons to make parent assignments. 

Below is a histogram of *FRANz* parentage posterior probabilities to show robustness of assignments
```{r FRANz_posterior_plot_odd}
parentage_13_15 <- read_csv("../../Franz/Stockdale/Odd_Run 2/parentage.csv")

parentage_13_15  %>% 
  filter(!is.na(`Parent 1`)) %>% 
  ggplot(aes(x = Posterior)) +
  geom_histogram(breaks = seq(0, 1, 0.01)) +
  ylab("Count") +
  xlab("Posterior Probability") +
  ggtitle("Histogram of FRANz posterior probabilities for parentage assignments")
```

All parentage assigments have a posterior probability of 1.00, which means that no offspring assignments were split among multiple potential parents. 

Of the 3,093 offspring collected in 2015, 72 were assigned to parents, for an overall offspring assignment rate of **2.3%**. This assignment rate is in line with expectations based on the sampling rate of the parent year escapement in 2013. All assignments were to one parent (*single parent-offspring duos*) - there were no two-parent assignments (*parent pair-offspring trios*).

## Proportion test
We used a Chi-Square test to determine whether the proportions of offspring assigned to hatchery- and natural-origin parents significantly differ from the proportions of hatchery- and natural-origin parents sampled. 

```{r Chi square test odd}
paired_13_15_filter_parents <- read_csv("stock_paired_13_15_filter_parents.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery"))) %>% 
  mutate(sex = case_when(SEX == "M" ~ "Male",
                         SEX == "F" ~ "Female"))

O.odd <- levels(paired_13_15_filter$origin)
Spawners.odd <- paired_13_15_filter %>% 
  filter(`Sample Year` == 2013) %>% 
  count(origin) %>% 
  pull(n) #  number of hatchery- and natural-origin parents
Offspring.odd <- paired_13_15_filter_parents %>% 
  group_by(origin) %>% 
  summarise(n = sum(n)) %>% 
  pull(n)  # number of offspring assigned to hatchery- and natural-origin parents

df.odd <- data.frame(Spawners.odd, Offspring.odd)  # made a data.frame because tibbles don't like rownames
row.names(df.odd) <- O.odd

df.odd
chisq.test(df.odd)
```

There is a significant difference in the proportions of offspring assigned to hatchery- and natural-origin parents relative to the proportions of potential parents sampled, indicating an under-representation of offspring assigning to hatchery-origin parents. We see that although **`r round(df.odd["H", "Spawners.odd"] / sum(df.odd[, "Spawners.odd"]), 2) * 100`%** of parents genotyped were of hatchery-origin, only **`r round(df.odd["H", "Offspring.odd"] / sum(df.odd[, "Offspring.odd"]), 2) * 100`%** of offspring assigned to hatchery-origin parents.

## Reproductive success
Here, we calculate and plot reproductive success (RS; number of offspring assigned to parents) for both natural- and hatchery-origin parents. The number of offspring assigned ranges from 0-4. 

### Calculate mean RS
We calculated the mean RS by origin and sex including sampled fish from the parental generation to which offspring were not assigned.

```{r calculate RS odd}
# Mean RS including 0's
rs_13_15_0 <- paired_13_15_filter_parents %>%
  group_by(origin, sex) %>% 
  summarise(RS = mean(n, na.rm = TRUE))

rs_13_15_0 %>%
  mutate(RS = round(RS, 2)) %>% 
  spread(sex, RS)
```

### Distribution of RS
```{r plot RS odd}
# Plot histogram of proportion of parents with a given family size
paired_13_15_filter_parents %>% 
  count(sex, origin, n) %>%
  group_by(sex, origin) %>% 
  mutate(p = nn / sum(nn)) %>% 
  ggplot(aes(x = n, y = p, fill = origin)) +
  theme_bw() +
  geom_col(position = position_dodge2(preserve="single"), width=0.8, colour = "black") +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(~ sex) +
  labs(title="Distribution of Reproductive Success",
       fill = "Parent\nOrigin") +
  xlab("Number of Offspring")+
  ylab("Proportion of Parents") +
  theme(text = element_text(size = 20))

# Save RS values
F_h_0_13_15 <- rs_13_15_0 %>% 
  filter(origin == "Hatchery" & sex == "Female") %>% 
  pull(RS)
M_h_0_13_15 <- rs_13_15_0 %>% 
  filter(origin == "Hatchery" & sex == "Male") %>% 
  pull(RS)
F_n_0_13_15 <- rs_13_15_0 %>% 
  filter(origin == "Natural" & sex == "Female") %>% 
  pull(RS)
M_n_0_13_15 <- rs_13_15_0 %>% 
  filter(origin == "Natural" & sex == "Male") %>% 
  pull(RS)
```

Most individuals were assigned 0 offspring. This doesn't mean that their fitness is necessarily 0 - rather, it means that we did not sample offspring that were assigned to them. We need to bear in mind that our RS estimates are based on the samples that we genotype. 

### Calculate and test RRS
```{r Calculate relative reproductive success including 0s odd}
Male_RRS_odd <- M_h_0_13_15/M_n_0_13_15
Female_RRS_odd <- F_h_0_13_15/F_n_0_13_15

# RRS_tibble_0_13_15 <- tibble(Male_RRS_odd, Female_RRS_odd)
# round(RRS_tibble_0_13_15, 2)
```

We calculate RRS as mean Hatchery RS divided by mean Natural RS. 

**RRS for females = `r round(Female_RRS_odd, 2)`**

**RRS for males = `r round(Male_RRS_odd, 2)`**

#### Statistical testing
We tested for statistically significant differences in RS between male and female hatchery- and natural-origin fish using two different statistical tests:  

  1. Nonparametric permutation test
  2. Parametric negative binomial GLM  
  
```{r RRS statistical testing including 0s odd}
# The format of the data to test was very simple, it was a data.frame called “mydata” with 2 columns
# 1.	nOff = number of offspring per family
# 2.	Origin = “H” or “W” for if the parent was hatchery or natural (wild)
# 
mydata_M_0 <- paired_13_15_filter_parents %>%
  filter(SEX == "M") 
  

mydata_F_0 <- paired_13_15_filter_parents %>%
  filter(SEX == "F")
  

perm_1tail_pvalue_M_0 <- round(x = as.numeric(coin::pvalue(oneway_test(n ~ origin, data = mydata_M_0, distribution = approximate(B = 10000), alternative = "greater"))), digits = 4)

perm_1tail_pvalue_F_0 <- round(x = as.numeric(coin::pvalue(oneway_test(n ~ origin, data = mydata_F_0, distribution = approximate(B = 10000), alternative = "greater"))), digits = 4)

#And to do a 1-tailed negative binomial GLM

fit_M_0 <- glm.nb(n ~ origin, data = mydata_M_0, init.theta = 1, link = log)
nbGLM_1tail_pvalue_M_0 <- round(summary(fit_M_0)$coefficients[2, 4], 4)

fit_F_0 <- glm.nb(n ~ origin, data = mydata_F_0, init.theta = 1, link = log)
nbGLM_1tail_pvalue_F_0 <- round(summary(fit_F_0)$coefficients[2, 4], 4)

RRS_0 <- tibble(Sex = c("Male", "Female", "Male", "Female"),
                Test = c(rep("Permutation", 2), rep("Negative Binomial GLM", 2)),
                p_value = c(perm_1tail_pvalue_M_0, perm_1tail_pvalue_F_0, nbGLM_1tail_pvalue_M_0, nbGLM_1tail_pvalue_F_0))
RRS_0 %>% 
  spread(Sex, p_value)  
```

The above table shows the *p-values* for each test and sex. We use a *p-value* cut-off of 0.05. Female hatchery-origin fish produced significantly fewer offspring than natural-origin females, but there is not a significant diference in RS between hatchery- and natural-origin males. 

#### Confidence intervals

We calculated 95% CI's for RRS based on [Kalinowski and Taper 2005](http://www.nrcresearchpress.com/doi/10.1139/f04-239). This is a maximum likelihood estimate based off of Hinrichsen 2003. This method has been used in other peer reviewed papers such as [Ford et al. 2016](https://www.researchgate.net/publication/309147116_Broodstock_History_Strongly_Influences_Natural_Spawning_Success_in_Hatchery_Steelhead_Oncorhynchus_mykiss#pf14).

```{r RRS_confidence_intervals_function}
rrs_ci_kalinowski <- function(n_h_off, n_w_off, n_h_par, n_w_par, alpha){
  chi_alpha <- qchisq(p = (1 - alpha), df = 1)
  n_off <- sum(c(n_h_off, n_w_off))
  n_par <- sum(c(n_h_par, n_w_par))
  
  rs_h <- n_h_off / n_h_par
  rs_w <- n_w_off / n_w_par
  
  p_h_par <- n_h_par / n_par
  p_w_par <- n_w_par / n_par
  
  rrs_h <- rs_h / rs_w
  rrs_w <- rs_w / rs_w
  rrs_avg <- (rrs_h * p_h_par) + (rrs_w * p_w_par)
  
  rrs_ml <- (n_h_off * log(p_h_par * rrs_h / rrs_avg)) + (n_w_off * log(p_w_par * rrs_w / rrs_avg))
  
  xi_dist <- bind_rows(
    lapply(seq(0.01, 5, by = 0.01), function(rrs_h_xi) {
      rrs_avg_xi <- (rrs_h_xi * p_h_par) + (rrs_w * p_w_par)
      tibble(rrs_crit = rrs_h_xi,
             logl = (n_h_off * log(p_h_par * rrs_h_xi / rrs_avg_xi)) + (n_w_off * log(p_w_par * rrs_w / rrs_avg_xi)) - (rrs_ml - chi_alpha / 2)
      )
    } )
  )
  
  rrs_min <- xi_dist %>% 
    mutate(abs_logl = abs(logl)) %>% 
    filter(rrs_crit < rrs_h) %>% 
    top_n(-1, abs_logl) %>% 
    pull(rrs_crit)
  
  rrs_max <- xi_dist %>% 
    mutate(abs_logl = abs(logl)) %>% 
    filter(rrs_crit > rrs_h) %>% 
    top_n(-1, abs_logl) %>% 
    pull(rrs_crit)
  
  xi_plot <- xi_dist %>% 
    ggplot(aes(x = rrs_crit, y = logl)) +
    geom_line() +
    geom_hline(yintercept = 0, colour = "red", lwd = 2) +
    geom_vline(xintercept = c(rrs_h, rrs_min, rrs_max), colour = "blue") +
    ylim(c(-5, 5)) +
    xlim(c(0, 2)) +
    ylab("Log Likelihood - Chi Sq Value") +
    annotate("text", x = rrs_h + 0.1, y = xi_dist %>% filter(rrs_crit == xi_dist$rrs_crit[which.min(abs(xi_dist$rrs_crit  - rrs_h))]) %>% pull(logl) + 0.4, label = round(rrs_h, 2)) +
    annotate("text", x = rrs_min - 0.1, y = xi_dist %>% filter(rrs_crit == rrs_min) %>% pull(logl) + 0.4, label = rrs_min) +
    annotate("text", x = rrs_max + 0.1, y = xi_dist %>% filter(rrs_crit == rrs_max) %>% pull(logl) + 0.4, label = rrs_max)
  
  # print(xi_plot)  # hide this for Science Panel notebook
  return(round(c(rrs_min, rrs_h, rrs_max), 2))
}
```

```{r RRS_confidence_intervals_13_15}
odd_female_rrs_CI <- rrs_ci_kalinowski(n_h_off = paired_13_15_filter_parents %>% 
                                         filter(SEX == "F", origin == "Hatchery") %>% 
                                         group_by(SEX, origin) %>% 
                                         summarise(n_off = sum(n)) %>% 
                                         pull(n_off),
                                       n_w_off = paired_13_15_filter_parents %>% 
                                         filter(SEX == "F", origin == "Natural") %>% 
                                         group_by(SEX, origin) %>% 
                                         summarise(n_off = sum(n)) %>% 
                                         pull(n_off), 
                                       n_h_par = paired_13_15_filter_parents %>% 
                                         filter(SEX == "F", origin == "Hatchery") %>% 
                                         count(SEX, origin) %>% 
                                         pull(nn), 
                                       n_w_par = paired_13_15_filter_parents %>% 
                                         filter(SEX == "F", origin == "Natural") %>% 
                                         count(SEX, origin) %>% 
                                         pull(nn),
                                       alpha = 0.05)

odd_male_rrs_CI <- rrs_ci_kalinowski(n_h_off = paired_13_15_filter_parents %>% 
                                       filter(SEX == "M", origin == "Hatchery") %>% 
                                       group_by(SEX, origin) %>% 
                                       summarise(n_off = sum(n)) %>% 
                                       pull(n_off),
                                     n_w_off = paired_13_15_filter_parents %>% 
                                       filter(SEX == "M", origin == "Natural") %>% 
                                       group_by(SEX, origin) %>% 
                                       summarise(n_off = sum(n)) %>% 
                                       pull(n_off), 
                                     n_h_par = paired_13_15_filter_parents %>% 
                                       filter(SEX == "M", origin == "Hatchery") %>% 
                                       count(SEX, origin) %>% 
                                       pull(nn), 
                                     n_w_par = paired_13_15_filter_parents %>% 
                                       filter(SEX == "M", origin == "Natural") %>% 
                                       count(SEX, origin) %>% 
                                       pull(nn),
                                     alpha = 0.05)
```

Stockdale 2013/2015 **female** RRS with 95% CI = **`r paste0(formatC(odd_female_rrs_CI[2], format = "f", digits = 2), " (", formatC(odd_female_rrs_CI[1], format = "f", digits = 2), "-", formatC(odd_female_rrs_CI[3], format = "f", digits = 2), ")")`**

Stockdale 2013/2015 **male** RRS with 95% CI = **`r paste0(formatC(odd_male_rrs_CI[2], format = "f", digits = 2), " (", formatC(odd_male_rrs_CI[1], format = "f", digits = 2), "-", formatC(odd_male_rrs_CI[3], format = "f", digits = 2), ")")`**

**Note** that the confidence intervals for both males and females are large due to the small numbers of offspring assigned to hatchery-origin parents. 

### Plots of RS vs. field data
We examined associations between two potential explanatory variables (sample date and body size) and RS. These plots include LOESS (locally weighted smoothing) lines with 95% confidence intervals to help illustrate trends. We use LOESS rather than linear models because our data violate assumptions of linear regression (normality, homoscedasticity, etc.). 

```{r Examine reproductive success by sample date odd with zeros}
paired_13_15_filter_parents %>%
  ggplot(aes(x = `Sample Date`, y = n, color = origin)) +
  geom_jitter(height = 0, size = 2) +
  geom_smooth() +
  facet_grid(sex ~ .)+
  labs(title = "Reproductive Success by Parent Sample Date",  colour = "Parent\nOrigin",
       shape = "Parent: Sex") +
  xlab("Parent Sample Date") +
  ylab("Number of Offspring") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

The above plot show RS by parent sample date, separately for females (top) and males (bottom). We see that there were no hatchery-origin fish sampled in the first event. RS appears to be higher early in the season than later on, and this pattern is more pronounced in males than in females. Note that points are jittered by sample date (x-axis) to avoid overplotting. 

```{r Examine reproductive success by parent length odd with zeros}
paired_13_15_filter_parents %>% 
  ggplot(aes(x = `Length Mm`, y = n, color = origin)) +
  geom_jitter(height = 0, size = 2) +
  geom_smooth() +
  facet_grid(sex ~ .) +
  labs(title = "Reproductive Success by Parent Length",  colour = "Parent\nOrigin",
       shape = "Parent: Sex") +
  xlab("Parental Length (mm)") +
  ylab("Number of Offspring") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

The above plot show RS by parent body length, separately for females (top) and males (bottom). Sample sizes are small, particularly for hatchery-origin parents, which makes it difficult to visualize relationships and draw robust conclusions. 

## Summary of odd lineage results
1. Exclusion probabilities were equal to 1.00, which means we can be confident in the ability of our marker set to correctly assign parents to offspring. 
2. 72 offspring were assigned to 54 parents (3 of which were hatchery-origin), for an assignment rate of **2.3%**. This assignment rate is similar to what was observed for Hogan 2013/2015 (huge parent escapement in 2013 relative to sampling rate) and in line with expectations based on the sampling rate of the parent year escapement in 2013. 
3. Given the small sample size of parent-offspring relationships for the odd lineage, these results should be considered valid, but not particularly robust. 
4. The number of offspring assigned to parents varied from 0-2 for females and 0-4 for males. 
5. RRS for females = 0.13 (0.01-0.59). RRS for males = 0.34 (0.05-1.10). Hatchery-origin females produce significantly fewer offspring than natural-origin females, but there is not a statistically significant difference for males. 


# Even lineage (2014/2016)

## Sample sizes
Below is a comparison of sample dates for genotyped individuals collected in 2014 and 2016. These plots allow us to examine differences in run timing between hatchery- and natural-origin fish in the parent generation (2014) and look for completeness of sampling throughout the run for both years. Note that only natural-origin individuals collected in 2016 were genotyped as potential offspring.  

From this histogram, we can see that in the parent generation (2014), natural-origin fish tended to have earlier sampling dates than hatchery-origin fish, which confirms what we know about differences in run timing. We can also see that field sampling in 2014 was more robust than 2013 (more stream visits). Offspring in 2016 were sampled throughout the run.

```{r even_sample_sizes_plot}
paired_14_16_filter <- read_csv("stock_paired_14_16_filter.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery"))) %>% 
  mutate(Sex = case_when(SEX == "M" ~ "Male", SEX == "F" ~ "Female"))

paired_14_16_filter %>% 
  ggplot(aes(x = `Julian`)) +
  theme_bw() +
  geom_bar(aes(fill = origin), colour = "black") +
  facet_grid(`Sample Year` ~ .) +
  geom_hline(yintercept = 0, colour = "black") +
  ylab("Count") +
  xlab("Julian Date") +
  labs(title= "Number of Samples per Year\nby Date and Origin",
       fill = "Origin") +
  theme(text = element_text(size = 20))
```

Here are our sample sizes are for potential parents (2014) and potential offspring (2016) by sex and origin.

```{r even_sample_sizes}
paired_14_16_filter %>% 
  count(`Sample Year`, Sex, origin) %>% 
  spread(origin, n, fill = 0)
```

Below are analyses of parentage results calculated separately for Even (2014-2016) lineage using *FRANz*. 

## *FRANz* parameters
*FRANz* was run on February 13, 2019. We used the following parameters:
FRANz.exe --Nmmax 2019 --Nfmax 2019 --femrepro 1:2 --malerepro 1:2 --typingerror 0.006 --updatefreqs --poutformat 2 --fullsibtest "V:\Analysis\5_Coastwide\Multispecies\Alaska Hatchery Research Program\PWS Pink\Franz\stock_postQA_2014_2016_STOCK.dat"

The parameters are defined as follows:  
--Nmmax and --Nfmax are the maximum numbers of candidate mothers and fathers. To obtain our values, we used an estimated escapement of 4,038 and divided by 2. This escapement number came from the smaller of the two estimates (aerial survey AUC and stream walk AUC). This estimate is listed under 'pop est aerial' in the Excel file found here: "V:\Documents\5_Coastwide\Multispecies\AHRP\Field data\Sample Summary Extract and Genotype.xlsx"  
--femrepro and --malerepro specify the age range in which an individual can reproduce  
--typingerror refers to the overall genotyping error rate. Ours was ~0.006 (from QC)  
--updatefreqs specifies that *FRANz* should update allele frequencies using MCMC sampling  
--poutformat specifies that all potential parents should be listed, not just the most likely  
--fullsibtest tests for full siblings among offspring  

All output files can be found here: "V:\Analysis\5_Coastwide\Multispecies\Alaska Hatchery Research Program\PWS Pink\Franz\Stockdale\Even_Run 2"  

The summary file provides information about the power of our marker suite:   
Cumulative exclusion probability when 1 to 7 fullsibs are genotyped  
  First Parent              : 1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000   
  Second Parent             : 1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000   
  Parent Pair               : 1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000  1.0000000
  
According to the FRANz manual, marker sets are not considered powerful if these cumulative exclusion probabilities are less than 0.95, which indicates that the probability that a random pair of individuals in the population has a 5% chance of having a genotype pair compatible to an offspring genotype. Since all of our probabilities are 1, we can be **confident** in the power of our 298 amplicons to make parent assignments. 

Below is a histogram of *FRANz* parentage posterior probabilities to show robustness of assignments
```{r FRANz_posterior_plot_even}
parentage_14_16 <- read_csv("../../Franz/Stockdale/Even_Run 2/parentage.csv")

parentage_14_16  %>% 
  filter(!is.na(`Parent 1`)) %>% 
  ggplot(aes(x = Posterior)) +
  geom_histogram(breaks = seq(0, 1, 0.01)) +
  ylab("Count") +
  xlab("Posterior Probability") +
  ggtitle("Histogram of FRANz posterior probabilities for parentage assignments")
```

Almost all parentage assigments have a posterior probability of 1.00, which means that very few offspring assignments were split among multiple potential parents. Note that we used a cutoff of 0.90 for including parent-offspring assignments in downstream analyses.

Of the 5,199 offspring collected in 2016, 1,054 were assigned to parents, for an overall offspring assignment rate of **20.3%**. This is in line with expectations based on the sampling rate of the parent year escapement in 2014.

While most of the assignments were to one parent (*single parent-offspring duos*), there were 183 two-parent assignments (*parent pair-offspring trios*).

## Proportion test
We used a Chi-Square test to determine whether the proportions of offspring assigned to hatchery- and natural-origin parents significantly differ from the proportions of hatchery- and natural-origin parents sampled. 

```{r Chi square test even}
paired_14_16_filter_parents <- read_csv("stock_paired_14_16_filter_parents.csv") %>% 
  mutate(origin = factor(x = origin, levels = c("Natural", "Hatchery"))) %>% 
  mutate(sex = case_when(SEX == "M" ~ "Male",
                         SEX == "F" ~ "Female"))

O.even <- levels(paired_14_16_filter$origin)
Spawners.even <- paired_14_16_filter %>% 
  filter(`Sample Year` == 2014) %>% 
  count(origin) %>% 
  pull(n) #  number of hatchery- and natural-origin parents
Offspring.even <- paired_14_16_filter_parents %>% 
  group_by(origin) %>% 
  summarise(n = sum(n)) %>% 
  pull(n)  # number of offspring assigned to hatchery- and natural-origin parents

df.even <- data.frame(Spawners.even, Offspring.even)  # made a data.frame because tibbles don't like rownames
row.names(df.even) <- O.even

df.even
chisq.test(df.even)
```

There is a significant difference in the proportions of offspring assigned to hatchery- and natural-origin parents relative to the proportions of potential parents sampled, indicating an under-representation of offspring assigning to hatchery-origin parents. We see that although **`r round(df.even["H", "Spawners.even"] / sum(df.even[, "Spawners.even"]), 2) * 100`%** of parents genotyped were of hatchery-origin, only **`r round(df.even["H", "Offspring.even"] / sum(df.even[, "Offspring.even"]), 2) * 100`%** of offspring assigned to hatchery-origin parents.

## Reproductive success
Here, we calculate and plot reproductive success (RS; number of offspring assigned to parents) for both natural and hatchery parents. The number of offspring assigned ranges from 0-19. 

### Calculate mean RS
We'll calculate the mean RS by origin and sex including sampled fish from the parental generation to which offspring were not assigned.

```{r calculate RS even}
# Mean RS including 0's
rs_14_16_0 <- paired_14_16_filter_parents %>%
  group_by(origin, sex) %>% 
  summarise(RS = mean(n, na.rm = TRUE))

rs_14_16_0 %>%
  mutate(RS = round(RS, 2)) %>% 
  spread(sex, RS)
```

### Distribution of RS
```{r plot RS even}
# Plot histogram of proportion of parents with a given family size
paired_14_16_filter_parents %>% 
  count(sex, origin, n) %>%
  group_by(sex, origin) %>% 
  mutate(p = nn / sum(nn)) %>% 
  ggplot(aes(x = n, y = p, fill = origin)) +
  theme_bw() +
  geom_col(position = position_dodge2(preserve="single"), width=0.8, colour = "black") +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = pretty_breaks()) +
  facet_grid(~ sex) +
  labs(title="Distribution of Reproductive Success",
       fill = "Parent\nOrigin") +
  xlab("Number of Offspring")+
  ylab("Proportion of Parents") +
  theme(text = element_text(size = 20))

# Save RS values
F_h_0_14_16 <- rs_14_16_0 %>% 
  filter(origin == "Hatchery" & sex == "Female") %>% 
  pull(RS)
M_h_0_14_16 <- rs_14_16_0 %>% 
  filter(origin == "Hatchery" & sex == "Male") %>% 
  pull(RS)
F_n_0_14_16 <- rs_14_16_0 %>% 
  filter(origin == "Natural" & sex == "Female") %>% 
  pull(RS)
M_n_0_14_16 <- rs_14_16_0 %>% 
  filter(origin == "Natural" & sex == "Male") %>% 
  pull(RS)
```

Note the big difference in the numbers of parents assigned 0 offspring. For both females and males, far more hatchery-origin fish were not assigned offspring as compared to natural-origin fish. Also note the differences in the shapes of distributions for natural- and hatchery-origin parents. 

### Calculate and test RRS
```{r Calculate relative reproductive success including 0s even}
Male_RRS_even <- M_h_0_14_16/M_n_0_14_16
Female_RRS_even <- F_h_0_14_16/F_n_0_14_16

# RRS_tibble_0_14_16 <- tibble(Male_RRS_even, Female_RRS_even)
# round(RRS_tibble_0_14_16, 2)
```

We calculate RRS as mean Hatchery RS divided by mean Natural RS. 

**RRS for females = `r round(Female_RRS_even, 2)`**

**RRS for males = `r round(Male_RRS_even, 2)`**

#### Statistical testing
We tested for significant differences in RS between male and female hatchery- and natural-origin fish using two different statistical tests:  

  1. Nonparametric permutation test
  2. Parametric negative binomial GLM  
  
```{r RRS statistical testing including 0s even}
# The format of the data to test was very simple, it was a data.frame called “mydata” with 2 columns
# 1.	nOff = number of offspring per family
# 2.	Origin = “H” or “W” for if the parent was hatchery or natural (wild)
# 
mydata_M_0 <- paired_14_16_filter_parents %>%
  filter(SEX == "M") 
  

mydata_F_0 <- paired_14_16_filter_parents %>%
  filter(SEX == "F")
  

perm_1tail_pvalue_M_0 <- as.numeric(coin::pvalue(oneway_test(n ~ origin, data = mydata_M_0, distribution = approximate(B = 10000), alternative = "greater")))

perm_1tail_pvalue_F_0 <- as.numeric(coin::pvalue(oneway_test(n ~ origin, data = mydata_F_0, distribution = approximate(B = 10000), alternative = "greater")))

#And to do a 1-tailed negative binomial GLM

fit_M_0 <- glm.nb(n ~ origin, data = mydata_M_0, init.theta = 1, link = log)
nbGLM_1tail_pvalue_M_0 <- summary(fit_M_0)$coefficients[2, 4]

fit_F_0 <- glm.nb(n ~ origin, data = mydata_F_0, init.theta = 1, link = log)
nbGLM_1tail_pvalue_F_0 <- summary(fit_F_0)$coefficients[2, 4]

RRS_0 <- tibble(Sex = c("Male", "Female", "Male", "Female"),
                Test = c(rep("Permutation", 2), rep("Negative Binomial GLM", 2)),
                p_value = c(perm_1tail_pvalue_M_0, perm_1tail_pvalue_F_0, nbGLM_1tail_pvalue_M_0, nbGLM_1tail_pvalue_F_0))
RRS_0 %>% 
  spread(Sex, p_value)  
```

The above table shows the *p-values* for each test and sex, which are all below 0.001. Both male and female hatchery-origin fish produced fewer offspring than their natural-origin counterparts. 

#### Confidence intervals

We will calculate 95% CI's for RRS based on [Kalinowski and Taper 2005](http://www.nrcresearchpress.com/doi/10.1139/f04-239). This is a maximum likelihood estimate based off of Hinrichsen 2003. This method has been used in other peer reviewed papers such as [Ford et al. 2016](https://www.researchgate.net/publication/309147116_Broodstock_History_Strongly_Influences_Natural_Spawning_Success_in_Hatchery_Steelhead_Oncorhynchus_mykiss#pf14).

```{r RRS_confidence_intervals_14_16}
even_female_rrs_CI <- rrs_ci_kalinowski(n_h_off = paired_14_16_filter_parents %>% 
                                         filter(SEX == "F", origin == "Hatchery") %>% 
                                         group_by(SEX, origin) %>% 
                                         summarise(n_off = sum(n)) %>% 
                                         pull(n_off),
                                       n_w_off = paired_14_16_filter_parents %>% 
                                         filter(SEX == "F", origin == "Natural") %>% 
                                         group_by(SEX, origin) %>% 
                                         summarise(n_off = sum(n)) %>% 
                                         pull(n_off), 
                                       n_h_par = paired_14_16_filter_parents %>% 
                                         filter(SEX == "F", origin == "Hatchery") %>% 
                                         count(SEX, origin) %>% 
                                         pull(nn), 
                                       n_w_par = paired_14_16_filter_parents %>% 
                                         filter(SEX == "F", origin == "Natural") %>% 
                                         count(SEX, origin) %>% 
                                         pull(nn),
                                       alpha = 0.05)

even_male_rrs_CI <- rrs_ci_kalinowski(n_h_off = paired_14_16_filter_parents %>% 
                                       filter(SEX == "M", origin == "Hatchery") %>% 
                                       group_by(SEX, origin) %>% 
                                       summarise(n_off = sum(n)) %>% 
                                       pull(n_off),
                                     n_w_off = paired_14_16_filter_parents %>% 
                                       filter(SEX == "M", origin == "Natural") %>% 
                                       group_by(SEX, origin) %>% 
                                       summarise(n_off = sum(n)) %>% 
                                       pull(n_off), 
                                     n_h_par = paired_14_16_filter_parents %>% 
                                       filter(SEX == "M", origin == "Hatchery") %>% 
                                       count(SEX, origin) %>% 
                                       pull(nn), 
                                     n_w_par = paired_14_16_filter_parents %>% 
                                       filter(SEX == "M", origin == "Natural") %>% 
                                       count(SEX, origin) %>% 
                                       pull(nn),
                                     alpha = 0.05)
```

Stockdale 2014/2016 **female** RRS with 95% CI = **`r paste0(formatC(even_female_rrs_CI[2], format = "f", digits = 2), " (", formatC(even_female_rrs_CI[1], format = "f", digits = 2), "-", formatC(even_female_rrs_CI[3], format = "f", digits = 2), ")")`**

Stockdale 2014/2016 **male** RRS with 95% CI = **`r paste0(formatC(even_male_rrs_CI[2], format = "f", digits = 2), " (", formatC(even_male_rrs_CI[1], format = "f", digits = 2), "-", formatC(even_male_rrs_CI[3], format = "f", digits = 2), ")")`**

**Note** that the confidence intervals for both males and females are much smaller than in the odd lineage due to much higher number of parent-offpsring assignments (more data = smaller confidence intervals). 

### Plots of RS vs. field data
As in the odd lineage above, we examined associations between two potential explanatory variables (sample date and body size) and RS. Since we have many more offspring assignments, we can more clearly visualize these relationships. These plots include LOESS lines with 95% confidence intervals to help illustrate trends. As in the odd lineage, we use LOESS to visualize relationshiops rather than linear models because our data violate assumptions of linear regression. 

```{r Examine reproductive success by sample date even with zeros}
paired_14_16_filter_parents %>%
  ggplot(aes(x = `Sample Date`, y = n, color = origin)) +
  geom_jitter(height = 0, size = 2) +
  geom_smooth() +
  facet_grid(sex ~ .)+
  labs(title = "Reproductive Success by Parent Sample Date",  colour = "Parent\nOrigin",
       shape = "Parent: Sex") +
  xlab("Parent Sample Date") +
  ylab("Number of Offspring") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

The above plot shows RS by parent sample date, separately for females (top) and males (bottom). We see that RS does vary due to sample date. For natural-origin fish, the lowest RS values are in the middle of the season (perhaps due to density dependence on the spawning grounds). For hatchery-origin fish, there is less of a relationship between RS and sample date. However, it appears that hatchery-origin RS is slightly higher in the middle of the season. Regardless, both early and late in the season natural-origin fish have higher RS than hatchery-origin fish in both sexes. This suggests that our measured difference in RRS is not due solely to differences in run timing (sample date) between hatchery- and natural-origin fish. Note that points are jittered by sample date (x-axis) to avoid overplotting.

```{r Examine reproductive success by parent length even with zeros}
paired_14_16_filter_parents %>% 
  filter(`Length Mm` > 300) %>%  # remove outlier
  ggplot(aes(x = `Length Mm`, y = n, color = origin)) +
  geom_jitter(height = 0, size = 2) +
  geom_smooth() +
  facet_grid(sex ~ .) +
  labs(title = "Reproductive Success by Parent Length",  colour = "Parent\nOrigin",
       shape = "Parent: Sex") +
  xlab("Parental Length (mm)") +
  ylab("Number of Offspring") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

The above plot show RS by parent body length, separately for females (top) and males (bottom). Larger males are more successful (but only natural-origin males). Again, we see at most size classes that natural-origin fish have higher RS than hatchery-origin fish. Size alone, therefore, doesn't explain differences in RS.

## Parent pair-offspring trios
Because we have 183 individuals who were assigned to 115 different sets of two parent matings (families), we are able to examine instances of crosses between hatchery fish, between natural fish, and between natural and hatchery fish. **Note** that we have divided natural-hatchery crosses into "HN", which indicates a hatchery-origin dam and natural-origin sire and "NH", which indicates a natural-origin dam and hatchery-origin sire. 

### Sample sizes
These are our sample sizes for the number of families by cross type.

```{r even_cross_type}
parents_paired_14_16_cross <- read_csv("stock_parents_paired_14_16_cross.csv") %>% 
  mutate(cross = factor(cross, c("NN", "NH", "HN", "HH")))

parents_paired_14_16_cross %>% 
  mutate(`Cross Type` = cross) %>% 
  count(`Cross Type`, `Fish ID`, `Fish ID.par1`) %>% 
  count(`Cross Type`) %>% 
  rename(`Number of Families` = nn)
```

### Distribution of RS

```{r Create cross as new grouping variable even}
parents_paired_14_16_cross %>% 
  count(cross, `Fish ID`, `Fish ID.par1`) %>% 
  count(cross, n) %>% 
  complete(cross, n, fill = list(nn = 0)) %>% 
  group_by(cross) %>% 
  mutate(p = nn / sum(nn)) %>% 
  ggplot(aes(x = n, y = p, fill = cross))+
  geom_col(position = position_dodge2(preserve = "single"), width = 0.5) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = 1:5) +
  # ylim(0, 40) +
  # xlim(0, 5) +
  labs(title = "Distribution of Reproductive Success by Cross Type",
       fill = "Cross Type") +
  xlab("Number of Offspring")+
  ylab("Proportion of Families") +
  theme_bw() +
  theme(text = element_text(size = 20))
```

Offspring from all four types of crosses are represented in our dataset. HH crosses produced 1-2 offspring, HN crosses produced 1-5 offspring, NH crosses produced 1-3 offspring, and NN crosses produced 1-5 offspring. Note that analyses of trios do not include matings with RS = 0 because it is not possible for us to collect this information (we only know a mating between two fish ocurred if we assign offspring to those two fish). 

### Calculate mean RS
Here we calculated the mean RS for each cross type. Note that NN families have the highest RS, HH families have the lowest RS, and hybrids have intermediate RS.
```{r cross_rs_even}
parents_paired_14_16_cross %>% 
  mutate(`Cross Type` = cross) %>% 
  count(`Cross Type`, `Fish ID`, `Fish ID.par1`) %>% 
  group_by(`Cross Type`) %>% 
  summarise(`Average RS` = round(mean(n), digits = 2))  
```

### Calculate and test RRS

We calculate RRS as the mean RS of one cross type divided by the mean RS of another cross type (i.e. HH/NN). 

#### Confidence intervals

```{r RRS_confidence_intervals_cross_14_16}
even_HH_NN_rrs_CI <- rrs_ci_kalinowski(n_h_off = parents_paired_14_16_cross %>% 
                                         filter(cross == "HH") %>% 
                                         count(cross) %>% 
                                         pull(n),
                                       n_w_off = parents_paired_14_16_cross %>% 
                                         filter(cross == "NN") %>% 
                                         count(cross) %>% 
                                         pull(n), 
                                       n_h_par = parents_paired_14_16_cross %>% 
                                         filter(cross == "HH") %>% 
                                         count(cross, `Fish ID`, `Fish ID.par1`) %>% 
                                         count(cross) %>% 
                                         pull(nn), 
                                       n_w_par = parents_paired_14_16_cross %>% 
                                         filter(cross == "NN") %>% 
                                         count(cross, `Fish ID`, `Fish ID.par1`) %>% 
                                         count(cross) %>% 
                                         pull(nn),
                                       alpha = 0.05)

even_HN_NN_rrs_CI <- rrs_ci_kalinowski(n_h_off = parents_paired_14_16_cross %>% 
                                         filter(cross == "HN") %>% 
                                         count(cross) %>% 
                                         pull(n),
                                       n_w_off = parents_paired_14_16_cross %>% 
                                         filter(cross == "NN") %>% 
                                         count(cross) %>% 
                                         pull(n), 
                                       n_h_par = parents_paired_14_16_cross %>% 
                                         filter(cross == "HN") %>% 
                                         count(cross, `Fish ID`, `Fish ID.par1`) %>% 
                                         count(cross) %>% 
                                         pull(nn), 
                                       n_w_par = parents_paired_14_16_cross %>% 
                                         filter(cross == "NN") %>% 
                                         count(cross, `Fish ID`, `Fish ID.par1`) %>% 
                                         count(cross) %>% 
                                         pull(nn),
                                       alpha = 0.05)

even_NH_NN_rrs_CI <- rrs_ci_kalinowski(n_h_off = parents_paired_14_16_cross %>% 
                                         filter(cross == "NH") %>% 
                                         count(cross) %>% 
                                         pull(n),
                                       n_w_off = parents_paired_14_16_cross %>% 
                                         filter(cross == "NN") %>% 
                                         count(cross) %>% 
                                         pull(n), 
                                       n_h_par = parents_paired_14_16_cross %>% 
                                         filter(cross == "NH") %>% 
                                         count(cross, `Fish ID`, `Fish ID.par1`) %>% 
                                         count(cross) %>% 
                                         pull(nn), 
                                       n_w_par = parents_paired_14_16_cross %>% 
                                         filter(cross == "NN") %>% 
                                         count(cross, `Fish ID`, `Fish ID.par1`) %>% 
                                         count(cross) %>% 
                                         pull(nn),
                                       alpha = 0.05)
```

Stockdale 2014/2016 **HH/NN** RRS with 95% CI = **`r paste0(formatC(even_HH_NN_rrs_CI[2], format = "f", digits = 2), " (", formatC(even_HH_NN_rrs_CI[1], format = "f", digits = 2), "-", formatC(even_HH_NN_rrs_CI[3], format = "f", digits = 2), ")")`**

Stockdale 2014/2016 **HN/NN** RRS with 95% CI = **`r paste0(formatC(even_HN_NN_rrs_CI[2], format = "f", digits = 2), " (", formatC(even_HN_NN_rrs_CI[1], format = "f", digits = 2), "-", formatC(even_HN_NN_rrs_CI[3], format = "f", digits = 2), ")")`**

Stockdale 2014/2016 **NH/NN** RRS with 95% CI = **`r paste0(formatC(even_NH_NN_rrs_CI[2], format = "f", digits = 2), " (", formatC(even_NH_NN_rrs_CI[1], format = "f", digits = 2), "-", formatC(even_NH_NN_rrs_CI[3], format = "f", digits = 2), ")")`**

The only significant difference in RRS (upper bound of 95% CI < 1.00) is between HH and NN matings.

## Summary of even lineage results
1. Most exclusion probabilities were equal to 1.00, which means we can be confident in the ability of our marker set to correctly assign parents to offspring. 
2. 1,059 offspring were assigned to 405 parents, for an assignment rate of **20.3%**. 
3. Given the larger sample size of parent-offspring relationships, the even lineage results are much more robust than the odd lineage results.
4. The number of offspring assigned to parents varied from 0-12 for females and 0-19 for males. 
5. RRS was significant for both males (0.28 [CI's 0.24-0.34]) and females (0.42 [CI's 0.35-0.50]). 
6. RS for natural-origin fish significantly varied with parent sample date (early fish had the highest RS, middle fish had the lowest RS, late returning fish had intermediate RS). Across most of the season (particularly the tails), regardless of sample date, natural-origin fish had higher RS than hatchery-origin fish. Differences in overall RRS do not appear to be solely due to differences in run timing.
7. Large natural-origin males had significantly higher RS than smaller ones, but this pattern was not present for hatchery-origin males or females from either origin. However, regardless of size, natural-origin fish had higher RS than hatchery-origin fish.
8. 183 offspring assigned to two parents (trios).
9. RRS was significantly different for HH vs. NN crosses (0.61 [CI's 0.35-0.99]). There was no significant difference between RRS of either hybrid type (HN or NH) versus NN. 
10. Hybrids (HN and NH) had RS values that were intermediate between HH and NN crosses.
